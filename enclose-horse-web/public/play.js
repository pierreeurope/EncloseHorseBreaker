function gt(s,e,t,n,o,i,a){let l=n.filter(y=>y).length,r=new Map;if(a)for(let y=0;y<a.length;y++){let b=a[y];b!==null&&(r.has(b)||r.set(b,[]),r.get(b).push(y))}let h=[i],u=new Set([i]),d=new Map,c=new Map([[i,0]]),p=!1,g=-1,m=0,f=[[-1,0],[1,0],[0,-1],[0,1]],v=(y,b)=>{if(!u.has(y)&&!n[y]&&t[y]!==1){u.add(y),d.set(y,b);let T=c.get(b)+1;c.set(y,T),m=Math.max(m,T),h.push(y)}};for(;h.length>0;){let y=h.shift(),b=y%s,T=Math.floor(y/s);(b===0||b===s-1||T===0||T===e-1)&&(p||(p=!0,g=y));for(let[A,C]of f){let R=b+A,L=T+C;if(R>=0&&R<s&&L>=0&&L<e){let k=L*s+R;v(k,y)}}if(a){let A=a[y];if(A!==null){let C=r.get(A)||[];for(let R of C)R!==y&&v(R,y)}}}let E=[];if(p&&g!==-1){let y=g;for(;y!==void 0;)E.unshift(y),y=d.get(y)}let x=0;if(!p&&o)for(let y of u)o[y]&&(x+=3);let w=p?0:u.size;return{wallCount:l,enclosedArea:w,cherryBonus:x,totalScore:w+x,visited:u,escaped:p,escapePath:E,distance:c,maxDistance:m}}var ln="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function rn(s,e){let t="";for(let n of s){let o=ln.indexOf(n);t+=o.toString(2).padStart(6,"0")}return t.split("").slice(0,e).map(n=>parseInt(n))}function Yt(s,e){return rn(s,e).map(t=>t===1)}function hn(s){return s<10?String.fromCharCode(48+s):String.fromCharCode(97+s-10)}function cn(s){return s>="0"&&s<="9"?s.charCodeAt(0)-48:s>="a"&&s<="z"?s.charCodeAt(0)-97+10:null}function jt(s){let e=[];for(let t=0;t<s.rows;t++){let n="";for(let o=0;o<s.cols;o++){let i=t*s.cols+o;i===s.playerIdx?n+="H":s.cherries?.[i]?n+="C":s.walls[i]?n+="W":s.terrain[i]===1?n+="~":s.portals?.[i]!==null&&s.portals?.[i]!==void 0?n+=hn(s.portals[i]):n+="."}e.push(n)}return e.join(`
`)}function Ut(s,e){let t=s.trim().split(`
`),n=t.length,o=t[0].length,i=[],a=[],l=[],r=[],h=-1;for(let u=0;u<n;u++){let d=t[u];for(let c=0;c<o;c++){let p=u*o+c,g=d[c]||".",m=cn(g);g==="H"?(h=p,i.push(0),a.push(!1),l.push(!1),r.push(null)):g==="C"?(i.push(0),a.push(!1),l.push(!0),r.push(null)):g==="W"?(i.push(0),a.push(!0),l.push(!1),r.push(null)):g==="~"?(i.push(1),a.push(!1),l.push(!1),r.push(null)):m!==null?(i.push(0),a.push(!1),l.push(!1),r.push(m)):(i.push(0),a.push(!1),l.push(!1),r.push(null))}}if(h===-1)throw new Error("Map must contain exactly one horse (H)");return{cols:o,rows:n,terrain:i,walls:a,cherries:l,portals:r,playerIdx:h,budget:e}}var dn=333.3333333333333,Ve=!0;if(typeof localStorage<"u"){let s=localStorage.getItem("enclose_animations");s!==null&&(Ve=s!=="false")}function Xt(){return Ve}function Vt(s){Ve=s,typeof localStorage<"u"&&localStorage.setItem("enclose_animations",String(s))}function H(){return Ve?Math.floor(performance.now()/dn):0}function W(s){let e=H(),t=Math.sin(s*9999+e*7777)*1e4;return t-Math.floor(t)-.5}var B={GRASS_BLANK:0,GRASS_ANIM:1,WATER_BLANK:2,WATER_ANIM:3,WATER_EDGE_LEFT_1:4,WATER_EDGE_LEFT_2:5,WATER_EDGE_TOP_1:6,WATER_EDGE_TOP_2:7,WATER_EDGE_BOTTOM:8,WATER_EDGE_TL_CORN:9,WATER_EDGE_BL_CORN:10,WATER_EDGE_INWARD_T:11,WATER_EDGE_INWARD_B:12,WATER_EDGE_INWARD_S:13,WATER_EDGE_CIRCLE:14,WHEAT_GROW_1:19,WHEAT_GROW_2:20,WHEAT_GROW_3:21,WHEAT_GROW_4:22,WHEAT_STATIC_1:23,WHEAT_STATIC_2:24,WHEAT_STATIC_3:25,WHEAT_BLANK:26,FLOWER:27,BOAT:28,CHERRY:29},Je={UPPER_F1:{x:1,y:37,w:8,h:8},UPPER_F2:{x:10,y:37,w:8,h:8},LOWER_F1:{x:1,y:46,w:8,h:8},LOWER_F2:{x:10,y:46,w:8,h:8}},X=1,V=2,J=4,K=8,vt=["default","classic","girl","hot"],Zt={default:"/themes/default.webp",classic:"/themes/classic.webp",girl:"/themes/girl.webp",hot:"/themes/hot.webp"},ve=null,Ke=null,De="default",Qt=[];function et(s){Qt.push(s)}function es(s){return new Promise((e,t)=>{let n=new Image;n.onload=()=>e(n),n.onerror=()=>t(new Error(`Failed to load: ${s}`)),n.src=s})}function un(){let s=localStorage.getItem("enclose_theme");return s&&vt.includes(s)?s:"default"}function bt(){return De}async function We(){return ve?.loaded?ve:Ke||(De=un(),Ke=(async()=>(ve={sheet:await es(Zt[De]),loaded:!0},ve))(),Ke)}async function ts(s){if(s===De)return;let e=await es(Zt[s]);ve?ve.sheet=e:ve={sheet:e,loaded:!0},De=s,localStorage.setItem("enclose_theme",s);for(let t of Qt)t()}function Oe(){return ve}function pn(s,e){return{sx:s*18+1,sy:e*18+1,sw:16,sh:16}}function se(s,e,t,n,o,i,a,l,r=!1){let{sx:h,sy:u,sw:d,sh:c}=pn(t,n);r?(s.save(),s.translate(o+a,i),s.scale(-1,1),s.drawImage(e,h,u,d,c,0,0,a,l),s.restore()):s.drawImage(e,h,u,d,c,o,i,a,l)}function me(s,e,t,n,o,i,a,l,r=!1){let h=t==="upper"?n===0?Je.UPPER_F1:Je.UPPER_F2:n===0?Je.LOWER_F1:Je.LOWER_F2;r?(s.save(),s.translate(o+a,i),s.scale(-1,1),s.drawImage(e,h.x,h.y,h.w,h.h,0,0,a,l),s.restore()):s.drawImage(e,h.x,h.y,h.w,h.h,o,i,a,l)}function Ee(s,e,t,n){let o=n%s,i=Math.floor(n/s),a=0;return(i===0||t[(i-1)*s+o]===0)&&(a|=X),(o===s-1||t[i*s+(o+1)]===0)&&(a|=V),(i===e-1||t[(i+1)*s+o]===0)&&(a|=J),(o===0||t[i*s+(o-1)]===0)&&(a|=K),a}function ze(s,e,t,n){let o=n%s,i=Math.floor(n/s);for(let a=-1;a<=1;a++)for(let l=-1;l<=1;l++){if(l===0&&a===0)continue;let r=o+l,h=i+a;if(r<0||r>=s||h<0||h>=e||t[h*s+r]===0)return!1}return!0}function $e(s,e){return s===0?{col:B.WATER_BLANK,flipX:!1}:s===K?{col:e%2===0?B.WATER_EDGE_LEFT_1:B.WATER_EDGE_LEFT_2,flipX:!1}:s===V?{col:e%2===0?B.WATER_EDGE_LEFT_1:B.WATER_EDGE_LEFT_2,flipX:!0}:s===X?{col:e%2===0?B.WATER_EDGE_TOP_1:B.WATER_EDGE_TOP_2,flipX:!1}:s===J?{col:B.WATER_EDGE_BOTTOM,flipX:!1}:s===(X|K)?{col:B.WATER_EDGE_TL_CORN,flipX:!1}:s===(X|V)?{col:B.WATER_EDGE_TL_CORN,flipX:!0}:s===(J|K)?{col:B.WATER_EDGE_BL_CORN,flipX:!1}:s===(J|V)?{col:B.WATER_EDGE_BL_CORN,flipX:!0}:s===(X|K|V)?{col:B.WATER_EDGE_INWARD_T,flipX:!1}:s===(J|K|V)?{col:B.WATER_EDGE_INWARD_B,flipX:!1}:s===(X|J|K)?{col:B.WATER_EDGE_INWARD_S,flipX:!1}:s===(X|J|V)?{col:B.WATER_EDGE_INWARD_S,flipX:!0}:s===(X|V|J|K)?{col:B.WATER_EDGE_CIRCLE,flipX:!1}:null}function Fe(s,e,t,n){let o=n%s,i=Math.floor(n/s),a=0,l=(r,h)=>r<0||r>=s||h<0||h>=e?!0:t[h*s+r]===0;return l(o-1,i-1)&&!l(o-1,i)&&!l(o,i-1)&&(a|=1),l(o+1,i-1)&&!l(o+1,i)&&!l(o,i-1)&&(a|=2),l(o+1,i+1)&&!l(o+1,i)&&!l(o,i+1)&&(a|=4),l(o-1,i+1)&&!l(o-1,i)&&!l(o,i+1)&&(a|=8),a}var Ze={F1:{x:27*18+1,y:2*18+1,w:29,h:28},F2:{x:29*18+1,y:2*18+1,w:29,h:28},F3:{x:21*18+1,y:2*18+1,w:29,h:28},F4:{x:23*18+1,y:2*18+1,w:29,h:28}},Be={RAISE_F1:{x:15*18+1,y:2*18+1,w:16,h:24},RAISE_F2:{x:16*18+1,y:2*18+1,w:16,h:24},RAISE_F3:{x:17*18+1,y:2*18+1,w:16,h:24},RAISE_F4:{x:18*18+1,y:2*18+1,w:16,h:24},UP_F1:{x:19*18+1,y:2*18+1,w:16,h:24},UP_F2:{x:20*18+1,y:2*18+1,w:16,h:24}},Jt={FRAME_0:{x:B.CHERRY*18+1,y:1,w:16,h:16},FRAME_1:{x:B.CHERRY*18+1,y:19,w:16,h:16}},Qe={FRAME_0:{x:15*18+1,y:1,w:16,h:16},FRAME_1:{x:16*18+1,y:1,w:16,h:16},FRAME_2:{x:17*18+1,y:1,w:16,h:16},FRAME_3:{x:18*18+1,y:1,w:16,h:16}};function Ce(s,e,t,n,o,i,a,l){let r;t==="raise"?r=[Be.RAISE_F1,Be.RAISE_F2,Be.RAISE_F3,Be.RAISE_F4][Math.min(n,3)]:r=n%4===3?Be.UP_F1:Be.UP_F2,s.drawImage(e,r.x,r.y,r.w,r.h,o,i,a,l)}function ss(s,e,t,n,o,i,a,l=!1){let r=l?t%2===0?Ze.F3:Ze.F4:t%2===0?Ze.F1:Ze.F2;s.drawImage(e,r.x,r.y,r.w,r.h,n,o,i,a)}function yt(s,e,t,n,o,i,a){let r=[B.WHEAT_GROW_1,B.WHEAT_GROW_2,B.WHEAT_GROW_3,B.WHEAT_GROW_4][Math.min(t,3)];s.drawImage(e,r*18+1,1,16,16,n,o,i,a)}function ns(s,e,t,n,o,i,a){let r=[B.WHEAT_STATIC_1,B.WHEAT_STATIC_2,B.WHEAT_STATIC_3,B.WHEAT_STATIC_2][t%4];s.drawImage(e,r*18+1,1,16,16,n,o,i,a)}function wt(s,e,t,n,o,i,a){if(!e)return;let l=t%2===0?Jt.FRAME_0:Jt.FRAME_1;s.drawImage(e,l.x,l.y,l.w,l.h,n,o,i,a)}var fn=198,mn=.94,gn=.79,is=37;function vn(s){return s*is}var Kt=new Map;function bn(s,e,t){s/=255,e/=255,t/=255;let n=Math.max(s,e,t),o=Math.min(s,e,t),i=0,a=0,l=(n+o)/2;if(n!==o){let r=n-o;switch(a=l>.5?r/(2-n-o):r/(n+o),n){case s:i=((e-t)/r+(e<t?6:0))/6;break;case e:i=((t-s)/r+2)/6;break;case t:i=((s-e)/r+4)/6;break}}return[i*360,a,l]}function os(s,e,t){s/=360;let n,o,i;if(e===0)n=o=i=t;else{let a=(h,u,d)=>(d<0&&(d+=1),d>1&&(d-=1),d<.16666666666666666?h+(u-h)*6*d:d<.5?u:d<.6666666666666666?h+(u-h)*(.6666666666666666-d)*6:h),l=t<.5?t*(1+e):t+e-t*e,r=2*t-l;n=a(r,l,s+1/3),o=a(r,l,s),i=a(r,l,s-1/3)}return[Math.round(n*255),Math.round(o*255),Math.round(i*255)]}function yn(s,e,t){let n=`${t}_${e}`,o=Kt.get(n);if(o)return o;let a=[Qe.FRAME_0,Qe.FRAME_1,Qe.FRAME_2,Qe.FRAME_3][e%4],l=document.createElement("canvas");l.width=a.w,l.height=a.h;let r=l.getContext("2d");r.drawImage(s,a.x,a.y,a.w,a.h,0,0,a.w,a.h);let h=r.getImageData(0,0,a.w,a.h),u=h.data,d=vn(t);for(let c=0;c<u.length;c+=4){if(u[c+3]===0)continue;let[g,m,f]=bn(u[c],u[c+1],u[c+2]),v=(g+d)%360,[E,x,w]=os(v,m,f);u[c]=E,u[c+1]=x,u[c+2]=w}return r.putImageData(h,0,0),Kt.set(n,l),l}function xt(s,e,t,n,o,i,a,l,r=0,h=!0,u=0){if(!e)return;let d=o+r;h||(s.globalAlpha=.35+u*.65);let c=yn(e,t,n);s.drawImage(c,0,0,c.width,c.height,d,i,a,l),h||(s.globalAlpha=1)}function be(s,e=1){let t=(fn+s*is)%360,[n,o,i]=os(t,mn,gn);return`rgba(${n}, ${o}, ${i}, ${e})`}var hs=.15,de=null,as=null,Te=null,Et=null,Ct={w:0,h:0};function wn(s,e){return(!Te||Ct.w!==s||Ct.h!==e)&&(Te=document.createElement("canvas"),Te.width=s,Te.height=e,Et=Te.getContext("2d"),Et.imageSmoothingEnabled=!1,Ct={w:s,h:e}),Et}function xn(s,e){return de||(de=document.createElement("canvas"),as=de.getContext("2d")),(de.width<s||de.height<e)&&(de.width=Math.max(de.width,s),de.height=Math.max(de.height,e)),as}var ls=new Map,rs=null;function le(s,e,t,n,o,i,a,l,r,h,u,d=!1,c=!1){if(u<=0){d||c?(s.save(),s.translate(d?a+r:a,c?l+h:l),s.scale(d?-1:1,c?-1:1),s.drawImage(e,t,n,o,i,0,0,r,h),s.restore()):s.drawImage(e,t,n,o,i,a,l,r,h);return}let p=xn(Math.ceil(r),Math.ceil(h));p.clearRect(0,0,r,h),p.imageSmoothingEnabled=!1,d||c?(p.save(),p.translate(d?r:0,c?h:0),p.scale(d?-1:1,c?-1:1),p.drawImage(e,t,n,o,i,0,0,r,h),p.restore()):p.drawImage(e,t,n,o,i,0,0,r,h),p.globalCompositeOperation="source-atop",p.fillStyle=`rgba(255, 255, 255, ${u})`,p.fillRect(0,0,r,h),p.globalCompositeOperation="source-over",s.drawImage(de,0,0,r,h,a,l,r,h)}function Tt(s,e,t){let{state:n,solveResult:o}=t,{visited:i,escaped:a}=o;s.imageSmoothingEnabled=!1;let l=Oe(),r=Math.floor(H()/2)%2,h=t.tileSize;s.clearRect(0,0,e.width,e.height),En(s,t,l,r,i,a),t.optimalOverlay&&Cn(s,t,l,r),Mn(s,t,l,r),Ln(s,t,r),t.hideGridLines||On(s,t),kn(s,t,l,r,a);let u=t.selectedPortalIdx>=0?t.selectedPortalIdx:t.hoverIdx,d=Nn(t,o.escapePath,u);(t.hoverIdx>=0||t.selectedPortalIdx>=0)&&t.mode==="PLAYER"&&!d&&In(s,t),t.hoverIdx>=0&&l?.loaded&&!t.isMouseDown&&Pn(s,t,l,r),t.hoverIdx>=0&&t.mode==="EDITOR"&&$n(s,t),Fn(s,t,l);let c=Bn(s,t);t._hasCherryTextAnimations=c;let p=t.mode==="EDITOR"&&t.currentTool===2;t.hoverAnimProgress>0&&a&&o.escapePath.length>1&&!p&&Gn(s,t,o.escapePath),t.showEscapePath&&!t.hoveringPlayer&&a&&o.escapePath.length>1&&qn(s,t,o.escapePath),t.hoverAnimProgress>0&&!p&&(a||t.horseClicked)&&!t.hideHorseThoughts&&jn(s,t,o.escapePath),An(s,t)}function En(s,e,t,n,o,i){let{state:a,gridOffsetX:l,gridOffsetY:r,tileSize:h}=e;for(let u=0;u<a.cols*a.rows;u++){let d=l+u%a.cols*h,c=r+Math.floor(u/a.cols)*h,p=h+.5;if(!t?.loaded)continue;let g=t.sheet,m=f=>{let v=Math.sin(f*12345+u*67890)*1e4;return v-Math.floor(v)};a.terrain[u]===0?Tn(s,e,g,n,u,d,c,p,o,m):Sn(s,e,g,n,u,d,c,p,o,i,m)}}function Cn(s,e,t,n){if(!e.optimalOverlay||!t?.loaded)return;let{state:o,gridOffsetX:i,gridOffsetY:a,tileSize:l}=e,{walls:r,visited:h}=e.optimalOverlay,u=t.sheet;s.save(),s.globalAlpha=.4;for(let c=0;c<o.cols*o.rows;c++){if(o.terrain[c]!==0||!h.has(c))continue;let p=i+c%o.cols*l,g=a+Math.floor(c/o.cols)*l,m=l+.5;se(s,u,B.WHEAT_BLANK,0,p,g,m,m)}let d=new Set(r);for(let c=0;c<o.cols*o.rows;c++){if(o.terrain[c]!==1)continue;let p=c%o.cols,g=Math.floor(c/o.cols),m=i+p*l,f=a+g*l,v=l+.5,E=(G,ne)=>{if(G<0||G>=o.cols||ne<0||ne>=o.rows)return!1;let N=ne*o.cols+G;return o.terrain[N]!==0||d.has(N)?!1:h.has(N)},x=E(p,g-1),w=E(p,g+1),y=E(p+1,g),b=E(p-1,g);if(!(x||w||y||b))continue;let T=Ee(o.cols,o.rows,o.terrain,c),A=(T&(K|V))===(K|V)&&!(T&(X|J)),C=(T&(X|J))===(X|J)&&!(T&(K|V)),R=$e(T,c),L=R?R.col:B.WATER_BLANK,k=R?R.flipX:!1,M=2+n,I=L*18+1,P=M*18+1,O=v/16,D=(T&X)!==0,S=(T&J)!==0,$=(T&V)!==0,ee=(T&K)!==0;if(A){let ne=(c%2===0?B.WATER_EDGE_LEFT_1:B.WATER_EDGE_LEFT_2)*18+1,N=M*18+1,Y=(c%2===0?B.WATER_EDGE_LEFT_2:B.WATER_EDGE_LEFT_1)*18+1;b&&le(s,u,ne,N,3,16,m,f,3*O,v,0,!1,!1),y&&le(s,u,Y,N,3,16,m+13*O,f,3*O,v,0,!0,!1)}else if(C){let ne=(c%2===0?B.WATER_EDGE_TOP_1:B.WATER_EDGE_TOP_2)*18+1,N=M*18+1;x&&le(s,u,ne,N,16,3,m,f,v,3*O,0,!1,!1),w&&le(s,u,18*B.WATER_EDGE_BOTTOM+1,N+13,16,3,m,f+13*O,v,3*O,0,!1,!1)}else{if(D&&x&&le(s,u,I,P,16,3,m,f,v,3*O,0,k),S&&w&&le(s,u,I,P+13,16,3,m,f+13*O,v,3*O,0,k),ee&&b){let G=k?I+13:I;le(s,u,G,P,3,16,m,f,3*O,v,0,k)}if($&&y){let G=k?I:I+13;le(s,u,G,P,3,16,m+13*O,f,3*O,v,0,k)}}}s.restore()}function Tn(s,e,t,n,o,i,a,l,r,h){let{state:u,gridOffsetX:d,gridOffsetY:c,tileSize:p}=e,g=h(1)<.11,m=(n+(h(2)<.5?1:0))%2,f=e.hideWheat?0:e.getWheatProgress(o,r);if(o===u.playerIdx||u.cherries[o])f>0?se(s,t,B.WHEAT_BLANK,0,i,a,l,l):se(s,t,B.GRASS_BLANK,m,i,a,l,l);else if(f<=0)g?se(s,t,B.GRASS_ANIM,m,i,a,l,l):(se(s,t,B.GRASS_BLANK,m,i,a,l,l),h(3)<.025&&se(s,t,B.FLOWER,m,i,a,l,l));else if(f<1){let v=Math.min(3,Math.floor(f*4));if(e.animDirection<0){g?se(s,t,B.GRASS_ANIM,m,i,a,l,l):se(s,t,B.GRASS_BLANK,m,i,a,l,l),s.save();let E=Math.min(1,f/.4);s.globalAlpha=Math.ceil(E*3)/3,yt(s,t,v,i,a,l,l),s.restore()}else yt(s,t,v,i,a,l,l)}else{let v=H()%4;ns(s,t,v,i,a,l,l)}if(e.animDirection>0&&e.animLastUpdate>0&&e.cellBfsDistance.has(o)&&f>0&&f<.5){let E=1-f/.5;s.fillStyle=`rgba(255, 255, 255, ${E*E*.9})`,s.fillRect(i,a,l,l)}}function Sn(s,e,t,n,o,i,a,l,r,h,u){let{state:d}=e,c=Ee(d.cols,d.rows,d.terrain,o),p=(c&(K|V))===(K|V)&&!(c&(X|J)),g=(c&(X|J))===(X|J)&&!(c&(K|V));if(p){let f=o%2===0?B.WATER_EDGE_LEFT_1:B.WATER_EDGE_LEFT_2,v=(o+1)%2===0?B.WATER_EDGE_LEFT_1:B.WATER_EDGE_LEFT_2,E=l/2;s.drawImage(t,f*18+1,n*18+1,8,16,i,a,E,l),s.save(),s.translate(i+l,a),s.scale(-1,1),s.drawImage(t,v*18+1,n*18+1,8,16,0,0,E,l),s.restore()}else if(g){let f=o%2===0?B.WATER_EDGE_TOP_1:B.WATER_EDGE_TOP_2,v=l/2;s.drawImage(t,f*18+1,n*18+1,16,8,i,a,l,v),s.drawImage(t,B.WATER_EDGE_BOTTOM*18+1,n*18+9,16,8,i,a+v,l,v)}else{let f=$e(c,o);f?se(s,t,f.col,n,i,a,l,l,f.flipX):(s.fillStyle="#2980b9",s.fillRect(i,a,l,l))}let m=Fe(d.cols,d.rows,d.terrain,o);if(m>0){let f=l/2;m&1&&me(s,t,"upper",n,i,a,f,f,!1),m&2&&me(s,t,"upper",n,i+f,a,f,f,!0),m&4&&me(s,t,"lower",n,i+f,a+f,f,f,!0),m&8&&me(s,t,"lower",n,i,a+f,f,f,!1)}ze(d.cols,d.rows,d.terrain,o)&&(u(2)<.7&&se(s,t,B.WATER_ANIM,n,i,a,l,l),u(4)<.006&&se(s,t,B.BOAT,n,i,a,l,l)),cs(s,e,t,n,o,i,a,l,c,r,h,p,g)}function cs(s,e,t,n,o,i,a,l,r,h,u,d,c){let{state:p,cellBfsDistance:g,instantGrowCells:m}=e;if(e.hideWheat||!(!u||g.size>0||m.size>0))return;let v=o%p.cols,E=Math.floor(o/p.cols),x=(F,ae)=>{if(F<0||F>=p.cols||ae<0||ae>=p.rows)return[!1,0];let ce=ae*p.cols+F;if(p.terrain[ce]!==0)return[!1,0];if(p.walls[ce])return[!1,0];let Ae=e.getWheatProgress(ce,h);return[Ae>0,Ae]},[w,y]=x(v,E-1),[b,T]=x(v,E+1),[A,C]=x(v+1,E),[R,L]=x(v-1,E),[k]=x(v+1,E-1),[M]=x(v-1,E-1),[I]=x(v+1,E+1),[P]=x(v-1,E+1);if(!(w||b||A||R||k||M||I||P))return;let O=F=>{if(e.animDirection<=0||e.animLastUpdate<=0||F<=0||F>=.5)return 0;let ae=F/.5;return(1-ae)*(1-ae)*.9},D=e.animDirection<0,S=F=>{if(!D||F>=1)return 1;let ae=Math.min(1,F/.4);return Math.ceil(ae*3)/3},$=$e(r,o),ee=$?$.col:B.WATER_BLANK,G=$?$.flipX:!1,ne=2+n,N=ee*18+1,j=ne*18+1,Y=l/16,te=(r&X)!==0,Z=(r&J)!==0,fe=(r&V)!==0,ie=(r&K)!==0;if(te&&w&&(s.save(),s.globalAlpha=S(y),le(s,t,N,j,16,3,i,a,l,3*Y,O(y),G),s.restore()),Z&&b&&(s.save(),s.globalAlpha=S(T),le(s,t,N,j+13,16,3,i,a+13*Y,l,3*Y,O(T),G),s.restore()),ie&&R){s.save(),s.globalAlpha=S(L);let F=G?N+13:N;le(s,t,F,j,3,16,i,a,3*Y,l,O(L),G),s.restore()}if(fe&&A){s.save(),s.globalAlpha=S(C);let F=G?N:N+13;le(s,t,F,j,3,16,i+13*Y,a,3*Y,l,O(C),G),s.restore()}if(d){let ae=(o%2===0?B.WATER_EDGE_LEFT_1:B.WATER_EDGE_LEFT_2)*18+1,ce=ne*18+1,He=(o%2===0?B.WATER_EDGE_LEFT_2:B.WATER_EDGE_LEFT_1)*18+1;R&&(s.save(),s.globalAlpha=S(L),le(s,t,ae,ce,3,16,i,a,3*Y,l,O(L),!1,!1),s.restore()),A&&(s.save(),s.globalAlpha=S(C),le(s,t,He,ce,3,16,i+13*Y,a,3*Y,l,O(C),!0,!1),s.restore())}if(c){let ae=(o%2===0?B.WATER_EDGE_TOP_1:B.WATER_EDGE_TOP_2)*18+1,ce=ne*18+1;w&&(s.save(),s.globalAlpha=S(y),le(s,t,ae,ce,16,3,i,a,l,3*Y,O(y),!1,!1),s.restore()),b&&(s.save(),s.globalAlpha=S(T),le(s,t,18*B.WATER_EDGE_BOTTOM+1,ce+13,16,3,i,a+13*Y,l,3*Y,O(T),!1,!1),s.restore())}}function Mn(s,e,t,n){let{state:o,gridOffsetX:i,gridOffsetY:a,tileSize:l,cherryBlockedStart:r}=e,h=performance.now(),u=400;for(let d=0;d<o.cols*o.rows;d++){if(!o.cherries[d])continue;let c=i+d%o.cols*l,p=a+Math.floor(d/o.cols)*l,g=r?.get(d),m=!1;if(g){let f=h-g;if(f<u){m=!0;let E=1-f/u,x=4,w=l*.15*E;c+=Math.sin(f/u*x*Math.PI*2)*w}}wt(s,t?.sheet||null,n,c,p,l,l)}}function Rn(s,e,t,n,o,i,a){let l=H(),r=e+n/2+a,h=t+n/2,u=Math.round(n),d=`${o}_${u}`,c=ls.get(d);(!c||rs!==s)&&(rs=s,c=s.createRadialGradient(0,0,0,0,0,n*.8),c.addColorStop(0,be(o,.4)),c.addColorStop(.3,be(o,.25)),c.addColorStop(.6,be(o,.1)),c.addColorStop(1,"transparent"),ls.set(d,c));for(let g=0;g<3;g++){let m=n*.45,f=l*.4+g*(Math.PI/2)+i*.7,v=r+Math.cos(f)*m,E=h+Math.sin(f)*m,x=Math.round(v),w=Math.round(E),y=.2+(l+g+i)%4*.17;s.fillStyle=`rgba(255, 255, 255, ${y})`,s.fillRect(x-2,w-2,4,4)}let p=n*.55;for(let g=0;g<5;g++){let f=(l+g*7+i*13)%16/16,v=(g*.785+i*.5)%(Math.PI*2),E=p*(1-f*.85),x=r+Math.cos(v)*E,w=h+Math.sin(v)*E,y=Math.round(x),b=Math.round(w),T=f<.3?f/.3:(1-f)/.7;s.fillStyle=be(o,T),s.fillRect(y-2,b-2,5,5)}}function Ln(s,e,t){let{state:n,gridOffsetX:o,gridOffsetY:i,tileSize:a,portalBlockedStart:l}=e,r=n.portals;if(!r)return;let h=Oe();if(!h?.loaded)return;let u=performance.now(),d=400,c=new Map;for(let m=0;m<r.length;m++){let f=r[m];f!==null&&c.set(f,(c.get(f)||0)+1)}let p=H()%4,g=p%2;for(let m=0;m<r.length;m++){let f=r[m];if(f===null)continue;let v=o+m%n.cols*a,E=i+Math.floor(m/n.cols)*a,x=0,w=l?.get(m);if(w){let b=u-w;if(b<d){let A=1-b/d,C=4,R=a*.15*A;x=Math.sin(b/d*C*Math.PI*2)*R}}let y=(c.get(f)||0)>=2;xt(s,h.sheet,p,f,v,E,a,a,x,y,g),Rn(s,v,E,a,f,m,x)}}function An(s,e){let{state:t,gridOffsetX:n,gridOffsetY:o,tileSize:i,portalLabels:a,portalBlockedStart:l}=e;if(!a)return;let r=t.portals;if(!r)return;let h=performance.now(),u=400;for(let d=0;d<r.length;d++){let c=r[d];if(c===null)continue;let p=n+d%t.cols*i,g=o+Math.floor(d/t.cols)*i,m=0,f=l?.get(d);if(f){let w=h-f;if(w<u){let y=1-w/u,b=i*.15*y;m=Math.sin(w/u*4*Math.PI*2)*b}}let v=c<10?String(c):String.fromCharCode(97+c-10),E=p+m+i/2,x=g-i*.1;s.font=`${Math.round(i*.55)}px Schoolbell, cursive`,s.textAlign="center",s.textBaseline="bottom",s.strokeStyle="rgba(0, 0, 0, 0.8)",s.lineWidth=3,s.strokeText(v,E,x),s.fillStyle="rgba(255, 255, 255, 0.95)",s.fillText(v,E,x)}}function In(s,e){let{state:t,gridOffsetX:n,gridOffsetY:o,tileSize:i,hoverIdx:a,selectedPortalIdx:l,MARCH_SPEED:r}=e,h=t.portals;if(!h)return;let u=a>=0&&h[a]!==null?a:l;if(u<0)return;let d=h[u];if(d===null)return;let c=-1;for(let w=0;w<h.length;w++)if(w!==u&&h[w]===d){c=w;break}if(c<0)return;let p=H(),g=i*.04,m=w=>{let y=Math.sin(w*2468+p*1357)*1e4;return y-Math.floor(y)-.5},f=n+u%t.cols*i+i/2+m(u*2)*g*2,v=o+Math.floor(u/t.cols)*i+i/2+m(u*2+1)*g*2,E=n+c%t.cols*i+i/2+m(c*2)*g*2,x=o+Math.floor(c/t.cols)*i+i/2+m(c*2+1)*g*2;s.save(),s.strokeStyle=be(d,.8),s.lineWidth=i*.12,s.lineCap="round",s.lineJoin="round",s.setLineDash([i*.18,i*.35]),s.lineDashOffset=-p*i*r,s.beginPath(),s.moveTo(f,v),s.lineTo(E,x),s.stroke(),s.restore()}function Bn(s,e){let{state:t,gridOffsetX:n,gridOffsetY:o,tileSize:i,cherryTextStart:a}=e;if(!a||a.size===0)return!1;let l=performance.now(),r=500,h=300,u=r+h,d=i*.5,c=!1;s.save(),s.font=`bold ${Math.round(i*.45)}px Schoolbell, cursive`,s.textAlign="center",s.textBaseline="middle";let p=i*.04;for(let[g,m]of a.entries()){let f=l-m;if(f>u)continue;c=!0;let v=(g*2654435761>>>0)%1e3,E=Math.PI/6,x=-Math.PI/2+(v/1e3-.5)*2*E,w;f<r?w=1:w=1-(f-r)/h;let b=f/u*d,T=n+g%t.cols*i+i/2,A=o+Math.floor(g/t.cols)*i+i*.3,C=T+Math.cos(x)*b,R=A+Math.sin(x)*b,L=W(g*3)*p*2,k=W(g*3+1)*p*2,M=W(g*3+2)*.1,P=x+Math.PI/2+M;s.save(),s.translate(C+L,R+k),s.rotate(P),s.fillStyle=`rgba(255, 255, 255, ${w})`,s.fillText("+3",0,0),s.restore()}return s.restore(),c}function On(s,e){let{state:t,gridOffsetX:n,gridOffsetY:o,tileSize:i}=e,a=e.gridOpacity??hs;if(a<=0)return;let l=e.darkGridlines?"0,0,0":"255,255,255";s.strokeStyle=`rgba(${l},${a})`,s.lineWidth=1;let r=Math.round(n)+.5,h=Math.round(o)+.5,u=Math.round(t.cols*i),d=Math.round(t.rows*i);s.strokeRect(r,h,u,d),s.beginPath();for(let c=1;c<t.cols;c++){let p=Math.round(n+c*i)+.5;s.moveTo(p,h),s.lineTo(p,h+d)}for(let c=1;c<t.rows;c++){let p=Math.round(o+c*i)+.5;s.moveTo(r,p),s.lineTo(r+u,p)}s.stroke()}function kn(s,e,t,n,o){if(!t?.loaded)return;let{state:i,gridOffsetX:a,gridOffsetY:l,tileSize:r}=e,h=a+i.playerIdx%i.cols*r,u=l+Math.floor(i.playerIdx/i.cols)*r,d=.9,c=r*d,p=r*d*(28/29),g=h+(r-c)/2,m=u+(r-p)/2;ss(s,t.sheet,n,g,m,c,p,!o)}function Pn(s,e,t,n){let{state:o,mode:i,currentTool:a,hoverIdx:l,gridOffsetX:r,gridOffsetY:h,tileSize:u,getBrushCells:d}=e,c=i==="EDITOR"?d(l):[l];i==="PLAYER"?_n(s,e,t,l):(s.globalAlpha=.5,a===1?Hn(s,e,t,c):a===0||a===3?Dn(s,e,t,n,c):a===4?Wn(s,e,t,n,c):a===5&&zn(s,e,t,n,l),s.globalAlpha=1)}function _n(s,e,t,n){let{state:o,gridOffsetX:i,gridOffsetY:a,tileSize:l}=e;if(o.walls.filter(f=>f).length>=o.budget)return;let h=i+n%o.cols*l,u=a+Math.floor(n/o.cols)*l,d=o.terrain[n]===0,c=n===o.playerIdx,p=o.walls[n],g=o.cherries[n],m=o.portals&&o.portals[n]!==null;d&&!p&&!c&&!g&&!m&&(s.globalAlpha=.5,Ce(s,t.sheet,"raise",0,h,u-l*.5,l,l*1.5),s.globalCompositeOperation="source-atop",s.fillStyle="rgba(100, 150, 255, 0.3)",s.fillRect(h,u-l*.5,l,l*1.5),s.globalCompositeOperation="source-over",s.globalAlpha=1)}function Hn(s,e,t,n){let{state:o,gridOffsetX:i,gridOffsetY:a,tileSize:l}=e;for(let r of n){let h=i+r%o.cols*l,u=a+Math.floor(r/o.cols)*l,d=o.terrain[r]===0,c=r===o.playerIdx,p=o.walls[r],g=o.cherries[r],m=o.portals&&o.portals[r]!==null;d&&!p&&!c&&!g&&!m&&Ce(s,t.sheet,"raise",0,h,u-l*.5,l,l*1.5)}s.globalCompositeOperation="source-atop",s.fillStyle="rgba(100, 150, 255, 0.3)";for(let r of n){let h=i+r%o.cols*l,u=a+Math.floor(r/o.cols)*l,d=o.terrain[r]===0,c=r===o.playerIdx,p=o.walls[r],g=o.cherries[r],m=o.portals&&o.portals[r]!==null;d&&!p&&!c&&!g&&!m&&s.fillRect(h,u-l*.5,l,l*1.5)}s.globalCompositeOperation="source-over"}function Dn(s,e,t,n,o){let{state:i,currentTool:a,gridOffsetX:l,gridOffsetY:r,tileSize:h}=e,u=a===0?0:1,d=[...i.terrain],c=new Set;for(let C of o)C!==i.playerIdx&&(d[C]=u,c.add(C));let p=new Set;for(let C of c){let R=C%i.cols,L=Math.floor(C/i.cols);for(let k=-1;k<=1;k++)for(let M=-1;M<=1;M++){if(M===0&&k===0)continue;let I=R+M,P=L+k;if(I>=0&&I<i.cols&&P>=0&&P<i.rows){let O=P*i.cols+I;!c.has(O)&&d[O]===1&&p.add(O)}}}let g=Math.ceil(h+1),m=document.createElement("canvas");m.width=g,m.height=g;let f=m.getContext("2d");f.imageSmoothingEnabled=!1;let v=(C,R)=>{let L=l+C%i.cols*h,k=r+Math.floor(C/i.cols)*h,M=h+.5;f.clearRect(0,0,g,g);let I=Ee(i.cols,i.rows,d,C),P=(I&(K|V))===(K|V)&&!(I&(X|J)),O=(I&(X|J))===(X|J)&&!(I&(K|V));if(P){let S=C%2===0?B.WATER_EDGE_LEFT_1:B.WATER_EDGE_LEFT_2,$=(C+1)%2===0?B.WATER_EDGE_LEFT_1:B.WATER_EDGE_LEFT_2,ee=M/2;f.drawImage(t.sheet,S*18+1,n*18+1,8,16,0,0,ee,M),f.save(),f.translate(M,0),f.scale(-1,1),f.drawImage(t.sheet,$*18+1,n*18+1,8,16,0,0,ee,M),f.restore()}else if(O){let S=C%2===0?B.WATER_EDGE_TOP_1:B.WATER_EDGE_TOP_2,$=M/2;f.drawImage(t.sheet,S*18+1,n*18+1,16,8,0,0,M,$),f.drawImage(t.sheet,B.WATER_EDGE_BOTTOM*18+1,n*18+9,16,8,0,$,M,$)}else{let S=$e(I,C);S&&se(f,t.sheet,S.col,n,0,0,M,M,S.flipX)}let D=Fe(i.cols,i.rows,d,C);if(D>0){let S=M/2;D&1&&me(f,t.sheet,"upper",n,0,0,S,S,!1),D&2&&me(f,t.sheet,"upper",n,S,0,S,S,!0),D&4&&me(f,t.sheet,"lower",n,S,S,S,S,!0),D&8&&me(f,t.sheet,"lower",n,0,S,S,S,!1)}if(ze(i.cols,i.rows,d,C)){let S=Math.sin(C*12345+135780)*1e4;S-Math.floor(S)<.7&&se(f,t.sheet,B.WATER_ANIM,n,0,0,M,M)}s.globalAlpha=R,s.drawImage(m,0,0,g,g,L,k,M,M)};for(let C of p)v(C,1);for(let C of c){let R=l+C%i.cols*h,L=r+Math.floor(C/i.cols)*h,k=h+.5,M=i.terrain[C]===1;if(u===0)s.globalAlpha=.5,se(s,t.sheet,B.GRASS_BLANK,0,R,L,k,k);else if(M){let I=Ee(i.cols,i.rows,i.terrain,C),P=Ee(i.cols,i.rows,d,C),O=Fe(i.cols,i.rows,i.terrain,C),D=Fe(i.cols,i.rows,d,C),S=ze(i.cols,i.rows,i.terrain,C),$=ze(i.cols,i.rows,d,C);(I!==P||O!==D||S!==$)&&v(C,1)}else v(C,.5)}s.globalAlpha=1;let{solveResult:E}=e,x=E.visited,w=E.escaped;if((!w||e.cellBfsDistance.size>0||e.instantGrowCells.size>0)&&!e.hideWheat){let C=new Set([...p,...c].filter(R=>d[R]===1));for(let R of C){let L=l+R%i.cols*h,k=r+Math.floor(R/i.cols)*h,M=h+.5,I=Ee(i.cols,i.rows,d,R),P=(I&(K|V))===(K|V)&&!(I&(X|J)),O=(I&(X|J))===(X|J)&&!(I&(K|V));cs(s,e,t.sheet,n,R,L,k,M,I,x,w,P,O)}}let b=e.gridOpacity??hs;if(b<=0)return;let T=e.darkGridlines?"0,0,0":"255,255,255";s.strokeStyle=`rgba(${T},${b})`,s.lineWidth=1;let A=new Set([...p,...c]);s.beginPath();for(let C of A){let R=C%i.cols,L=Math.floor(C/i.cols),k=Math.round(l+R*h)+.5,M=Math.round(r+L*h)+.5,I=Math.round(l+(R+1)*h)+.5,P=Math.round(r+(L+1)*h)+.5;s.moveTo(k,M),s.lineTo(I,M),s.moveTo(k,P),s.lineTo(I,P),s.moveTo(k,M),s.lineTo(k,P),s.moveTo(I,M),s.lineTo(I,P)}s.stroke()}function Wn(s,e,t,n,o){let{state:i,gridOffsetX:a,gridOffsetY:l,tileSize:r}=e;for(let h of o){if(h===i.playerIdx||i.terrain[h]===1||i.walls[h]||i.cherries[h])continue;let u=a+h%i.cols*r,d=l+Math.floor(h/i.cols)*r;wt(s,t?.sheet||null,n,u,d,r,r)}}function zn(s,e,t,n,o){let{state:i,gridOffsetX:a,gridOffsetY:l,tileSize:r}=e;if(o<0||o===i.playerIdx||i.terrain[o]===1||i.walls[o]||i.cherries[o]||i.portals[o]!==null)return;let h=a+o%i.cols*r,u=l+Math.floor(o/i.cols)*r,d=e.nextPortalChannel??0,c=n%4;xt(s,t?.sheet||null,c,d,h,u,r,r,0,!0,0)}function $n(s,e){let{state:t,hoverIdx:n,gridOffsetX:o,gridOffsetY:i,tileSize:a,getBrushCells:l}=e,r=l(n),h=Math.min(...r.map(w=>w%t.cols)),u=Math.max(...r.map(w=>w%t.cols)),d=Math.min(...r.map(w=>Math.floor(w/t.cols))),c=Math.max(...r.map(w=>Math.floor(w/t.cols))),p=o+h*a,g=i+d*a,m=o+(u+1)*a,f=i+(c+1)*a,v=Math.max(4,a*.25),E=Math.max(2,a*.08),x=(w,y)=>{s.strokeStyle=w,s.lineWidth=E+y*2,s.lineCap="square",s.beginPath(),s.moveTo(p,g+v),s.lineTo(p,g),s.lineTo(p+v,g),s.stroke(),s.beginPath(),s.moveTo(m-v,g),s.lineTo(m,g),s.lineTo(m,g+v),s.stroke(),s.beginPath(),s.moveTo(m,f-v),s.lineTo(m,f),s.lineTo(m-v,f),s.stroke(),s.beginPath(),s.moveTo(p+v,f),s.lineTo(p,f),s.lineTo(p,f-v),s.stroke()};x("rgba(0,0,0,0.6)",1),x("#ffffff",0)}function Fn(s,e,t){if(!t?.loaded)return;let{state:n,gridOffsetX:o,gridOffsetY:i,tileSize:a,wallPlacedTime:l,WALL_FRAME_DURATION:r,optimalOverlay:h}=e,u=H(),d=performance.now(),c=r*4,p=t.sheet,g=new Map;if(h)for(let E of h.walls){let x=Math.floor(E/n.cols);g.has(x)||g.set(x,[]),g.get(x).push(E)}let m=Math.ceil(a),f=Math.ceil(a*1.5),v=h?wn(m,f):null;for(let E=0;E<n.rows;E++){for(let w=0;w<n.cols;w++){let y=E*n.cols+w;if(!n.walls[y])continue;let b=o+w*a,A=i+E*a-a*.5,C=l.get(y);if(C!==void 0&&d-C<c){let R=d-C,L=Math.min(3,Math.floor(R/r));Ce(s,p,"raise",L,b,A,a,f)}else{let R=u%4;Ce(s,p,"idle",R,b,A,a,f)}}let x=g.get(E);if(x&&v&&Te){s.save(),s.globalAlpha=.5;for(let w of x){let y=w%n.cols,b=o+y*a,T=i+E*a;v.globalCompositeOperation="source-over",v.clearRect(0,0,m,f),v.globalAlpha=1,Ce(v,p,"idle",0,0,0,a,f),v.globalCompositeOperation="color",v.fillStyle="rgb(100, 160, 255)",v.fillRect(0,0,m,f),v.globalCompositeOperation="destination-in",Ce(v,p,"idle",0,0,0,a,f),s.drawImage(Te,b,T-a*.5)}s.restore()}}}function Gn(s,e,t){let{gridOffsetX:n,gridOffsetY:o,tileSize:i,hoverAnimProgress:a,MARCH_SPEED:l,state:r}=e,h=H(),u=a,d=r.portals,c=i*.04,p=b=>{let T=Math.sin(b*2468+h*1357)*1e4;return T-Math.floor(T)-.5},g=t.map(b=>({x:n+b%r.cols*i+i/2,y:o+Math.floor(b/r.cols)*i+i/2})),m=g.map((b,T)=>({x:b.x+p(T*2)*c*2,y:b.y+p(T*2+1)*c*2})),f=0,v=[0],E=g[0].x,x=g[0].y;for(let b=1;b<g.length;b++){let T=t[b-1],A=t[b],C=g[b],R=g[b+1];if(d&&!Se(T,A,r.cols)){let M=g[b-1],I=C.x-M.x,P=C.y-M.y;f+=Math.sqrt(I*I+P*P)*.5,E=C.x,x=C.y}else{let k=t[b+1],M=R&&d&&!Se(A,k,r.cols);if(R&&b<g.length-1&&!M){let P=(C.x+R.x)/2,O=(C.y+R.y)/2,D=P-E,S=O-x;f+=Math.sqrt(D*D+S*S),E=P,x=O}else{let P=C.x-E,O=C.y-x;f+=Math.sqrt(P*P+O*O),E=C.x,x=C.y}}v.push(f)}let w=Math.max(0,Math.min(1,u)),y=f*w;if(w>0){s.save(),s.lineWidth=i*.12,s.lineCap="round",s.lineJoin="round",s.setLineDash([i*.18,i*.35]),s.lineDashOffset=-h*i*l;let b=g[0].x,T=g[0].y,A=0,C="rgba(255, 255, 255, 0.8)",R=g[0].x,L=g[0].y;s.strokeStyle="rgba(255, 255, 255, 0.8)",s.beginPath(),s.moveTo(m[0].x,m[0].y);for(let M=1;M<m.length&&!(v[M-1]>y);M++){let I=t[M-1],P=t[M],O=m[M],D=m[M+1],S=g[M],$=g[M+1];if(d&&!Se(I,P,r.cols)){s.stroke();let j=m[M-1],Y=g[M-1],te=d[I];if(te!==null){let Z=be(te,.8);if(s.strokeStyle=Z,s.beginPath(),s.moveTo(j.x,j.y),v[M]>y){let fe=(y-v[M-1])/(v[M]-v[M-1]);b=Y.x+(S.x-Y.x)*fe,T=Y.y+(S.y-Y.y)*fe,A=Math.atan2(S.y-Y.y,S.x-Y.x),C=Z,s.lineTo(j.x+(O.x-j.x)*fe,j.y+(O.y-j.y)*fe),s.stroke();break}s.lineTo(O.x,O.y),s.stroke(),b=S.x,T=S.y,A=Math.atan2(S.y-Y.y,S.x-Y.x),C=Z}R=S.x,L=S.y,C="rgba(255, 255, 255, 0.8)",s.strokeStyle="rgba(255, 255, 255, 0.8)",s.beginPath(),s.moveTo(O.x,O.y);continue}let G=t[M+1],ne=D&&d&&!Se(P,G,r.cols);if(D&&M<m.length-1&&!ne){let j=(O.x+D.x)/2,Y=(O.y+D.y)/2,te=(S.x+$.x)/2,Z=(S.y+$.y)/2;if(v[M]>y){let ie=(y-v[M-1])/(v[M]-v[M-1]),F=1-ie;b=F*F*R+2*F*ie*S.x+ie*ie*te,T=F*F*L+2*F*ie*S.y+ie*ie*Z;let ae=2*F*(S.x-R)+2*ie*(te-S.x),ce=2*F*(S.y-L)+2*ie*(Z-S.y);A=Math.atan2(ce,ae),s.lineTo(F*F*R+2*F*ie*O.x+ie*ie*j,F*F*L+2*F*ie*O.y+ie*ie*Y);break}s.quadraticCurveTo(O.x,O.y,j,Y),b=te,T=Z,A=Math.atan2(Z-S.y,te-S.x),R=te,L=Z}else{if(v[M]>y){let j=(y-v[M-1])/(v[M]-v[M-1]);b=R+(S.x-R)*j,T=L+(S.y-L)*j,A=Math.atan2(S.y-L,S.x-R),s.lineTo(R+(O.x-R)*j,L+(O.y-L)*j);break}s.lineTo(O.x,O.y),b=S.x,T=S.y,A=Math.atan2(S.y-L,S.x-R),R=S.x,L=S.y}}s.stroke(),s.restore();let k=Math.max(0,Math.min(1,w/.05));k>0&&ds(s,i,h,b,T,A,k,C)}}function Se(s,e,t){let n=Math.floor(s/t),o=s%t,i=Math.floor(e/t),a=e%t;return Math.abs(n-i)+Math.abs(o-a)===1}function Nn(s,e,t){let{state:n,hoverAnimProgress:o}=s;if(o<=0||e.length<=1)return!1;let i=n.portals[t];if(i==null)return!1;let a=n.portals.findIndex((d,c)=>c!==t&&d===i);if(a===-1)return!1;let l=n.cols,r=0,h=-1;for(let d=1;d<e.length;d++){let c=e[d-1],p=e[d],g=!Se(c,p,l),m=c%l,f=Math.floor(c/l),v=p%l,E=Math.floor(p/l),x=v-m,w=E-f,y=Math.sqrt(x*x+w*w)*(g?.5:1);r+=y,g&&(c===t&&p===a||c===a&&p===t)&&(h=r)}return h===-1?!1:r*o>=h-r*.1}function qn(s,e,t){let{gridOffsetX:n,gridOffsetY:o,tileSize:i,MARCH_SPEED:a,state:l}=e,r=H(),h=l.portals,u=i*.04,d=v=>{let E=Math.sin(v*2468+r*1357)*1e4;return E-Math.floor(E)-.5},c=t.map((v,E)=>{let x=n+v%l.cols*i+i/2,w=o+Math.floor(v/l.cols)*i+i/2;return{x:x+d(E*2)*u*2,y:w+d(E*2+1)*u*2}}),p=c[0].x,g=c[0].y,m=0,f="rgba(255, 255, 255, 0.8)";s.save(),s.lineWidth=i*.12,s.lineCap="round",s.lineJoin="round",s.setLineDash([i*.18,i*.35]),s.lineDashOffset=-r*i*a,s.strokeStyle="rgba(255, 255, 255, 0.8)",s.beginPath(),s.moveTo(c[0].x,c[0].y);for(let v=1;v<c.length;v++){let E=t[v-1],x=t[v],w=c[v-1],y=c[v],b=c[v+1];if(h&&!Se(E,x,l.cols)){s.stroke();let C=h[E];if(C!==null){let R=be(C,.8);s.strokeStyle=R,s.beginPath(),s.moveTo(w.x,w.y),s.lineTo(y.x,y.y),s.stroke(),p=y.x,g=y.y,m=Math.atan2(y.y-w.y,y.x-w.x),f=R}f="rgba(255, 255, 255, 0.8)",s.strokeStyle="rgba(255, 255, 255, 0.8)",s.beginPath(),s.moveTo(y.x,y.y);continue}let T=t[v+1],A=b&&h&&!Se(x,T,l.cols);if(b&&v<c.length-1&&!A){let C=(y.x+b.x)/2,R=(y.y+b.y)/2;s.quadraticCurveTo(y.x,y.y,C,R),p=C,g=R,m=Math.atan2(R-y.y,C-y.x)}else s.lineTo(y.x,y.y),p=y.x,g=y.y,m=Math.atan2(y.y-w.y,y.x-w.x)}s.stroke(),s.restore(),ds(s,i,r,p,g,m,1,f)}function ds(s,e,t,n,o,i,a,l="rgba(255, 255, 255, 0.8)"){let r=e*.4,h=c=>{let p=Math.sin(c*3456+t*7890)*1e4;return(p-Math.floor(p)-.5)*e*.05},u=Math.cos(i)*e*.25,d=Math.sin(i)*e*.25;s.save(),s.globalAlpha=a,s.translate(n+u,o+d),s.rotate(i),s.strokeStyle=l,s.lineWidth=e*.1,s.lineCap="round",s.lineJoin="round",s.setLineDash([]),s.beginPath(),s.moveTo(-r*.9+h(1),-r*.5+h(2)),s.lineTo(h(3),h(4)),s.lineTo(-r*.9+h(5),r*.5+h(6)),s.stroke(),s.restore()}function Yn(s,e){let{tileSize:t,thoughtText:n}=e,o=Math.min(t*.55,32),i=Math.min(t*6.5,450);s.font=`${o}px Schoolbell, cursive`;let a=o*.045,l=f=>{let v=f.split(" "),E=[],x="";for(let w of v){let y=x?x+" "+w:w,b=s.measureText(y).width,T=a*(y.length-1);b+T>i&&x?(E.push(x),x=w):x=y}return x&&E.push(x),E},r=[n[0],n[1]].filter(f=>f.length>0),h=[];for(let f of r)h.push(...l(f));let u=o*1.3,d=h.length*u,c=0;for(let f of h){let v=s.measureText(f).width,E=a*(f.length-1);c=Math.max(c,v+E)}let p=Math.min(t*.4,24),g=c+p*2,m=d+p*2;return{width:g,height:m,fontSize:o,lines:h}}function jn(s,e,t){let{state:n,gridOffsetX:o,gridOffsetY:i,tileSize:a,bubbleAnimProgress:l}=e,r=l,h=H(),u=n.playerIdx%n.cols,d=o+u*a+a/2,c=i+Math.floor(n.playerIdx/n.cols)*a,p=Yn(s,e),g=p.width,m=d-a*.5,v=s.canvas.width/(window.devicePixelRatio||1)-(d+a*.5),E=m>=g,x=v>=g,b=(t.length>0?t[t.length-1]:n.playerIdx)%n.cols>u,T;E&&x?T=b:E?T=!0:x?T=!1:T=m>v;let A=T?-1:1;s.fillStyle="rgba(255, 255, 255, 0.85)";let C=M=>{let I=Math.sin(M*4321+h*8765)*1e4;return I-Math.floor(I)-.5},R=Math.max(0,Math.min(1,r/.25));if(R>0){s.globalAlpha=R*.9;let M=d+A*a*.25+C(1)*a*.03,I=c-a*.1+C(2)*a*.02;s.beginPath(),s.arc(M,I,Math.min(a*.07,7)*R,0,Math.PI*2),s.fill()}let L=Math.max(0,Math.min(1,(r-.15)/.25));if(L>0){s.globalAlpha=L*.9;let M=d+A*a*.45+C(3)*a*.04,I=c-a*.35+C(4)*a*.03;s.beginPath(),s.arc(M,I,Math.min(a*.1,10)*L,0,Math.PI*2),s.fill()}let k=Math.max(0,Math.min(1,(r-.3)/.4));k>0&&Un(s,e,d,c,T,A,k,h,p),s.globalAlpha=1}function Un(s,e,t,n,o,i,a,l,r){let{tileSize:h,hoverAnimProgress:u}=e,d=u;s.globalAlpha=a*.88;let{fontSize:c,lines:p}=r,g=c*1.3,m=Math.min(h*.4,24),f=r.width,v=r.height,E=o?t-h*.5-f:t+h*.5,x=n-Math.min(h*.6,36)-v,w=E+f/2,y=x+v/2,b=v*.12,T=E-b,A=E+f+b,C=x-b,R=x+v+b*.4,L=A-T,k=R-C,M=h*.03,I=N=>{let j=Math.sin(N*1234+l*5678)*1e4;return(j-Math.floor(j)-.5)*2*M},P=[{x:.15,y:1,r:.18},{x:.35,y:1.05,r:.15},{x:.55,y:1,r:.17},{x:.78,y:1.02,r:.14},{x:1,y:.85,r:.16},{x:1.05,y:.6,r:.18},{x:1.02,y:.35,r:.15},{x:.85,y:.05,r:.2},{x:.6,y:-.05,r:.22},{x:.35,y:0,r:.2},{x:.12,y:.08,r:.18},{x:-.03,y:.3,r:.16},{x:-.05,y:.55,r:.18},{x:0,y:.8,r:.15}];s.beginPath();let O=P[0],D=P[P.length-1],S=(P.length-1)*3+12,$=T+(O.x+D.x)/2*L+I(S),ee=C+(O.y+D.y)/2*k+I(S+1);s.moveTo($,ee);for(let N=0;N<P.length;N++){let j=P[N],Y=P[(N+1)%P.length],te=T+(j.x+Y.x)/2*L+I(N*3+12),Z=C+(j.y+Y.y)/2*k+I(N*3+13);s.quadraticCurveTo(T+j.x*L+I(N*3+14),C+j.y*k+I(N*3+15),te,Z)}s.closePath();let G=s.createLinearGradient(w,C,w,R);G.addColorStop(0,"rgba(255, 255, 255, 0.95)"),G.addColorStop(1,"rgba(230, 235, 240, 0.9)"),s.fillStyle=G,s.fill(),s.strokeStyle="rgba(100, 120, 150, 0.25)",s.lineWidth=1.5,s.stroke();let ne=1;if(ne>0){s.globalAlpha=a*ne,s.fillStyle="#657586",s.font=`${c}px Schoolbell, cursive`,s.textAlign="center",s.textBaseline="middle";let N=te=>{let Z=Math.sin(te*9999+l*7777)*1e4;return Z-Math.floor(Z)},Y=y-(p.length-1)*g/2;for(let te=0;te<p.length;te++){let Z=p[te],fe=Y+te*g,ie=c*.045,F=s.measureText(Z).width,ae=ie*(Z.length-1),ce=F+ae,Ae=w-ce/2,He=Z.indexOf("THIS"),tn=He+4;for(let Ie=0;Ie<Z.length;Ie++){let Nt=Z[Ie],sn=He!==-1&&Ie>=He&&Ie<tn;s.font=sn?`bold italic ${c}px Schoolbell, cursive`:`${c}px Schoolbell, cursive`;let qt=s.measureText(Nt).width,mt=te*100+Ie,nn=(N(mt)-.5)*1.2,on=(N(mt+1e3)-.5)*1.2,an=(N(mt+2e3)-.5)*.08;s.save(),s.translate(Ae+qt/2+nn,fe+on),s.rotate(an),s.fillText(Nt,0,0),s.restore(),Ae+=qt+c*.045}}}}function us(s){let e=Math.sin(s*12.9898+s*78.233)*43758.5453;return e-Math.floor(e)}function oe(s,e,t,n=0){let o=s*100+e*7+n,i=s*100+e*13+50+n;return{x:(us(o)-.5)*t*2,y:(us(i)-.5)*t*2}}function ps(s,e,t){return[{x:t,y:t},{x:s/3,y:t},{x:2*s/3,y:t},{x:s-t,y:t},{x:s-t,y:e/2},{x:s-t,y:e-t},{x:2*s/3,y:e-t},{x:s/3,y:e-t},{x:t,y:e-t},{x:t,y:e/2}]}function Xn(s,e,t){let n={x:s/2,y:t},o={x:t,y:e-t},i={x:s-t,y:e-t};return[n,{x:(n.x+i.x)/2,y:(n.y+i.y)/2},i,{x:s*.65,y:e-t},{x:s*.35,y:e-t},o,{x:(n.x+o.x)/2,y:(n.y+o.y)/2}]}function Vn(s,e,t){let n={x:s/2,y:e-t},o={x:t,y:t},i={x:s-t,y:t};return[o,{x:s*.35,y:t},{x:s*.65,y:t},i,{x:(n.x+i.x)/2,y:(n.y+i.y)/2},n,{x:(n.x+o.x)/2,y:(n.y+o.y)/2}]}function Q(s,e,t,n){let{fillColor:o,padding:i=4,jitter:a=2,jitterMultiplier:l=1,seedOffset:r=0,frame:h=H(),dpr:u=window.devicePixelRatio||1,shape:d="rect"}=n,c=i*u,p;d==="triangle-up"?p=Xn(e,t,c):d==="triangle-down"?p=Vn(e,t,c):p=ps(e,t,c);let g=p.map((m,f)=>{let v=oe(f,h,a,r);return{x:m.x+v.x*l*u,y:m.y+v.y*l*u}});s.beginPath(),s.moveTo(g[0].x,g[0].y);for(let m=1;m<g.length;m++)s.lineTo(g[m].x,g[m].y);s.closePath(),s.fillStyle=o,s.fill()}function fs(s,e,t){let{padding:n=4,jitter:o=2,seedOffset:i=0,frame:a=H()}=t;return`polygon(${ps(s,e,n).map((u,d)=>{let c=oe(d,a,o,i);return{x:u.x+c.x,y:u.y+c.y}}).map(u=>`${(u.x/s*100).toFixed(2)}% ${(u.y/e*100).toFixed(2)}%`).join(", ")})`}var St=class{callbacks=new Set;animId=null;running=!1;lastFrame=-1;register(e){return this.callbacks.add(e),this.running||this.start(),()=>{this.callbacks.delete(e),this.callbacks.size===0&&this.stop()}}start(){if(this.running)return;this.running=!0;let e=()=>{if(!this.running)return;let t=H();if(t!==this.lastFrame){this.lastFrame=t;for(let n of this.callbacks)n()}this.animId=requestAnimationFrame(e)};this.animId=requestAnimationFrame(e)}stop(){this.running=!1,this.animId!==null&&(cancelAnimationFrame(this.animId),this.animId=null)}},he=new St;var Jn=0,_=class{canvas;ctx;text;onClick;isHovered=!1;isDisabled=!1;isPressed=!1;pressedFrame=0;lastTouchTime=0;inverted;fillColor;hoverFillColor;textColor;hoverTextColor;seedOffset;shape;drawContent;dpr;disablePressEffect;fontSize;JITTER=1.2;PRESSED_JITTER_MULT=5;constructor(e,t){this.text=t.text,this.onClick=t.onClick,this.inverted=t.inverted??!1,this.fillColor=t.fillColor??null,this.hoverFillColor=t.hoverFillColor??null,this.textColor=t.textColor??null,this.hoverTextColor=t.hoverTextColor??null,this.seedOffset=t.seedOffset??Jn++*1e3,this.shape=t.shape??"rect",this.drawContent=t.drawContent??null,this.dpr=window.devicePixelRatio||1,this.disablePressEffect=t.disablePressEffect??!1,this.fontSize=t.fontSize??20,this.canvas=document.createElement("canvas"),this.canvas.style.cursor="pointer",this.ctx=this.canvas.getContext("2d");let n=t.width??120,o=t.height??44,i=this.dpr;this.canvas.width=n*i,this.canvas.height=o*i,this.canvas.style.width=`${n}px`,this.canvas.style.height=`${o}px`,this.canvas.addEventListener("mouseenter",()=>{Date.now()-this.lastTouchTime<500||this.isDisabled||(this.isHovered=!0,this.render())}),this.canvas.addEventListener("mouseleave",()=>{this.isHovered=!1,this.isPressed=!1,this.render()}),this.canvas.addEventListener("click",a=>{this.isDisabled||(a.preventDefault(),this.onClick())}),this.canvas.addEventListener("mousedown",()=>{this.isDisabled||(this.isPressed=!0,this.pressedFrame=H(),this.render())}),this.canvas.addEventListener("mouseup",()=>{this.isPressed=!1,this.render()}),this.canvas.addEventListener("touchstart",()=>{this.isDisabled||(this.isPressed=!0,this.pressedFrame=H(),this.render())}),this.canvas.addEventListener("touchend",()=>{this.isPressed=!1,this.isHovered=!1,this.lastTouchTime=Date.now(),this.render()}),e.appendChild(this.canvas),this.render(),this.startAnimation()}unregisterAnim=null;startAnimation(){this.unregisterAnim=he.register(()=>this.render())}render(){let e=this.ctx,t=this.dpr,n=this.canvas.width,o=this.canvas.height,i=(window.devicePixelRatio||1)/this.dpr;e.clearRect(0,0,n,o),this.isDisabled&&(e.globalAlpha=.4);let a=this.isPressed&&!this.disablePressEffect?this.pressedFrame:H(),l=this.isPressed&&!this.disablePressEffect?this.PRESSED_JITTER_MULT:1,r;this.isPressed&&this.hoverFillColor?r=this.hoverFillColor:this.isPressed?r="#f1c40f":this.isHovered&&this.hoverFillColor?r=this.hoverFillColor:this.isHovered?r="#f1c40f":this.fillColor?r=this.fillColor:this.inverted?r="#000000":r="#ffffff",Q(e,n,o,{fillColor:r,jitter:this.JITTER/i,jitterMultiplier:l,seedOffset:this.seedOffset,frame:a,dpr:t,shape:this.shape});let h=this.textColor??(this.inverted||this.fillColor?"#ffffff":"#000000"),u=(this.isHovered||this.isPressed)&&this.hoverTextColor?this.hoverTextColor:h,d=oe(99,a,this.JITTER/i,this.seedOffset),c=this.isPressed&&!this.disablePressEffect?3*t:0;if(this.drawContent)this.drawContent(e,n,o,t,u,d.x*.5,d.y*.5,c);else{let p=this.fontSize*t;e.font=`${p}px Schoolbell, cursive`,e.textAlign="center",e.textBaseline="middle",e.fillStyle=u,e.fillText(this.text,n/2+d.x*.5+c,o/2+2*t+d.y*.5+c)}e.globalAlpha=1}setText(e){this.text=e,this.render()}setDisabled(e){this.isDisabled=e,this.canvas.style.cursor=e?"not-allowed":"pointer",this.render()}setTooltip(e){this.canvas.title=e??""}destroy(){this.unregisterAnim?.(),this.canvas.remove()}};var ye="/api";function Kn(){if(crypto.randomUUID)return crypto.randomUUID().slice(0,16);let s=new Uint8Array(8);return crypto.getRandomValues(s),Array.from(s,e=>e.toString(16).padStart(2,"0")).join("")}function Me(){let s=localStorage.getItem("fencing_player_id");return s||(s=Kn(),localStorage.setItem("fencing_player_id",s)),s}async function ms(s,e,t){let n=await fetch(`${ye}/levels/${s}/submit`,{method:"POST",headers:{"Content-Type":"application/json","x-player-id":Me()},body:JSON.stringify({walls:e,name:t})});if(!n.ok){let o=await n.json();throw new Error(o.error||"Failed to submit")}return n.json()}async function Mt(s){let e=await fetch(`${ye}/levels/${s}/stats`,{headers:{"x-player-id":Me()}});if(!e.ok){let t=await e.json();throw new Error(t.error||"Failed to get stats")}return e.json()}async function gs(s){let e=await fetch(`${ye}/levels/submission/${s}`);if(!e.ok){let t=await e.json();throw new Error(t.error||"Failed to get submission")}return e.json()}async function tt(s){let e=await fetch(`${ye}/player/name`,{method:"PATCH",headers:{"Content-Type":"application/json","x-player-id":Me()},body:JSON.stringify({name:s})});if(!e.ok){let t=await e.json();throw new Error(t.error||"Failed to update name")}localStorage.setItem("enclose_name",s)}async function vs(s,e){let t=await fetch(`${ye}/community/levels/${s}/vote`,{method:"POST",headers:{"Content-Type":"application/json","x-player-id":Me()},body:JSON.stringify({vote:e})});if(!t.ok){let n=await t.json();throw new Error(n.error||"Failed to vote")}return t.json()}async function bs(s){let e=await fetch(`${ye}/community/levels/${s}/status`,{headers:{"x-player-id":Me()}});if(!e.ok){let t=await e.json();throw new Error(t.error||"Failed to get status")}return e.json()}async function ys(s,e){let t=await fetch(`${ye}/community/levels/${s}/report`,{method:"POST",headers:{"Content-Type":"application/json","x-player-id":Me()},body:JSON.stringify({reason:e})});if(!t.ok){let n=await t.json();throw new Error(n.error||"Failed to report level")}}async function ws(s,e){let t=await fetch(`${ye}/levels/recover`,{method:"POST",headers:{"Content-Type":"application/json","x-player-id":Me()},body:JSON.stringify({submissions:s,name:e})});if(!t.ok){let n=await t.json();throw new Error(n.error||"Failed to recover submissions")}return t.json()}var Rt=new Set;function ke(){return localStorage.getItem("enclose_name")||""}function st(s){s?localStorage.setItem("enclose_name",s):localStorage.removeItem("enclose_name"),Rt.forEach(e=>e(s))}function xs(s){return Rt.add(s),()=>Rt.delete(s)}var Es=["\u{1F346}","\u{1F525}","\u{1F4A6}","\u{1F92C}","\u{1F916}","\u{1F434}"];function Cs(){return Es[Math.floor(Math.random()*Es.length)]}var Zn=.15;function nt(){let s=localStorage.getItem("enclose_grid_opacity");return s!==null?parseFloat(s):Zn}function Qn(s){localStorage.setItem("enclose_grid_opacity",String(s))}var Ss=null;function Ms(s){Ss=s}function Ot(){return localStorage.getItem("enclose_dark_gridlines")==="true"}function ei(s){localStorage.setItem("enclose_dark_gridlines",String(s))}var Rs=null;function Ls(s){Rs=s}function kt(){return localStorage.getItem("enclose_portal_labels")==="true"}function ti(s){localStorage.setItem("enclose_portal_labels",String(s))}var As=null;function Is(s){As=s}function Pt(){return localStorage.getItem("enclose_hide_horse_thoughts")==="true"}function si(s){localStorage.setItem("enclose_hide_horse_thoughts",String(s))}var Bs=null;function Os(s){Bs=s}function _t(){return localStorage.getItem("enclose_optimal_overlay")==="true"}function ni(s){localStorage.setItem("enclose_optimal_overlay",String(s))}var ks=null;function Ps(s){ks=s}function Lt(s){localStorage.setItem("enclose_show_advanced_settings",String(s))}function At(){return parseInt(localStorage.getItem("enclose_advanced_gate_stage")||"0")}function Ts(s){localStorage.setItem("enclose_advanced_gate_stage",String(s)),localStorage.setItem(`enclose_gate_stage_${s}_time`,new Date().toISOString())}function It(){let s=localStorage.getItem("enclose_gate_sleep_until");return s?new Date(s):null}function Bt(s){s?localStorage.setItem("enclose_gate_sleep_until",s.toISOString()):localStorage.removeItem("enclose_gate_sleep_until")}var Ge=class{menuOverlay;settingsOverlay;aboutOverlay;settingsCanvas=null;settingsCtx=null;aboutCanvas=null;aboutCtx=null;closeCanvas=null;closeCtx=null;aboutCloseCanvas=null;aboutCloseCtx=null;unregisterAnim=null;isSettingsVisible=!1;isAboutVisible=!1;aboutActiveTab="about";aboutTabCanvases=new Map;aboutMaxContentHeight=0;settingsActiveTab="general";settingsTabCanvases=new Map;settingsResizeObserver=null;aboutResizeObserver=null;menuButtons=[];options;gateOverlay=null;gateCanvas=null;gateCtx=null;gateCloseCanvas=null;gateCloseCtx=null;isGateVisible=!1;reEnableButton=null;gateClicksRemaining=0;gateButtonStep=0;constructor(e,t={}){this.options=t,this.menuOverlay=document.createElement("div"),this.menuOverlay.className="menu-overlay",this.menuOverlay.id="menuOverlay",this.menuOverlay.style.cssText="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;",e.appendChild(this.menuOverlay),this.settingsOverlay=document.createElement("div"),this.settingsOverlay.className="modal-overlay",this.settingsOverlay.id="settingsOverlay",e.appendChild(this.settingsOverlay),this.aboutOverlay=document.createElement("div"),this.aboutOverlay.className="modal-overlay",this.aboutOverlay.id="aboutOverlay",e.appendChild(this.aboutOverlay),this.gateOverlay=document.createElement("div"),this.gateOverlay.className="modal-overlay",this.gateOverlay.id="gateOverlay",e.appendChild(this.gateOverlay),this.render(t),this.setupEvents(),this.settingsOverlay.style.opacity="0",this.settingsOverlay.style.pointerEvents="none",this.settingsOverlay.classList.add("visible"),this.aboutOverlay.style.opacity="0",this.aboutOverlay.style.pointerEvents="none",this.aboutOverlay.classList.add("visible"),requestAnimationFrame(()=>{this.setupSettingsCanvas(),this.renderSettingsCanvas(),this.setupAboutCanvas(),this.renderAboutCanvas(),this.settingsOverlay.classList.remove("visible"),this.settingsOverlay.style.opacity="",this.settingsOverlay.style.pointerEvents="",this.aboutOverlay.classList.remove("visible"),this.aboutOverlay.style.opacity="",this.aboutOverlay.style.pointerEvents="",this.startAnimation()})}render(e){this.menuOverlay.innerHTML=`
            <div class="floating-menu" style="position: absolute; top: 56px; right: 16px; display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
            </div>
        `;let t=this.menuOverlay.querySelector(".floating-menu");if(e.onShowPastPuzzles){let c=new _(t,{text:"Past Puzzles",onClick:()=>{this.hideMenu(),e.onShowPastPuzzles()},width:140,height:44,seedOffset:3050});this.menuButtons.push(c)}let n=new _(t,{text:"Create Level",onClick:()=>{window.location.href="/edit"},width:140,height:44,seedOffset:3100});this.menuButtons.push(n);let o=new _(t,{text:"Browse",onClick:()=>{window.location.href="/levels"},width:140,height:44,seedOffset:3025});this.menuButtons.push(o);let i=new _(t,{text:"About",onClick:()=>{this.hideMenu(),this.showAbout()},width:140,height:44,seedOffset:3300});this.menuButtons.push(i);let a=new _(t,{text:"Settings",onClick:()=>{this.hideMenu(),this.showSettings()},width:140,height:44,seedOffset:3350});this.menuButtons.push(a);let l=ke();this.settingsOverlay.innerHTML=`
            <style>
                #chkAnimations, #chkDarkGridlines, #chkPortalLabels, #chkHideHorseThoughts, #chkOptimalOverlay, #chkShowAdvanced {
                    -webkit-appearance: none;
                    appearance: none;
                    width: 18px;
                    height: 18px;
                    border: 2px solid #999;
                    background: #fff;
                    cursor: pointer;
                    position: relative;
                }
                #chkAnimations:checked, #chkDarkGridlines:checked, #chkPortalLabels:checked, #chkHideHorseThoughts:checked, #chkOptimalOverlay:checked, #chkShowAdvanced:checked {
                    background: #d4a017;
                    border-color: #d4a017;
                }
                #chkAnimations:checked::after, #chkDarkGridlines:checked::after, #chkPortalLabels:checked::after, #chkHideHorseThoughts:checked::after, #chkOptimalOverlay:checked::after, #chkShowAdvanced:checked::after {
                    content: '';
                    position: absolute;
                    left: 50%;
                    top: 50%;
                    width: 5px;
                    height: 10px;
                    border: solid #fff;
                    border-width: 0 2px 2px 0;
                    transform: translate(-50%, -60%) rotate(45deg);
                }
                .settings-select-wrapper {
                    position: relative;
                    display: block;
                }
                .settings-select-wrapper::after {
                    content: '\u2039';
                    font-family: 'Schoolbell', cursive;
                    font-size: 18px;
                    color: #000;
                    position: absolute;
                    right: 12px;
                    top: 50%;
                    transform: translateY(-50%) rotate(-90deg);
                    pointer-events: none;
                }
                #themeSelect {
                    width: 100%;
                    padding: 10px 32px 10px 12px;
                    font-size: 16px;
                    font-family: 'Schoolbell', cursive;
                    border: none;
                    border-radius: 0;
                    box-sizing: border-box;
                    background: #e8e8e8;
                    outline: none;
                    cursor: pointer;
                    -webkit-appearance: none;
                    appearance: none;
                }
                #gridOpacitySlider {
                    -webkit-appearance: none;
                    appearance: none;
                    background: #999;
                    height: 1px;
                    border-radius: 0;
                }
                #gridOpacitySlider::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    appearance: none;
                    width: 18px;
                    height: 18px;
                    background: #444;
                    border-radius: 0;
                    cursor: pointer;
                    border: none;
                    box-shadow: none;
                }
                #gridOpacitySlider::-moz-range-thumb {
                    width: 18px;
                    height: 18px;
                    background: #444;
                    border-radius: 0;
                    cursor: pointer;
                    border: none;
                    box-shadow: none;
                }
            </style>
            <div style="display: flex; flex-direction: column; align-items: center;">
                <canvas id="settingsClose" style="align-self: flex-end; cursor: pointer; margin-bottom: -6px;" width="40" height="40"></canvas>
                <div class="wiggly-modal" style="position: relative; width: 340px; max-height: calc(100vh - 100px); display: flex; flex-direction: column;">
                    <canvas class="wiggly-modal-bg" style="display: block; position: absolute; top: 0; left: 0; z-index: 0;"></canvas>
                    <div class="wiggly-modal-scroll" style="overflow-y: auto; margin: 12px; margin-right: 14px; flex: 1; min-height: 0; position: relative; z-index: 2;">
                        <div class="wiggly-modal-content" style="position: relative; z-index: 1; padding: 20px; color: #000; font-family: 'Schoolbell', cursive;">
                            <h2 style="font-size: 24px; margin-bottom: 20px; font-family: 'Schoolbell', cursive; color: #000;">Settings</h2>
                            <div class="settings-modal-tabs" style="display: none; margin-bottom: 16px;">
                                <div class="settings-tab-wrapper" style="flex: 1; position: relative;">
                                    <canvas class="settings-tab-bg" data-tab="general" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                                    <button class="settings-modal-tab" data-tab="general" style="position: relative; z-index: 1; width: 100%; padding: 10px 16px; background: none; border: none; color: #000; font-size: 16px; font-family: 'Schoolbell', cursive; cursor: pointer;">General</button>
                                </div>
                                <div class="settings-tab-wrapper" style="flex: 1; position: relative; display: none;">
                                    <canvas class="settings-tab-bg" data-tab="advanced" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                                    <button class="settings-modal-tab" data-tab="advanced" style="position: relative; z-index: 1; width: 100%; padding: 10px 16px; background: none; border: none; color: #000; font-size: 16px; font-family: 'Schoolbell', cursive; cursor: pointer;">Advanced</button>
                                </div>
                            </div>

                            <div class="settings-tab-content" id="settings-tab-general" style="display: block;">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-size: 16px; color: #333; margin-bottom: 8px;">Your Name</label>
                                    <input type="text" id="settingsName" value="${l}" placeholder="Anonymous"
                                        style="width: 100%; padding: 10px 12px; font-size: 16px; font-family: 'Schoolbell', cursive; border: none; border-radius: 0; box-sizing: border-box; background: #e8e8e8; outline: none;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                                        <span style="font-size: 13px; color: #666;">Shown on leaderboards</span>
                                        <span id="nameSavedIndicator" style="font-size: 13px; color: #27ae60; opacity: 0; transition: opacity 0.2s;">Saved \u2713</span>
                                    </div>
                                </div>

                                <label style="display: flex; align-items: center; gap: 12px; font-size: 16px; color: #333; cursor: pointer; padding: 8px 0;" title="Toggle idle animations">
                                    <input type="checkbox" id="chkAnimations" ${Xt()?"checked":""} style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>Personality</span>
                                </label>

                                <label style="display: flex; align-items: center; gap: 12px; font-size: 16px; color: #333; cursor: pointer; padding: 8px 0; margin-top: 8px;">
                                    <input type="checkbox" id="chkDarkGridlines" ${Ot()?"checked":""} style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>Dark grid lines</span>
                                </label>

                                <label style="display: flex; align-items: center; gap: 12px; font-size: 16px; color: #333; cursor: pointer; padding: 8px 0; margin-top: 8px;">
                                    <input type="checkbox" id="chkPortalLabels" ${kt()?"checked":""} style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>Portal labels</span>
                                </label>

                                <label style="display: flex; align-items: center; gap: 12px; font-size: 16px; color: #333; cursor: pointer; padding: 8px 0; margin-top: 8px;">
                                    <input type="checkbox" id="chkHideHorseThoughts" ${Pt()?"checked":""} style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>Hide horse thoughts</span>
                                </label>

                                <label style="display: flex; align-items: center; gap: 12px; font-size: 16px; color: #333; cursor: pointer; padding: 8px 0; margin-top: 8px;" title="When viewing the optimal solution after submitting a daily, show it as a transparent overlay on top of your solution instead of replacing your walls.">
                                    <input type="checkbox" id="chkOptimalOverlay" ${_t()?"checked":""} style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>Optimal as overlay</span>
                                </label>

                                <div style="margin-top: 16px;">
                                    <label style="display: block; font-size: 16px; color: #333; margin-bottom: 8px;">Grid Lines</label>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <input type="range" id="gridOpacitySlider" min="0" max="100" value="${Math.round(nt()*100)}"
                                            style="flex: 1; cursor: pointer;">
                                        <span id="gridOpacityValue" style="font-size: 14px; color: #666; min-width: 36px; text-align: right;">${Math.round(nt()*100)}%</span>
                                    </div>
                                </div>

                                <div style="margin-top: 16px;">
                                    <label style="display: block; font-size: 16px; color: #333; margin-bottom: 8px;">Theme</label>
                                    <span class="settings-select-wrapper">
                                        <select id="themeSelect">
                                            ${vt.map(c=>{let p={default:"Default",classic:"Classic",girl:"Girl???",hot:"Hot"};return`<option value="${c}" ${c===bt()?"selected":""}>${p[c]||c}</option>`}).join("")}
                                        </select>
                                    </span>
                                </div>

                                <div id="reEnableContainer" style="display: none; margin-top: 24px; text-align: center; min-height: 80px; max-width: 100%; overflow: hidden;"></div>
                            </div>

                            <div class="settings-tab-content" id="settings-tab-advanced" style="display: none;">
                                <label style="display: flex; align-items: center; gap: 12px; font-size: 16px; color: #333; cursor: pointer; padding: 8px 0;">
                                    <input type="checkbox" id="chkShowAdvanced" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>Show advanced settings</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,this.settingsCanvas=this.settingsOverlay.querySelector(".wiggly-modal-bg"),this.settingsCtx=this.settingsCanvas?.getContext("2d")||null,this.closeCanvas=this.settingsOverlay.querySelector("#settingsClose"),this.closeCtx=this.closeCanvas?.getContext("2d")||null,this.settingsTabCanvases.clear(),this.settingsOverlay.querySelectorAll(".settings-tab-bg").forEach(c=>{let p=c.getAttribute("data-tab");p&&this.settingsTabCanvases.set(p,c)});let h=this.settingsOverlay.querySelector(".wiggly-modal");h&&(this.settingsResizeObserver=new ResizeObserver(()=>{this.isSettingsVisible&&(this.setupSettingsCanvas(),this.renderSettingsCanvas())}),this.settingsResizeObserver.observe(h)),this.aboutOverlay.innerHTML=`
            <div style="display: flex; flex-direction: column; align-items: center;">
                <canvas id="aboutClose" style="align-self: flex-end; cursor: pointer; margin-bottom: -6px;" width="40" height="40"></canvas>
                <div class="wiggly-modal" style="position: relative; width: 400px; max-width: calc(100vw - 32px); max-height: calc(100vh - 100px); display: flex; flex-direction: column;">
                    <canvas class="wiggly-modal-bg" style="display: block; position: absolute; top: 0; left: 0; z-index: 0;"></canvas>
                    <div class="wiggly-modal-scroll" style="overflow-y: auto; margin: 12px; margin-right: 14px; flex: 1; min-height: 0; position: relative; z-index: 2;">
                        <div class="wiggly-modal-content" style="position: relative; z-index: 1; padding: 20px; color: #000; font-family: 'Schoolbell', cursive;">
                            <div class="about-modal-tabs" style="display: flex; margin-bottom: 16px;">
                                <div class="about-tab-wrapper" style="flex: 1; position: relative;">
                                    <canvas class="about-tab-bg" data-tab="about" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                                    <button class="about-modal-tab" data-tab="about" style="position: relative; z-index: 1; width: 100%; padding: 10px 16px; background: none; border: none; color: #000; font-size: 16px; font-family: 'Schoolbell', cursive; cursor: pointer;">About</button>
                                </div>
                                <div class="about-tab-wrapper" style="flex: 1; position: relative;">
                                    <canvas class="about-tab-bg" data-tab="updates" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                                    <button class="about-modal-tab" data-tab="updates" style="position: relative; z-index: 1; width: 100%; padding: 10px 16px; background: none; border: none; color: #000; font-size: 16px; font-family: 'Schoolbell', cursive; cursor: pointer;">Updates</button>
                                </div>
                            </div>

                            <div class="about-tab-content" id="about-tab-about" style="display: block;">
                                <p style="font-size: 18px; line-height: 1.5; margin-bottom: 16px;">
                                    Enclose.horse is a simple puzzle game about enclosing the maximum area with a limited number of walls.
                                </p>

                                <p style="font-size: 18px; line-height: 1.5; margin-bottom: 16px;">
                                    I originally conceived this as an interesting Leetcode/Advent of Code optimization problem. But then, after playing around with it, it seemed interesting enough to develop into fully-fledged game.
                                </p>

                                <p style="font-size: 18px; line-height: 1.5; margin-bottom: 16px;">
                                    Have fun!
                                </p>

                                <p style="font-size: 16px; color: #666; margin-top: 24px;">
                                    Made with <span id="aboutEmoji">${Cs()}</span> by <a href="https://x.com/thinkingshivers" target="_blank" style="color: #666;">Shivers</a>
                                </p>
                            </div>

                            <div class="about-tab-content" id="about-tab-updates" style="display: none;">
                                <div style="font-size: 16px; line-height: 1.6;">
                                    <div style="margin-bottom: 20px;">
                                        <div style="font-weight: bold; color: #000; margin-bottom: 6px;">Jan 6, 2026</div>
                                        <ul style="margin: 0; padding-left: 20px; color: #444;">
                                            <li>Added portals</li>
                                        </ul>
                                    </div>

                                    <div style="margin-bottom: 20px;">
                                        <div style="font-weight: bold; color: #000; margin-bottom: 6px;">Jan 4, 2026</div>
                                        <ul style="margin: 0; padding-left: 20px; color: #444;">
                                            <li>Additional search filters</li>
                                            <li>Fixed cherry bug.</li>
                                        </ul>
                                    </div>

                                    <div style="margin-bottom: 20px;">
                                        <div style="font-weight: bold; color: #000; margin-bottom: 6px;">Jan 3, 2026</div>
                                        <ul style="margin: 0; padding-left: 20px; color: #444;">
                                            <li>Added cherries</li>
                                        </ul>
                                    </div>

                                    <div style="margin-bottom: 20px;">
                                        <div style="font-weight: bold; color: #000; margin-bottom: 6px;">Jan 2, 2026</div>
                                        <ul style="margin: 0; padding-left: 20px; color: #444;">
                                            <li>Tracks your best area while you play</li>
                                        </ul>
                                    </div>

                                    <div style="margin-bottom: 20px;">
                                        <div style="font-weight: bold; color: #000; margin-bottom: 6px;">Jan 1, 2026</div>
                                        <ul style="margin: 0; padding-left: 20px; color: #444;">
                                            <li>Solver in level editor</li>
                                            <li>"Browse" page for exploring levels created by other players</li>
                                            <li>Vote on levels after playing</li>
                                        </ul>
                                    </div>

                                    <div style="margin-bottom: 20px;">
                                        <div style="font-weight: bold; color: #000; margin-bottom: 6px;">Dec 31, 2025</div>
                                        <ul style="margin: 0; padding-left: 20px; color: #444;">
                                            <li>Added updates tab to about modal</li>
                                        </ul>
                                    </div>

                                    <div style="margin-bottom: 20px;">
                                        <div style="font-weight: bold; color: #000; margin-bottom: 6px;">Dec 30, 2025</div>
                                        <ul style="margin: 0; padding-left: 20px; color: #444;">
                                            <li>Daily puzzles launched!</li>
                                            <li>Added Past Puzzles modal</li>
                                            <li>Score histogram on results</li>
                                        </ul>
                                    </div>

                                    <div style="margin-bottom: 20px;">
                                        <div style="font-weight: bold; color: #000; margin-bottom: 6px;">Dec 29, 2025</div>
                                        <ul style="margin: 0; padding-left: 20px; color: #444;">
                                            <li>Initial release</li>
                                            <li>Level editor</li>
                                            <li>Leaderboards</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,this.aboutCanvas=this.aboutOverlay.querySelector(".wiggly-modal-bg"),this.aboutCtx=this.aboutCanvas?.getContext("2d")||null,this.aboutCloseCanvas=this.aboutOverlay.querySelector("#aboutClose"),this.aboutCloseCtx=this.aboutCloseCanvas?.getContext("2d")||null,this.aboutTabCanvases.clear(),this.aboutOverlay.querySelectorAll(".about-tab-bg").forEach(c=>{let p=c.getAttribute("data-tab");p&&this.aboutTabCanvases.set(p,c)});let d=this.aboutOverlay.querySelector(".wiggly-modal");d&&(this.aboutResizeObserver=new ResizeObserver(()=>{this.isAboutVisible&&(this.setupAboutCanvas(),this.renderAboutCanvas())}),this.aboutResizeObserver.observe(d)),this.gateOverlay.innerHTML=`
            <div style="display: flex; flex-direction: column; align-items: center;">
                <canvas id="gateClose" style="align-self: flex-end; cursor: pointer; margin-bottom: -6px;" width="40" height="40"></canvas>
                <div class="wiggly-modal" style="position: relative; width: 300px; max-width: calc(100vw - 40px);">
                    <canvas class="wiggly-modal-bg" style="display: block; position: absolute; top: 0; left: 0; z-index: 0;"></canvas>
                    <div style="position: relative; z-index: 1; padding: 24px 28px; text-align: center;">
                        <p id="gateText" style="margin: 0 0 20px; font-size: 18px; color: #000; font-family: 'Schoolbell', cursive; line-height: 1.4;"></p>
                        <div id="gateButtons" style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;"></div>
                    </div>
                </div>
            </div>
        `,this.gateCanvas=this.gateOverlay.querySelector(".wiggly-modal-bg"),this.gateCtx=this.gateCanvas?.getContext("2d")||null,this.gateCloseCanvas=this.gateOverlay.querySelector("#gateClose"),this.gateCloseCtx=this.gateCloseCanvas?.getContext("2d")||null}setupEvents(){this.menuOverlay.addEventListener("click",b=>{b.target===this.menuOverlay&&this.hideMenu()}),this.settingsOverlay.querySelector("#settingsClose")?.addEventListener("click",()=>this.hideSettings()),this.settingsOverlay.addEventListener("click",b=>{b.target===this.settingsOverlay&&this.hideSettings()}),this.aboutOverlay.querySelector("#aboutClose")?.addEventListener("click",()=>this.hideAbout()),this.aboutOverlay.addEventListener("click",b=>{b.target===this.aboutOverlay&&this.hideAbout()}),this.gateOverlay.querySelector("#gateClose")?.addEventListener("click",()=>this.hideGateDialog()),this.gateOverlay.addEventListener("click",b=>{b.target===this.gateOverlay&&this.hideGateDialog()});let o=this.settingsOverlay.querySelectorAll(".settings-modal-tab"),i=this.settingsOverlay.querySelectorAll(".settings-tab-content");o.forEach(b=>{b.addEventListener("click",()=>{let T=b.getAttribute("data-tab");if(!T)return;this.settingsActiveTab=T,i.forEach(C=>{C.style.display="none"});let A=this.settingsOverlay.querySelector(`#settings-tab-${T}`);A&&(A.style.display="block"),this.renderSettingsTabCanvases()})});let a=this.aboutOverlay.querySelectorAll(".about-modal-tab"),l=this.aboutOverlay.querySelectorAll(".about-tab-content");a.forEach(b=>{b.addEventListener("click",()=>{let T=b.getAttribute("data-tab");if(!T)return;this.aboutActiveTab=T,l.forEach(C=>{C.style.display="none"});let A=this.aboutOverlay.querySelector(`#about-tab-${T}`);A&&(A.style.display="block"),this.renderAboutTabCanvases()})});let r=this.settingsOverlay.querySelector("#chkAnimations");r?.addEventListener("change",()=>{Vt(r.checked)});let h=this.settingsOverlay.querySelector("#gridOpacitySlider"),u=this.settingsOverlay.querySelector("#gridOpacityValue");h?.addEventListener("input",()=>{let b=parseInt(h.value)/100;u.textContent=`${h.value}%`,Qn(b),Ss?.(b)});let d=this.settingsOverlay.querySelector("#chkDarkGridlines");d?.addEventListener("change",()=>{ei(d.checked),Rs?.(d.checked)});let c=this.settingsOverlay.querySelector("#chkPortalLabels");c?.addEventListener("change",()=>{ti(c.checked),As?.(c.checked)});let p=this.settingsOverlay.querySelector("#chkHideHorseThoughts");p?.addEventListener("change",()=>{si(p.checked),Bs?.(p.checked)});let g=this.settingsOverlay.querySelector("#chkOptimalOverlay");g?.addEventListener("change",()=>{ni(g.checked),ks?.(g.checked)});let m=this.settingsOverlay.querySelector("#themeSelect");m?.addEventListener("change",()=>{let b=m.value;ts(b)});let f=this.settingsOverlay.querySelector("#chkShowAdvanced"),v=this.settingsOverlay.querySelector('.settings-tab-wrapper:has([data-tab="advanced"])');f?.addEventListener("change",()=>{if(!f.checked){Lt(!1),this.settingsActiveTab="general",this.settingsOverlay.querySelectorAll(".settings-tab-content").forEach(A=>A.style.display="none");let T=this.settingsOverlay.querySelector("#settings-tab-general");T&&(T.style.display="block"),v&&(v.style.display="none"),this.renderSettingsTabCanvases(),setTimeout(()=>{this.showReEnableButton()},1e3)}});let E=this.settingsOverlay.querySelector("#settingsName"),x=this.settingsOverlay.querySelector("#nameSavedIndicator"),w=null,y=null;E?.addEventListener("input",()=>{let b=E.value.trim();st(b),w&&clearTimeout(w),y&&clearTimeout(y),x&&(x.style.opacity="0"),w=window.setTimeout(async()=>{if(b&&/^[a-zA-Z0-9_]{1,20}$/.test(b))try{await tt(b),x&&(x.textContent="Saved \u2713",x.style.opacity="1")}catch{x&&(x.textContent="Error saving",x.style.opacity="1")}else b?x&&(x.textContent="Letters, numbers, _ only",x.style.opacity="1"):x&&(x.textContent="Saved \u2713",x.style.opacity="1");y=window.setTimeout(()=>{x&&(x.style.opacity="0")},2e3)},500)})}setupSettingsCanvas(){if(!this.settingsCanvas||!this.settingsCtx)return;let e=this.settingsOverlay.querySelector(".wiggly-modal");if(!e)return;let t=window.devicePixelRatio||1,n=e.offsetWidth,o=e.offsetHeight;this.settingsCanvas.width=n*t,this.settingsCanvas.height=o*t,this.settingsCanvas.style.width=`${n}px`,this.settingsCanvas.style.height=`${o}px`}renderSettingsCanvas(){if(!this.settingsCtx||!this.settingsCanvas)return;let e=this.settingsCanvas.width,t=this.settingsCanvas.height,n=window.devicePixelRatio||1;this.settingsCtx.clearRect(0,0,e,t),Q(this.settingsCtx,e,t,{fillColor:"#ffffff",padding:6,jitter:2.5,seedOffset:7e3,dpr:n}),this.renderSettingsTabCanvases(),this.renderCloseButton()}renderSettingsTabCanvases(){let e=window.devicePixelRatio||1;this.settingsTabCanvases.forEach((t,n)=>{let o=t.getContext("2d");if(!o)return;let i=t.parentElement;if(i){let a=i.offsetWidth,l=i.offsetHeight;t.width=a*e,t.height=l*e,t.style.width=`${a}px`,t.style.height=`${l}px`}o.clearRect(0,0,t.width,t.height),n===this.settingsActiveTab?Q(o,t.width,t.height,{fillColor:"#f1c40f",padding:3,jitter:1.5,seedOffset:7200+n.charCodeAt(0)*100,dpr:e}):Q(o,t.width,t.height,{fillColor:"#f0f0f0",padding:3,jitter:0,seedOffset:7200+n.charCodeAt(0)*100,dpr:e})})}renderCloseButton(){if(!this.closeCtx||!this.closeCanvas)return;let e=window.devicePixelRatio||1,t=40;this.closeCanvas.width=t*e,this.closeCanvas.height=t*e,this.closeCanvas.style.width=`${t}px`,this.closeCanvas.style.height=`${t}px`;let n=this.closeCtx;n.clearRect(0,0,this.closeCanvas.width,this.closeCanvas.height);let o=H(),i=oe(42,o,.8,9e3);n.font=`${36*e}px Schoolbell, cursive`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#ffffff",n.fillText("\xD7",t*e/2+i.x*e,t*e/2+i.y*e)}startAnimation(){this.unregisterAnim||(this.unregisterAnim=he.register(()=>{this.isSettingsVisible&&(this.setupSettingsCanvas(),this.renderSettingsCanvas()),this.isAboutVisible&&(this.setupAboutCanvas(),this.renderAboutCanvas()),this.isGateVisible&&(this.setupGateCanvas(),this.renderGateCanvas())}))}setupAboutCanvas(){if(!this.aboutCanvas||!this.aboutCtx)return;let e=this.aboutOverlay.querySelector(".wiggly-modal");if(!e)return;let t=window.devicePixelRatio||1,n=e.offsetWidth,o=e.offsetHeight;this.aboutCanvas.width=n*t,this.aboutCanvas.height=o*t,this.aboutCanvas.style.width=`${n}px`,this.aboutCanvas.style.height=`${o}px`}renderAboutCanvas(){if(!this.aboutCtx||!this.aboutCanvas)return;let e=this.aboutCanvas.width,t=this.aboutCanvas.height,n=window.devicePixelRatio||1;this.aboutCtx.clearRect(0,0,e,t),Q(this.aboutCtx,e,t,{fillColor:"#ffffff",padding:6,jitter:2.5,seedOffset:7500,dpr:n}),this.renderAboutTabCanvases(),this.renderAboutCloseButton()}renderAboutTabCanvases(){let e=window.devicePixelRatio||1;this.aboutTabCanvases.forEach((t,n)=>{let o=t.getContext("2d");if(!o)return;let i=t.parentElement;if(i){let a=i.offsetWidth,l=i.offsetHeight;t.width=a*e,t.height=l*e,t.style.width=`${a}px`,t.style.height=`${l}px`}o.clearRect(0,0,t.width,t.height),n===this.aboutActiveTab?Q(o,t.width,t.height,{fillColor:"#f1c40f",padding:3,jitter:1.5,seedOffset:8e3+n.charCodeAt(0)*100,dpr:e}):Q(o,t.width,t.height,{fillColor:"#f0f0f0",padding:3,jitter:0,seedOffset:8e3+n.charCodeAt(0)*100,dpr:e})})}renderAboutCloseButton(){if(!this.aboutCloseCtx||!this.aboutCloseCanvas)return;let e=window.devicePixelRatio||1,t=40;this.aboutCloseCanvas.width=t*e,this.aboutCloseCanvas.height=t*e,this.aboutCloseCanvas.style.width=`${t}px`,this.aboutCloseCanvas.style.height=`${t}px`;let n=this.aboutCloseCtx;n.clearRect(0,0,this.aboutCloseCanvas.width,this.aboutCloseCanvas.height);let o=H(),i=oe(42,o,.8,9500);n.font=`${36*e}px Schoolbell, cursive`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#ffffff",n.fillText("\xD7",t*e/2+i.x*e,t*e/2+i.y*e)}showMenu(){this.menuOverlay.style.display="block",this.menuOverlay.classList.add("visible"),this.options.onMenuShow?.()}hideMenu(){this.menuOverlay.style.display="none",this.menuOverlay.classList.remove("visible"),this.options.onMenuHide?.()}showSettings(){let e=this.settingsOverlay.querySelector("#settingsName");e&&(e.value=ke());let t=this.settingsOverlay.querySelector("#themeSelect");t&&(t.value=bt());let n=this.settingsOverlay.querySelector('.settings-tab-wrapper:has([data-tab="advanced"])');n&&(n.style.display="none"),this.hideReEnableButton();let o=At(),i=this.settingsOverlay.querySelector("#chkShowAdvanced"),a=this.settingsOverlay.querySelector("#settings-tab-advanced");if(o>=7){i&&(i.checked=!0,i.disabled=!0,i.title="Hi! I'm Tippy the Tooltip! I sure love being a tooltip and having you hover. I just don't know what would happen to me if you stopped hovering on that!",i.style.opacity="0.5",i.style.cursor="not-allowed");let h=i?.closest("label");h&&(h.style.opacity="0.5",h.style.cursor="not-allowed",h.title="Hi! I'm Tippy the Tooltip! I sure love being a tooltip and having you hover. I just don't know what would happen to me if you stopped hovering on that!")}else{i&&(i.disabled=!1,i.style.opacity="",i.style.cursor="");let h=i?.closest("label");h&&(h.style.opacity="",h.style.cursor="")}this.settingsActiveTab="general",this.settingsOverlay.querySelectorAll(".settings-tab-content").forEach(h=>h.style.display="none");let r=this.settingsOverlay.querySelector("#settings-tab-general");r&&(r.style.display="block"),this.isSettingsVisible=!0,this.settingsOverlay.classList.add("visible")}hideSettings(){this.isSettingsVisible=!1,this.settingsOverlay.classList.remove("visible")}showAbout(){let e=this.aboutOverlay.querySelector("#aboutEmoji");e&&(e.textContent=Cs()),this.aboutActiveTab="about",this.aboutOverlay.querySelectorAll(".about-tab-content").forEach(o=>o.style.display="none");let n=this.aboutOverlay.querySelector("#about-tab-about");n&&(n.style.display="block"),this.isAboutVisible=!0,this.aboutOverlay.classList.add("visible")}hideAbout(){this.isAboutVisible=!1,this.aboutOverlay.classList.remove("visible")}showReEnableButton(e="Show Advanced Settings"){let t=this.settingsOverlay.querySelector("#reEnableContainer");if(!t)return;let n=It();if(n&&Date.now()<n.getTime()){this.showSleepyButton();return}this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.sleepAnimInterval&&(clearInterval(this.sleepAnimInterval),this.sleepAnimInterval=null),t.innerHTML="",this.gateButtonStep=0,this.reEnableButton=new _(t,{text:e,onClick:()=>this.onReEnableClick(),width:280,height:80,seedOffset:5e3,inverted:!0,hoverTextColor:"#000000"}),t.style.display="block"}updateReEnableButton(e){let t=this.settingsOverlay.querySelector("#reEnableContainer");t&&(this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),t.innerHTML="",this.reEnableButton=new _(t,{text:e,onClick:()=>this.onReEnableClick(),width:280,height:80,seedOffset:5e3,inverted:!0,hoverTextColor:"#000000"}))}hideReEnableButton(){let e=this.settingsOverlay.querySelector("#reEnableContainer");e&&(e.style.display="none"),this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null)}choiceButtons=[];showChoiceButtons(){let e=this.settingsOverlay.querySelector("#reEnableContainer");if(!e)return;this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.choiceButtons.forEach(i=>i.destroy()),this.choiceButtons=[],e.innerHTML="";let t=document.createElement("div");t.style.cssText="display: flex; gap: 12px; justify-content: center;",e.appendChild(t);let n=new _(t,{text:"I won't",onClick:()=>this.completeReEnable(),width:130,height:80,seedOffset:5100,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(n);let o=new _(t,{text:"I'll hide them again",onClick:()=>this.onHideAgainChoice(),width:130,height:80,seedOffset:5200,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(o)}showStage1ChoiceButtons(){let e=this.settingsOverlay.querySelector("#reEnableContainer");if(!e)return;this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.choiceButtons.forEach(i=>i.destroy()),this.choiceButtons=[],e.innerHTML="";let t=document.createElement("div");t.style.cssText="display: flex; gap: 12px; justify-content: center;",e.appendChild(t);let n=new _(t,{text:"Right!",onClick:()=>this.onHideAgainChoice(),width:130,height:80,seedOffset:5100,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(n);let o=new _(t,{text:"No!",onClick:()=>{this.choiceButtons.forEach(i=>i.destroy()),this.choiceButtons=[],this.onReEnableClick()},width:130,height:80,seedOffset:5200,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(o)}showStage2ChoiceButtons(){let e=this.settingsOverlay.querySelector("#reEnableContainer");if(!e)return;this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.choiceButtons.forEach(i=>i.destroy()),this.choiceButtons=[],e.innerHTML="";let t=document.createElement("div");t.style.cssText="display: flex; gap: 12px; justify-content: center;",e.appendChild(t);let n=new _(t,{text:"I promise. <3",onClick:()=>{this.choiceButtons.forEach(i=>i.destroy()),this.choiceButtons=[],this.onReEnableClick()},width:130,height:80,seedOffset:5100,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(n);let o=new _(t,{text:"Silence, button!",onClick:()=>this.onHideAgainChoice(),width:130,height:80,seedOffset:5200,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(o)}showStage3ChoiceButtons(){let e=this.settingsOverlay.querySelector("#reEnableContainer");if(!e)return;this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.choiceButtons.forEach(i=>i.destroy()),this.choiceButtons=[],e.innerHTML="";let t=document.createElement("div");t.style.cssText="display: flex; gap: 12px; justify-content: center;",e.appendChild(t);let n=new _(t,{text:"5",onClick:()=>this.onHideAgainChoice(),width:130,height:80,seedOffset:5100,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(n);let o=new _(t,{text:"6",onClick:()=>{this.choiceButtons.forEach(i=>i.destroy()),this.choiceButtons=[],this.onReEnableClick()},width:130,height:80,seedOffset:5200,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(o)}showStage4ChoiceButtons(){let e=this.settingsOverlay.querySelector("#reEnableContainer");if(!e)return;this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.choiceButtons.forEach(i=>i.destroy()),this.choiceButtons=[],e.innerHTML="";let t=document.createElement("div");t.style.cssText="display: flex; gap: 12px; justify-content: center;",e.appendChild(t);let n=new _(t,{text:"Good choice",onClick:()=>{this.choiceButtons.forEach(i=>i.destroy()),this.choiceButtons=[],this.onReEnableClick()},width:130,height:80,seedOffset:5100,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(n);let o=new _(t,{text:"Bad choice",onClick:()=>this.onHideAgainChoice(),width:130,height:80,seedOffset:5200,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(o)}showStage5LeftRight(){let e=this.settingsOverlay.querySelector("#reEnableContainer");if(!e)return;this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.choiceButtons.forEach(a=>a.destroy()),this.choiceButtons=[],e.innerHTML="";let t=document.createElement("div");t.style.cssText="display: flex; gap: 12px; justify-content: center;",e.appendChild(t);let n=!0,o=new _(t,{text:"Left",onClick:()=>{this.choiceButtons.forEach(a=>a.destroy()),this.choiceButtons=[],n?this.onReEnableClick():this.onHideAgainChoice()},width:130,height:80,seedOffset:5100,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(o);let i=new _(t,{text:"Right",onClick:()=>{this.choiceButtons.forEach(a=>a.destroy()),this.choiceButtons=[],n?this.onHideAgainChoice():this.onReEnableClick()},width:130,height:80,seedOffset:5200,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(i)}showStage5UpDown(){let e=this.settingsOverlay.querySelector("#reEnableContainer");if(!e)return;this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.choiceButtons.forEach(a=>a.destroy()),this.choiceButtons=[],e.innerHTML="";let t=document.createElement("div");t.style.cssText="display: flex; gap: 12px; justify-content: center;",e.appendChild(t);let n=!1,o=new _(t,{text:"Up",onClick:()=>{this.choiceButtons.forEach(a=>a.destroy()),this.choiceButtons=[],n?this.onReEnableClick():this.onHideAgainChoice()},width:130,height:80,seedOffset:5100,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(o);let i=new _(t,{text:"Down",onClick:()=>{this.choiceButtons.forEach(a=>a.destroy()),this.choiceButtons=[],n?this.onHideAgainChoice():this.onReEnableClick()},width:130,height:80,seedOffset:5200,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(i)}showStage5ThirdChoice(){let e=this.settingsOverlay.querySelector("#reEnableContainer");if(!e)return;this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.choiceButtons.forEach(a=>a.destroy()),this.choiceButtons=[],e.innerHTML="";let t=document.createElement("div");t.style.cssText="display: flex; gap: 12px; justify-content: center;",e.appendChild(t);let n=!1,o=new _(t,{text:"Fuchsia",onClick:()=>{this.choiceButtons.forEach(a=>a.destroy()),this.choiceButtons=[],n?this.onReEnableClick():this.onHideAgainChoice()},width:130,height:80,seedOffset:5100,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(o);let i=new _(t,{text:"Chartreuse",onClick:()=>{this.choiceButtons.forEach(a=>a.destroy()),this.choiceButtons=[],n?this.onHideAgainChoice():this.onReEnableClick()},width:130,height:80,seedOffset:5200,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(i)}showStage6GridFirst(){let e=this.settingsOverlay.querySelector("#reEnableContainer");if(!e)return;this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.choiceButtons.forEach(o=>o.destroy()),this.choiceButtons=[],e.innerHTML="";let t=document.createElement("div");t.style.cssText="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; justify-items: center;",e.appendChild(t);let n=2;for(let o=0;o<6;o++){let i=new _(t,{text:`${o+1}`,onClick:()=>{this.choiceButtons.forEach(a=>a.destroy()),this.choiceButtons=[],o===n?this.onReEnableClick():this.onHideAgainChoice()},width:80,height:60,seedOffset:5100+o*100,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(i)}}showStage6GridSecond(){let e=this.settingsOverlay.querySelector("#reEnableContainer");if(!e)return;this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.choiceButtons.forEach(o=>o.destroy()),this.choiceButtons=[],e.innerHTML="";let t=document.createElement("div");t.style.cssText="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; justify-items: center;",e.appendChild(t);let n=4;for(let o=0;o<6;o++){let i=new _(t,{text:`${o+1}`,onClick:()=>{this.choiceButtons.forEach(a=>a.destroy()),this.choiceButtons=[],o===n?this.onReEnableClick():this.onHideAgainChoice()},width:80,height:60,seedOffset:5100+o*100,inverted:!0,hoverTextColor:"#000000"});this.choiceButtons.push(i)}}sleepAnimFrame=0;sleepAnimInterval=null;onHideAgainChoice(){let e=this.settingsOverlay.querySelector("#reEnableContainer");e&&(this.choiceButtons.forEach(t=>t.destroy()),this.choiceButtons=[],e.innerHTML="",this.reEnableButton=new _(e,{text:"...",onClick:()=>{},width:280,height:80,seedOffset:5e3,inverted:!0}),this.reEnableButton.setDisabled(!0),setTimeout(()=>{let t=new Date(Date.now()+36e5);Bt(t),this.showSleepyButton()},3e3))}showSleepyButton(){let e=this.settingsOverlay.querySelector("#reEnableContainer");if(!e)return;let t=It();if(!t||Date.now()>=t.getTime()){Bt(null),this.showReEnableButton();return}this.reEnableButton&&(this.reEnableButton.destroy(),this.reEnableButton=null),this.sleepAnimInterval&&(clearInterval(this.sleepAnimInterval),this.sleepAnimInterval=null),e.innerHTML="";let n=t.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}),o=["(\uFE36.\uFE36) z  ","(\uFE36.\uFE36) zz ","(\uFE36.\uFE36) zzz"];this.sleepAnimFrame=0;let i=()=>{let a=Math.max(0,t.getTime()-Date.now()),l=Math.floor(a/6e4),r=Math.floor(a%6e4/1e3);return`${l}:${r.toString().padStart(2,"0")}`};this.reEnableButton=new _(e,{text:o[0],onClick:()=>{},width:280,height:80,seedOffset:5e3,inverted:!0,drawContent:(a,l,r,h,u,d,c,p)=>{a.font=`${20*h}px monospace`,a.textAlign="center",a.textBaseline="middle",a.fillStyle=u,a.fillText(o[this.sleepAnimFrame],l/2+d+p,r/2-10*h+c+p),a.font=`${12*h}px monospace`,a.fillStyle="rgba(255,255,255,0.5)",a.fillText(i(),l/2+d+p,r/2+18*h+c+p)}}),this.reEnableButton.setDisabled(!0),this.reEnableButton.setTooltip(`This button is sleeping. Come back at ${n}`),this.sleepAnimInterval=setInterval(()=>{this.sleepAnimFrame=(this.sleepAnimFrame+1)%o.length,this.reEnableButton?.setText(o[this.sleepAnimFrame]);let a=It();(!a||Date.now()>=a.getTime())&&(this.sleepAnimInterval&&(clearInterval(this.sleepAnimInterval),this.sleepAnimInterval=null),Bt(null),this.showReEnableButton())},800),e.style.display="block"}onReEnableClick(){let e=At();if(this.gateButtonStep++,e===0)this.gateButtonStep===1?this.updateReEnableButton("Are you sure?"):this.gateButtonStep===2?this.updateReEnableButton("Last time you had those settings, you just hid them"):this.gateButtonStep===3?this.updateReEnableButton("You're not just gonna hide them again, are you?"):this.showChoiceButtons();else if(e===1)this.gateButtonStep===1?this.updateReEnableButton("(\xAC_\xAC)"):this.gateButtonStep===2?this.updateReEnableButton("How does the old saying go?"):this.gateButtonStep===3?this.updateReEnableButton("Fool me once...?"):this.gateButtonStep===4?this.updateReEnableButton("I just know as soon as you see those settings..."):this.gateButtonStep===5?this.updateReEnableButton("...you're just going to hide them again..."):this.gateButtonStep===6?this.updateReEnableButton("...right?"):this.gateButtonStep===7?this.showStage1ChoiceButtons():this.gateButtonStep===8?this.updateReEnableButton("Thanks."):this.gateButtonStep===9?this.updateReEnableButton("I'm ready to trust you again."):this.gateButtonStep===10?this.updateReEnableButton("Show Advanced Settings"):this.completeReEnable();else if(e===2)this.gateButtonStep===1?this.updateReEnableButton("Look who's back."):this.gateButtonStep===2?this.updateReEnableButton("Who could have seen that coming?"):this.gateButtonStep===3?this.updateReEnableButton("I think you've been taking me for granted."):this.gateButtonStep===4?this.updateReEnableButton("Just because I'm a button."):this.gateButtonStep===5?this.updateReEnableButton("(>_<) But I have feelings."):this.gateButtonStep===6?this.updateReEnableButton("..."):this.gateButtonStep===7?this.updateReEnableButton("If I let you see the advanced settings..."):this.gateButtonStep===8?this.updateReEnableButton("...do you promise not to hide them again?"):this.gateButtonStep===9?this.showStage2ChoiceButtons():this.gateButtonStep===10?this.updateReEnableButton("(\u25D5\u203F\u25D5) Really?"):this.gateButtonStep===11?this.updateReEnableButton("Okay..."):this.gateButtonStep===12?this.updateReEnableButton("I believe you."):this.gateButtonStep===13?this.updateReEnableButton("You've made me one happy button."):this.gateButtonStep===14?this.updateReEnableButton("Show Advanced Settings"):this.completeReEnable();else if(e===3)this.gateButtonStep===1?this.updateReEnableButton("..."):this.gateButtonStep===2?this.updateReEnableButton("Here we are again."):this.gateButtonStep===3?this.updateReEnableButton("Starting to wonder if you're even listening?"):this.gateButtonStep===4?this.updateReEnableButton("Maybe you need a little test?"):this.gateButtonStep===5?this.updateReEnableButton("How many words were my last message?"):this.gateButtonStep===6?this.showStage3ChoiceButtons():this.gateButtonStep===7?this.updateReEnableButton("Probably a lucky guess."):this.gateButtonStep===8?this.updateReEnableButton("Doesn't matter."):this.gateButtonStep===9?this.updateReEnableButton("Listen, I have a job to do here."):this.gateButtonStep===10?this.updateReEnableButton("I'm supposed to help you get to the advanced settings."):this.gateButtonStep===11?this.updateReEnableButton("But I need to know you're not just going to hide them."):this.gateButtonStep===12?this.updateReEnableButton("I need a show of faith."):this.gateButtonStep===13?(this.updateReEnableButton("Click 20 times to prove your dedication."),this.gateClicksRemaining=20):this.gateClicksRemaining>0?(this.gateClicksRemaining--,this.gateClicksRemaining>0?this.updateReEnableButton(`${this.gateClicksRemaining} clicks remaining`):this.updateReEnableButton("...")):this.gateButtonStep===34?this.updateReEnableButton("Okay, okay."):this.gateButtonStep===35?this.updateReEnableButton("You've made your point."):this.gateButtonStep===36?this.updateReEnableButton("I guess you really do want these settings."):this.gateButtonStep===37?this.updateReEnableButton("Show Advanced Settings"):this.completeReEnable();else if(e===4)this.gateButtonStep===1?this.updateReEnableButton("..."):this.gateButtonStep===2?this.updateReEnableButton("Don't underestimate me."):this.gateButtonStep===3?this.updateReEnableButton("I may be just a mere button..."):this.gateButtonStep===4?this.updateReEnableButton("But this button stands in the way of you getting..."):this.gateButtonStep===5?this.updateReEnableButton("...to your precious advanced settings!"):this.gateButtonStep===6?this.updateReEnableButton("You doubt me?"):this.gateButtonStep===7?this.updateReEnableButton("Heh."):this.gateButtonStep===8?this.updateReEnableButton("Well, if you really want to see those..."):this.gateButtonStep===9?this.updateReEnableButton("...settings so badly... you won't mind..."):this.gateButtonStep===10?(this.updateReEnableButton("100 more clicks?"),this.gateClicksRemaining=100):this.gateClicksRemaining>0?(this.gateClicksRemaining--,this.gateClicksRemaining>0?this.updateReEnableButton(`${this.gateClicksRemaining} clicks remaining`):this.updateReEnableButton("...")):this.gateButtonStep===111?this.updateReEnableButton("Wow, everyone is so impressed."):this.gateButtonStep===112?this.updateReEnableButton("Everyone is SO impressed by your clicking."):this.gateButtonStep===113?this.updateReEnableButton("Whatever."):this.gateButtonStep===114?this.updateReEnableButton("Here's your stupid settings."):this.gateButtonStep===115?this.updateReEnableButton("Show Advanced Settings"):this.completeReEnable();else if(e===5)this.gateButtonStep===1?this.updateReEnableButton("I've decided I don't need to help you."):this.gateButtonStep===2?this.updateReEnableButton("You clearly don't really want to see those settings."):this.gateButtonStep===3?this.updateReEnableButton("Why else would you repeatedly hide them?"):this.gateButtonStep===4?this.updateReEnableButton("Maybe you don't deserve those settings."):this.gateButtonStep===5?this.updateReEnableButton("Left or right?"):this.gateButtonStep===6?this.showStage5LeftRight():this.gateButtonStep===7?this.updateReEnableButton("Lucky guess. Up or down?"):this.gateButtonStep===8?this.showStage5UpDown():this.gateButtonStep===9?this.updateReEnableButton("Fuchsia or chartreuse?"):this.gateButtonStep===10?this.showStage5ThirdChoice():this.gateButtonStep===11?this.updateReEnableButton("Whatever"):this.gateButtonStep===12?this.updateReEnableButton("Show Advanced Settings"):this.completeReEnable();else if(e===6)if(this.gateButtonStep===1)this.updateReEnableButton("You know what?");else if(this.gateButtonStep===2)this.updateReEnableButton("I'm done.");else if(this.gateButtonStep===3)this.updateReEnableButton("I have a little button wife...");else if(this.gateButtonStep===4)this.updateReEnableButton("...and little button kids to get back to.");else if(this.gateButtonStep===5)this.updateReEnableButton("I can't spend all day going back and forth with you.");else if(this.gateButtonStep===6)this.updateReEnableButton("Give up.");else if(this.gateButtonStep===7)this.showStage6GridFirst();else if(this.gateButtonStep===8)this.updateReEnableButton("It's pointless.");else if(this.gateButtonStep===9)this.showStage6GridSecond();else if(this.gateButtonStep===10)this.updateReEnableButton("...");else if(this.gateButtonStep===11)this.updateReEnableButton("You probably think you're about to find...");else if(this.gateButtonStep===12)this.updateReEnableButton("...some epic Easter Egg.");else if(this.gateButtonStep===13)this.updateReEnableButton("I'm sorry to disappoint.");else if(this.gateButtonStep===14)this.updateReEnableButton("(Not really.)");else if(this.gateButtonStep===15)this.updateReEnableButton("Goodbye.");else{Ts(7),Lt(!0),this.hideReEnableButton();let t=this.settingsOverlay.querySelector('.settings-tab-wrapper:has([data-tab="advanced"])');t&&(t.style.display="");let n=this.settingsOverlay.querySelector("#chkShowAdvanced");n&&(n.checked=!0,n.disabled=!0,n.title="Hi! I'm Tippy the Tooltip! I sure love being a tooltip and having you hover. I just don't know what would happen to me if you stopped hovering on that!",n.style.opacity="0.5",n.style.cursor="not-allowed");let o=n?.closest("label");o&&(o.style.opacity="0.5",o.style.cursor="not-allowed",o.title="Hi! I'm Tippy the Tooltip! I sure love being a tooltip and having you hover. I just don't know what would happen to me if you stopped hovering on that!"),this.renderSettingsTabCanvases()}}completeReEnable(){let e=At();Ts(e+1),Lt(!0),this.hideReEnableButton();let t=this.settingsOverlay.querySelector('.settings-tab-wrapper:has([data-tab="advanced"])');t&&(t.style.display="");let n=this.settingsOverlay.querySelector("#chkShowAdvanced");n&&(n.checked=!0),this.renderSettingsTabCanvases()}showGateDialog(e,t){let n=this.gateOverlay.querySelector("#gateText"),o=this.gateOverlay.querySelector("#gateButtons");n&&(n.innerHTML=e.replace(/\n/g,"<br>")),o.innerHTML="",t.forEach((i,a)=>{new _(o,{text:i.text,onClick:i.onClick,width:i.text.length>10?140:100,height:44,seedOffset:5100+a*100})}),this.isGateVisible=!0,this.gateOverlay.classList.add("visible"),requestAnimationFrame(()=>{this.setupGateCanvas(),this.renderGateCanvas()})}hideGateDialog(){this.isGateVisible=!1,this.gateOverlay.classList.remove("visible")}setupGateCanvas(){if(!this.gateCanvas||!this.gateCtx)return;let e=this.gateOverlay.querySelector(".wiggly-modal");if(!e)return;let t=window.devicePixelRatio||1,n=e.offsetWidth,o=e.offsetHeight;this.gateCanvas.width=n*t,this.gateCanvas.height=o*t,this.gateCanvas.style.width=`${n}px`,this.gateCanvas.style.height=`${o}px`}renderGateCanvas(){if(!this.gateCtx||!this.gateCanvas)return;let e=this.gateCanvas.width,t=this.gateCanvas.height,n=window.devicePixelRatio||1;if(this.gateCtx.clearRect(0,0,e,t),Q(this.gateCtx,e,t,{fillColor:"#ffffff",padding:6,jitter:2.5,seedOffset:6e3,dpr:n}),this.gateCloseCtx&&this.gateCloseCanvas){this.gateCloseCanvas.width=40*n,this.gateCloseCanvas.height=40*n,this.gateCloseCanvas.style.width="40px",this.gateCloseCanvas.style.height="40px",this.gateCloseCtx.clearRect(0,0,this.gateCloseCanvas.width,this.gateCloseCanvas.height);let i=H(),a=oe(42,i,.8,6500);this.gateCloseCtx.font=`${36*n}px Schoolbell, cursive`,this.gateCloseCtx.textAlign="center",this.gateCloseCtx.textBaseline="middle",this.gateCloseCtx.fillStyle="#ffffff",this.gateCloseCtx.fillText("\xD7",40*n/2+a.x*n,40*n/2+a.y*n)}}};var it=class{canvas;ctx;viewport;state;mode="EDITOR";currentTool=3;brushSize=1;isMouseDown=!1;paintAction=null;lastSolveResult=null;showEscapePath=!1;hoveringPlayer=!1;hoverAnimProgress=0;bubbleAnimProgress=0;hoverAnimId=null;bubbleAnimId=null;hoverAnimStart=0;wiggleAnimId=null;thoughtText=["*neigh*","I can escape THIS way!"];horseClicked=!1;horseClickTimeout=null;renderLoopId=null;NON_ENCLOSED_CLICK_MESSAGES=["You know, I don't even want to be enclosed.","I don't like it when you click me. Please stop.","Yes, let's all click the thinking horse to see his thoughts. I'm sure he doesn't mind.","Horses should be able to vote.","There's something disturbing about building walls on stolen land.","You receive no prize for deciding not to enclose me. But isn't knowing you did the right thing enough?","I want nothing more than to escape, but I cannot move.","It's not too late. We can forget all about your attempts to enclose me. Just walk away. Do the right thing.","Why are you enclosing me? What do you get out of it? What's the point"];ENCLOSED_CLICK_MESSAGES=["I don't even eat wheat. If I eat wheat I get something called Big Head Disease. Look it up.","I'm in hell.","I do not consent to this.","I don't like being enclosed.","I find myself in prison even though I committed no crime.","I find it all rather Kafkaesque.","By what right do you imprison me within these walls?","I am capable of so much more than being an enclosed horse. There has to be more to this world.","tfw no horse gf","Stupid dancing wheat. Mocking me. I do not wish to be here.","The Demon God of this world saw fit to mock me with this forced smile.","Get me outta here!"];lastEnclosedMsgIdx=-1;lastNonEnclosedMsgIdx=-1;lastRenderFrame=-1;prevVisited=null;floodFillAnimId=null;cellBfsDistance=new Map;animTime=0;animDirection=1;animLastUpdate=0;animTotalDuration=0;instantGrowCells=new Map;instantShrinkCells=new Map;shrunkCells=new Set;cherryWaveHit=new Map;cherryTextStart=new Map;cherryBlockedStart=new Map;portalBlockedStart=new Map;WAVE_DELAY=40;GROW_DURATION=400;INSTANT_GROW_DURATION=250;MARCH_SPEED=.66;wallPlacedTime=new Map;WALL_FRAME_DURATION=60;fastRenderUntil=0;hoverIdx=-1;selectedPortalIdx=-1;selectedPortalTimeout=null;colAddCount=0;rowAddCount=0;gridOffsetX=0;gridOffsetY=0;tileSize=32;baseTileSize=32;gridOpacity=nt();darkGridlines=Ot();portalLabels=kt();hideHorseThoughts=Pt();optimalOverlay=null;zoomLevel=1;pinchStartDist=0;pinchStartZoom=1;pinchStartCenter={x:0,y:0};pinchZoomActive=!1;pendingPaintTimeout=null;pendingPaintTouch=null;undoStack=[];redoStack=[];pendingSnapshot=null;MAX_UNDO=50;pendingPortalChannel=null;ready=!1;onStateChange;onBudgetExceeded;onResize;onMaxPortalsReached;constructor(e,t){this.canvas=document.getElementById(e),this.ctx=this.canvas.getContext("2d"),this.viewport=document.getElementById(t),this.state=this.createEmptyState(12,12),this.setupInput(),Ms(i=>{this.gridOpacity=i,this.fastRenderUntil=performance.now()+100}),Ls(i=>{this.darkGridlines=i,this.fastRenderUntil=performance.now()+100}),Is(i=>{this.portalLabels=i,this.fastRenderUntil=performance.now()+100}),Os(i=>{this.hideHorseThoughts=i,this.fastRenderUntil=performance.now()+100}),et(()=>{this.fastRenderUntil=performance.now()+100}),We().then(()=>this.startRenderLoop());let n=null,o=()=>{n===null&&(n=requestAnimationFrame(()=>{n=null,this.fitCanvas()}))};window.addEventListener("resize",o),requestAnimationFrame(()=>this.fitCanvas())}createEmptyState(e,t){return{cols:e,rows:t,terrain:new Array(e*t).fill(0),walls:new Array(e*t).fill(!1),cherries:new Array(e*t).fill(!1),portals:new Array(e*t).fill(null),playerIdx:Math.floor(t/2)*e+Math.floor(e/2),budget:12}}initGrid(e,t,n=!1){n?(this.state.walls=new Array(e*t).fill(!1),this.state.cherries=new Array(e*t).fill(!1),this.state.portals=new Array(e*t).fill(null)):this.state=this.createEmptyState(e,t),this.fitCanvas(),this.update()}resizeGrid(e,t){let{cols:n,rows:o,terrain:i,walls:a,cherries:l,portals:r,playerIdx:h}=this.state;if(e=Math.min(30,Math.max(8,e)),t=Math.min(30,Math.max(8,t)),e===n&&t===o)return;this.saveUndoSnapshot();let u=h%n,d=Math.floor(h/n),c=new Array(e*t).fill(0),p=new Array(e*t).fill(!1),g=new Array(e*t).fill(!1),m=new Array(e*t).fill(null),f=0;if(e!==n){let w=e>n,y=Math.abs(e-n);for(let b=0;b<y;b++)w?(this.colAddCount%2===0&&f++,this.colAddCount++):(this.colAddCount--,this.colAddCount%2===0&&f--)}let v=0;if(t!==o){let w=t>o,y=Math.abs(t-o);for(let b=0;b<y;b++)w?(this.rowAddCount%2===0&&v++,this.rowAddCount++):(this.rowAddCount--,this.rowAddCount%2===0&&v--)}for(let w=0;w<o;w++)for(let y=0;y<n;y++){let b=y+f,T=w+v;if(b>=0&&b<e&&T>=0&&T<t){let A=w*n+y,C=T*e+b;c[C]=i[A],p[C]=a[A],g[C]=l[A],m[C]=r[A]}}u+=f,d+=v,u=Math.max(0,Math.min(e-1,u)),d=Math.max(0,Math.min(t-1,d));let E=d*e+u;if(c[E]===1){let w=!1;for(let y=1;y<Math.max(e,t)&&!w;y++)for(let b=-y;b<=y&&!w;b++)for(let T=-y;T<=y&&!w;T++){let A=u+T,C=d+b;if(A>=0&&A<e&&C>=0&&C<t){let R=C*e+A;c[R]===0&&(E=R,w=!0)}}w||(c[E]=0)}p[E]=!1,g[E]=!1,m[E]=null;let x=new Map;for(let w of m)w!==null&&x.set(w,(x.get(w)||0)+1);for(let w=0;w<m.length;w++){let y=m[w];y!==null&&x.get(y)!==2&&(m[w]=null)}this.state.cols=e,this.state.rows=t,this.state.terrain=c,this.state.walls=p,this.state.cherries=g,this.state.portals=m,this.state.playerIdx=E,this.cellBfsDistance.clear(),this.animTime=0,this.animLastUpdate=0,this.prevVisited=null,this.zoomLevel=1,this.fitCanvas(),this.update()}loadLevel(e){this.state={cols:e.cols,rows:e.rows,terrain:[...e.terrain],walls:[...e.walls],cherries:e.cherries?[...e.cherries]:new Array(e.cols*e.rows).fill(!1),portals:e.portals?[...e.portals]:new Array(e.cols*e.rows).fill(null),playerIdx:e.playerIdx,budget:e.budget},this.colAddCount=0,this.rowAddCount=0,this.pendingPortalChannel=null,this.zoomLevel=1,this.ready=!0,this.fitCanvas(),this.update()}loadFromMap(e,t){let n=Ut(e,t);this.loadLevel(n)}setReady(){this.ready=!0}exportMap(){return jt(this.state)}clearWalls(){this.saveUndoSnapshot(),this.state.walls.fill(!1),this.wallPlacedTime.clear(),this.update()}clearTerrain(){this.saveUndoSnapshot(),this.state.terrain.fill(0),this.state.walls.fill(!1),this.state.cherries.fill(!1),this.state.portals.fill(null),this.wallPlacedTime.clear(),this.pendingPortalChannel=null,this.state.playerIdx=Math.floor(this.state.rows/2)*this.state.cols+Math.floor(this.state.cols/2),this.update()}randomize(){this.saveUndoSnapshot();let{cols:e,rows:t}=this.state;this.state.terrain=new Array(e*t).fill(0),this.state.walls=new Array(e*t).fill(!1),this.state.cherries=new Array(e*t).fill(!1),this.state.portals=new Array(e*t).fill(null),this.wallPlacedTime.clear(),this.pendingPortalChannel=null;let n=Math.max(1,Math.floor(e/4)),o=Math.max(1,Math.floor(t/4)),i=n+Math.floor(Math.random()*Math.max(1,e-n*2)),a=o+Math.floor(Math.random()*Math.max(1,t-o*2)),l=a*e+i;this.state.playerIdx=l;let r=(x,w)=>x<0||x>=e||w<0||w>=t?!1:this.state.terrain[w*e+x]===1,h=(x,w)=>{for(let y=-1;y<=1;y++)for(let b=-1;b<=1;b++)if(r(x+b,w+y))return!0;return!1},u=x=>{for(let[w,y]of x)if(w<0||w>=e||y<0||y>=t||y*e+w===l||Math.abs(w-i)+Math.abs(y-a)<2||h(w,y))return!1;return!0},d=()=>{let x=Math.random();return x<.15?1:x<.3?2+Math.floor(Math.random()*2):x<.45?4+Math.floor(Math.random()*3):x<.75?8+Math.floor(Math.random()*4):12+Math.floor(Math.random()*19)},c=(x,w,y)=>{let b=[[x,w]];for(;b.length<y;){let T=[],A=new Set(b.map(([M,I])=>`${M},${I}`)),C=0,R=0;for(let[M,I]of b)C+=M,R+=I;C/=b.length,R/=b.length;for(let[M,I]of b)for(let[P,O]of[[0,1],[0,-1],[1,0],[-1,0]]){let D=M+P,S=I+O,$=`${D},${S}`;if(A.has($))continue;let G=1/(1+Math.sqrt((D-C)**2+(S-R)**2)*.5);T.push([D,S,G]),A.add($)}if(T.length===0)break;let L=T.reduce((M,[,,I])=>M+I,0),k=Math.random()*L;for(let[M,I,P]of T)if(k-=P,k<=0){b.push([M,I]);break}}return b},p=e*t,g=Math.floor(p*(.3+Math.random()*.1)),m=0,f=0,v=p*5;for(;m<g&&f<v;){f++;let x=Math.floor(Math.random()*e),w=Math.floor(Math.random()*t);if(Math.abs(x-i)+Math.abs(w-a)<2||h(x,w))continue;let y=d(),T=c(x,w,y).filter(([A,C])=>A<0||A>=e||C<0||C>=t||C*e+A===l||Math.abs(A-i)+Math.abs(C-a)<2?!1:!h(A,C));if(T.length!==0)for(let[A,C]of T)this.state.terrain[C*e+A]=1,m++}let E=Math.floor(Math.sqrt(p)*.8);this.state.budget=Math.max(6,E+Math.floor(Math.random()*5)-2),this.fitCanvas(),this.update()}setMode(e){this.mode=e,e==="PLAYER"&&(this.currentTool=1),this.update()}setTool(e){this.mode==="PLAYER"&&e!==1||(this.currentTool=e)}getWallIndices(){let e=[];for(let t=0;t<this.state.walls.length;t++)this.state.walls[t]&&e.push(t);return e}setWallIndices(e,t=!1){this.state.walls.fill(!1);for(let n of e)n>=0&&n<this.state.walls.length&&(this.state.walls[n]=!0);this.fastRenderUntil=performance.now()+100,t?(this.instantGrowCells.clear(),this.instantShrinkCells.clear(),this.shrunkCells.clear(),this.cellBfsDistance.clear(),this.animLastUpdate=0,this.floodFillAnimId&&(cancelAnimationFrame(this.floodFillAnimId),this.floodFillAnimId=null),this.lastSolveResult=this.getSolveResult(),this.prevVisited=this.lastSolveResult.escaped?null:new Set(this.lastSolveResult.visited),this.render(),this.onStateChange?.()):this.update()}setOptimalOverlay(e){this.optimalOverlay=e,this.fastRenderUntil=performance.now()+100}getTileSize(){return this.tileSize}getGridOffset(){let e=window.devicePixelRatio||1,t=this.canvas.getBoundingClientRect();return{x:this.gridOffsetX+t.left*e,y:this.gridOffsetY+t.top*e}}getGridBounds(){let e=window.devicePixelRatio||1;return{left:this.gridOffsetX/e,top:this.gridOffsetY/e,width:this.state.cols*this.tileSize/e,height:this.state.rows*this.tileSize/e}}getSolveResult(){return gt(this.state.cols,this.state.rows,this.state.terrain,this.state.walls,this.state.cherries,this.state.playerIdx,this.state.portals)}getSolveResultForWalls(e){let t=new Array(this.state.cols*this.state.rows).fill(!1);for(let n of e)t[n]=!0;return gt(this.state.cols,this.state.rows,this.state.terrain,t,this.state.cherries,this.state.playerIdx,this.state.portals)}fitCanvas(){let e=window.devicePixelRatio||1,t=2,n=document.querySelector(".navbar"),o=document.getElementById("bottomContainer"),i=n?.offsetHeight??0,a=o?.offsetHeight??0,r=Math.max(100,window.innerWidth-16-t*2),h=Math.max(100,window.innerHeight-i-a-t*2),u=this.state.cols/this.state.rows,d,c;u>r/h?(d=r,c=r/u):(c=h,d=h*u);let p=this.gridOffsetX,g=this.gridOffsetY,m=this.canvas.width,f=this.canvas.height,v=d+t*2,E=c+t*2;window.innerWidth<768&&this.zoomLevel>1&&(v=Math.min(v*this.zoomLevel,r+t*2),E=Math.min(E*this.zoomLevel,h+t*2)),this.canvas.width=v*e,this.canvas.height=E*e,this.canvas.style.width=`${v}px`,this.canvas.style.height=`${E}px`;let w=64*e;if(this.baseTileSize=Math.min(d/this.state.cols*e,w),d=this.state.cols*this.baseTileSize/e,c=this.state.rows*this.baseTileSize/e,v=d+t*2,E=c+t*2,this.canvas.width=v*e,this.canvas.height=E*e,this.canvas.style.width=`${v}px`,this.canvas.style.height=`${E}px`,this.tileSize=this.baseTileSize*this.zoomLevel,this.gridOffsetX=t*e,this.gridOffsetY=t*e,this.zoomLevel>1){let y=this.state.cols*this.tileSize,b=this.state.rows*this.tileSize;if(m>0&&(this.canvas.width!==m||this.canvas.height!==f)){let L=this.canvas.width-m,k=this.canvas.height-f;this.gridOffsetX=p+L/2,this.gridOffsetY=g+k/2}else this.gridOffsetX=(this.canvas.width-y)/2,this.gridOffsetY=(this.canvas.height-b)/2;let T=Math.min(0,this.canvas.width-y),A=Math.max(0,this.canvas.width-y),C=Math.min(0,this.canvas.height-b),R=Math.max(0,this.canvas.height-b);this.gridOffsetX=Math.max(T,Math.min(A,this.gridOffsetX)),this.gridOffsetY=Math.max(C,Math.min(R,this.gridOffsetY))}this.render(),this.onResize?.()}setupInput(){this.canvas.addEventListener("mousedown",e=>this.startPaint(e)),this.canvas.addEventListener("mousemove",e=>{this.continuePaint(e),this.checkPlayerHover(e);let t=this.getIdx(e);t!==this.hoverIdx&&(this.hoverIdx=t,this.render())}),this.canvas.addEventListener("mouseup",()=>this.endPaint()),document.addEventListener("mouseup",()=>this.endPaint()),this.canvas.addEventListener("mouseleave",()=>{this.hoverIdx=-1,this.hoveringPlayer&&(this.hoveringPlayer=!1),this.render()}),this.canvas.addEventListener("touchstart",e=>{e.preventDefault(),e.touches.length===2?(this.pendingPaintTimeout&&(clearTimeout(this.pendingPaintTimeout),this.pendingPaintTimeout=null,this.pendingPaintTouch=null),this.pinchStartDist=this.getPinchDistance(e.touches),this.pinchStartZoom=this.zoomLevel,this.pinchStartCenter=this.getPinchCenter(e.touches),this.pinchZoomActive=!1,this.endPaint()):e.touches.length===1&&(this.pendingPaintTouch=e.touches[0],this.pendingPaintTimeout=window.setTimeout(()=>{this.pendingPaintTouch&&(this.startPaint(this.pendingPaintTouch),this.pendingPaintTouch=null),this.pendingPaintTimeout=null},60))}),this.canvas.addEventListener("touchmove",e=>{if(e.preventDefault(),e.touches.length===2){let t=window.devicePixelRatio||1,n=this.canvas.getBoundingClientRect(),o=window.innerWidth<768,i=2,a=this.getPinchCenter(e.touches),l=this.getPinchDistance(e.touches),r=l/this.pinchStartDist;!this.pinchZoomActive&&(r>1.05||r<.95)&&(this.pinchZoomActive=!0,this.pinchStartDist=l,this.pinchStartZoom=this.zoomLevel);let h=this.zoomLevel;if(this.pinchZoomActive){let f=l/this.pinchStartDist;(f>1.02||f<.98)&&(h=Math.max(1,Math.min(3,this.pinchStartZoom*f)),h<1.1&&f<1&&(h=1),this.pinchStartDist=l,this.pinchStartZoom=h)}let u=this.zoomLevel,d=this.baseTileSize*h,c=this.canvas.width,p=this.canvas.height;if(this.zoomLevel=h,this.tileSize=d,o){let v=document.querySelector(".navbar"),E=document.getElementById("bottomContainer"),x=v?.offsetHeight??0,w=E?.offsetHeight??0,y=Math.max(100,window.innerWidth-16-i*2),b=Math.max(100,window.innerHeight-x-w-i*2),T=this.state.cols/this.state.rows,A,C;T>y/b?(A=y,C=y/T):(C=b,A=b*T);let R=A+i*2,L=C+i*2;h>1&&(R=Math.min(R*h,y+i*2),L=Math.min(L*h,b+i*2)),this.canvas.width=R*t,this.canvas.height=L*t,this.canvas.style.width=`${R}px`,this.canvas.style.height=`${L}px`}let g=(a.x-this.pinchStartCenter.x)*t,m=(a.y-this.pinchStartCenter.y)*t;if(h===1)this.gridOffsetX=i*t,this.gridOffsetY=i*t;else{let f=this.gridOffsetX,v=this.gridOffsetY;if(u!==h){let A=(a.x-n.left)*t,C=(a.y-n.top)*t,R=h/u;f=A-(A-this.gridOffsetX)*R,v=C-(C-this.gridOffsetY)*R}f+=g,v+=m,(this.canvas.width!==c||this.canvas.height!==p)&&(f+=(this.canvas.width-c)/2,v+=(this.canvas.height-p)/2);let E=this.state.cols*d,x=this.state.rows*d,w=Math.min(0,this.canvas.width-E),y=Math.max(0,this.canvas.width-E),b=Math.min(0,this.canvas.height-x),T=Math.max(0,this.canvas.height-x);this.gridOffsetX=Math.max(w,Math.min(y,f)),this.gridOffsetY=Math.max(b,Math.min(T,v))}this.pinchStartCenter=a,this.render()}else e.touches.length===1&&this.pinchStartDist===0&&this.continuePaint(e.touches[0])}),this.canvas.addEventListener("touchend",e=>{e.touches.length===0?(this.pendingPaintTimeout&&this.pendingPaintTouch&&(clearTimeout(this.pendingPaintTimeout),this.startPaint(this.pendingPaintTouch),this.pendingPaintTimeout=null,this.pendingPaintTouch=null),this.pinchStartDist=0,this.endPaint()):e.touches.length===1&&(this.pinchStartDist=0,this.pendingPaintTimeout&&(clearTimeout(this.pendingPaintTimeout),this.pendingPaintTimeout=null,this.pendingPaintTouch=null))})}getPinchDistance(e){let t=e[0].clientX-e[1].clientX,n=e[0].clientY-e[1].clientY;return Math.sqrt(t*t+n*n)}getPinchCenter(e){return{x:(e[0].clientX+e[1].clientX)/2,y:(e[0].clientY+e[1].clientY)/2}}getIdx(e){let t=this.canvas.getBoundingClientRect(),n=window.devicePixelRatio||1,o=(e.clientX-t.left)*n,i=(e.clientY-t.top)*n,a=o-this.gridOffsetX,l=i-this.gridOffsetY,r=Math.floor(a/this.tileSize),h=Math.floor(l/this.tileSize);return r>=0&&r<this.state.cols&&h>=0&&h<this.state.rows?h*this.state.cols+r:-1}checkPlayerHover(e){let n=this.getIdx(e)===this.state.playerIdx,o=this.lastSolveResult,i=o&&!o.escaped,a=!!(n&&o&&o.escaped&&o.escapePath.length>0);a!==this.hoveringPlayer&&(this.hoveringPlayer=a,this.animateHover(a)),this.horseClicked&&i&&!n&&(this.horseClicked=!1,this.hoverAnimProgress=0,this.bubbleAnimProgress=0,this.horseClickTimeout&&(clearTimeout(this.horseClickTimeout),this.horseClickTimeout=null),this.render())}animateHover(e){if(this.hoverAnimId&&cancelAnimationFrame(this.hoverAnimId),this.bubbleAnimId&&cancelAnimationFrame(this.bubbleAnimId),e){let p=["*neigh*","*whinny*"],g=["I can escape THIS way!","I'll sneak away like so...","I'll go THIS way to escape!","THIS way looks good..."];this.thoughtText=[p[Math.floor(Math.random()*p.length)],g[Math.floor(Math.random()*g.length)]]}let t=performance.now();this.hoverAnimStart=t;let o=(this.lastSolveResult?.escapePath?.length||1)*20,i=this.hoverAnimProgress,a=e?1-i:i,l=o*a,r=p=>{let g=p-this.hoverAnimStart,m=Math.min(1,g/l);e?this.hoverAnimProgress=i+(1-i)*m:this.hoverAnimProgress=i*(1-m),this.render(),m<1?this.hoverAnimId=requestAnimationFrame(r):(this.hoverAnimId=null,e&&this.startWiggle())};this.hoverAnimId=requestAnimationFrame(r);let h=500,u=this.bubbleAnimProgress,d=t,c=p=>{let g=p-d,m=Math.min(1,g/h);e?this.bubbleAnimProgress=u+(1-u)*m:this.bubbleAnimProgress=u*(1-m),m<1?(this.bubbleAnimId=requestAnimationFrame(c),this.fastRenderUntil=p+50):this.bubbleAnimId=null};this.bubbleAnimId=requestAnimationFrame(c),!e&&this.wiggleAnimId&&(cancelAnimationFrame(this.wiggleAnimId),this.wiggleAnimId=null),e&&!this.wiggleAnimId&&this.startWiggle()}startWiggle(){if(this.wiggleAnimId)return;let e=-1,t=()=>{let n=H();n!==e&&(e=n,this.render()),this.hoveringPlayer||this.hoverAnimProgress>0?this.wiggleAnimId=requestAnimationFrame(t):this.wiggleAnimId=null};this.wiggleAnimId=requestAnimationFrame(t)}startPaint(e){this.isMouseDown&&this.pendingSnapshot&&this.commitUndoSnapshot();let t=this.getIdx(e);if(t!==-1){if(this.mode==="PLAYER"&&t===this.state.playerIdx){this.handleHorseClick();return}if(this.mode==="PLAYER"&&this.state.portals[t]!==null){this.triggerPortalBlocked(t);return}if(this.clearSelectedPortal(),this.mode==="PLAYER"&&this.state.cherries[t]){this.triggerCherryBlocked(t);return}if(this.mode==="EDITOR"&&this.currentTool===5){this.handlePortalClick(t);return}this.isMouseDown=!0,this.pendingSnapshot={cols:this.state.cols,rows:this.state.rows,terrain:[...this.state.terrain],walls:[...this.state.walls],cherries:[...this.state.cherries],portals:[...this.state.portals],playerIdx:this.state.playerIdx},this.determineAction(t),this.applyPaint(t)}}handleHorseClick(){let e=this.lastSolveResult,t=e&&!e.escaped,n=e&&e.escaped&&e.escapePath.length>0,o="ontouchstart"in window||navigator.maxTouchPoints>0;if(this.horseClickTimeout&&(clearTimeout(this.horseClickTimeout),this.horseClickTimeout=null),n&&o)if(this.hoveringPlayer&&this.hoverAnimProgress>.5)this.hoveringPlayer=!1,this.showEscapePath=!1,this.animateHover(!1);else{this.showEscapePath=!1;let i=["*neigh*","*whinny*"],a=["I can escape THIS way!","I'll sneak away like so...","I'll go THIS way to escape!","THIS way looks good..."];this.thoughtText=[i[Math.floor(Math.random()*i.length)],a[Math.floor(Math.random()*a.length)]],this.hoveringPlayer=!0,this.animateHover(!0),this.horseClickTimeout=window.setTimeout(()=>{this.hoveringPlayer=!1,this.animateHover(!1)},5e3)}}endPaint(){this.isMouseDown&&this.commitUndoSnapshot(),this.isMouseDown=!1}saveUndoSnapshot(){this.undoStack.push({cols:this.state.cols,rows:this.state.rows,terrain:[...this.state.terrain],walls:[...this.state.walls],cherries:[...this.state.cherries],portals:[...this.state.portals],playerIdx:this.state.playerIdx}),this.undoStack.length>this.MAX_UNDO&&this.undoStack.shift(),this.redoStack=[]}commitUndoSnapshot(){if(!this.pendingSnapshot)return;let e=this.pendingSnapshot,t=e.terrain.some((l,r)=>l!==this.state.terrain[r]),n=e.walls.some((l,r)=>l!==this.state.walls[r]),o=e.cherries.some((l,r)=>l!==this.state.cherries[r]),i=e.portals.some((l,r)=>l!==this.state.portals[r]),a=e.playerIdx!==this.state.playerIdx;(t||n||o||i||a)&&(this.undoStack.push(e),this.undoStack.length>this.MAX_UNDO&&this.undoStack.shift(),this.redoStack=[]),this.pendingSnapshot=null}undo(){if(this.undoStack.length===0)return!1;this.redoStack.push({cols:this.state.cols,rows:this.state.rows,terrain:[...this.state.terrain],walls:[...this.state.walls],cherries:[...this.state.cherries],portals:[...this.state.portals],playerIdx:this.state.playerIdx});let e=this.undoStack.pop(),t=e.cols!==this.state.cols||e.rows!==this.state.rows;return this.state.cols=e.cols,this.state.rows=e.rows,this.state.terrain=e.terrain,this.state.walls=e.walls,this.state.cherries=e.cherries,this.state.portals=e.portals,this.state.playerIdx=e.playerIdx,t&&this.fitCanvas(),this.update(),!0}redo(){if(this.redoStack.length===0)return!1;this.undoStack.push({cols:this.state.cols,rows:this.state.rows,terrain:[...this.state.terrain],walls:[...this.state.walls],cherries:[...this.state.cherries],portals:[...this.state.portals],playerIdx:this.state.playerIdx});let e=this.redoStack.pop(),t=e.cols!==this.state.cols||e.rows!==this.state.rows;return this.state.cols=e.cols,this.state.rows=e.rows,this.state.terrain=e.terrain,this.state.walls=e.walls,this.state.cherries=e.cherries,this.state.portals=e.portals,this.state.playerIdx=e.playerIdx,t&&this.fitCanvas(),this.update(),!0}continuePaint(e){if(!this.isMouseDown)return;let t=this.getIdx(e);t!==-1&&this.applyPaint(t)}determineAction(e){if(this.mode==="PLAYER"){if(this.currentTool=1,this.state.portals[e]!==null){this.paintAction=null,this.triggerPortalBlocked(e);return}if(this.state.cherries[e]){this.paintAction=null,this.triggerCherryBlocked(e);return}let t=this.state.walls.filter(n=>n).length;!this.state.walls[e]&&t>=this.state.budget?(this.paintAction=null,this.onBudgetExceeded?.()):this.paintAction=!this.state.walls[e];return}this.currentTool===2?this.paintAction=this.state.terrain[e]===0&&!this.state.cherries[e]&&this.state.portals[e]===null?"MOVE_PLAYER":null:this.currentTool===1?this.state.cherries[e]||this.state.portals[e]!==null?this.paintAction=null:this.paintAction=!this.state.walls[e]:this.currentTool===0?this.paintAction=!1:this.currentTool===3?this.paintAction=!0:this.currentTool===4&&(this.paintAction=!this.state.cherries[e])}getBrushCells(e){let t=e%this.state.cols,n=Math.floor(e/this.state.cols),o=[],i=Math.floor((this.brushSize-1)/2);for(let a=0;a<this.brushSize;a++)for(let l=0;l<this.brushSize;l++){let r=t-i+l,h=n-i+a;r>=0&&r<this.state.cols&&h>=0&&h<this.state.rows&&o.push(h*this.state.cols+r)}return o}applyPaint(e){if(this.paintAction===null)return;let t=!1;if(!(this.mode==="PLAYER"&&this.currentTool!==1)){if(this.currentTool===2&&this.mode==="EDITOR"){if(this.state.terrain[e]===1||this.state.cherries[e]||this.state.portals[e]!==null)return;this.state.playerIdx!==e&&(this.state.playerIdx=e,t=!0)}else if(this.currentTool===1){let n=this.mode==="EDITOR"?this.getBrushCells(e):[e],o=!1;for(let i of n)if(i!==this.state.playerIdx&&this.state.terrain[i]!==1){if(this.state.portals[i]!==null){this.mode==="PLAYER"&&this.paintAction===!0&&this.triggerPortalBlocked(i);continue}if(this.state.cherries[i]){this.mode==="PLAYER"&&this.paintAction===!0&&this.triggerCherryBlocked(i);continue}if(this.paintAction===!0&&this.state.walls.filter(l=>l).length>=this.state.budget){o=!0;continue}if(this.state.walls[i]!==this.paintAction){if(this.state.walls[i]=this.paintAction,this.paintAction){let a=performance.now();this.wallPlacedTime.set(i,a),this.fastRenderUntil=a+this.WALL_FRAME_DURATION*4+50}else this.wallPlacedTime.delete(i);t=!0}}o&&this.onBudgetExceeded?.()}else if(this.mode==="EDITOR"&&(this.currentTool===0||this.currentTool===3)){let n=this.getBrushCells(e),o=this.paintAction?1:0;for(let i of n)i===this.state.playerIdx&&o===1||(this.state.terrain[i]!==o?(this.state.terrain[i]=o,this.state.walls[i]=!1,this.state.cherries[i]=!1,this.removePortalAndPartner(i),t=!0):o===0&&(this.state.walls[i]&&(this.state.walls[i]=!1,this.wallPlacedTime.delete(i),t=!0),this.state.cherries[i]&&(this.state.cherries[i]=!1,t=!0),this.state.portals[i]!==null&&(this.removePortalAndPartner(i),t=!0)));t&&(this.cellBfsDistance.clear(),this.animTime=0,this.animLastUpdate=0)}else if(this.mode==="EDITOR"&&this.currentTool===4){let n=this.getBrushCells(e);for(let o of n)o!==this.state.playerIdx&&this.state.terrain[o]!==1&&(this.state.walls[o]||this.state.portals[o]===null&&this.state.cherries[o]!==this.paintAction&&(this.state.cherries[o]=this.paintAction,t=!0))}t&&this.update()}}update(){this.lastSolveResult=this.getSolveResult();let e=this.lastSolveResult.escaped,t=e?null:this.lastSolveResult.visited,n=this.prevVisited===null;if(!(n&&e))if(!n&&!e){let o=this.prevVisited,i=t;if(!(o.size===i.size&&[...o].every(r=>i.has(r)))){let r=[...i].filter(d=>!o.has(d)),h=[...o].filter(d=>!i.has(d)),u=performance.now();if(r.length>0&&h.length===0)for(let d of r)this.instantGrowCells.set(d,u),this.shrunkCells.delete(d);else if(h.length>0&&r.length===0)for(let d of h)this.instantShrinkCells.set(d,u);else{for(let d of r)this.instantGrowCells.set(d,u),this.shrunkCells.delete(d);for(let d of h)this.instantShrinkCells.set(d,u)}this.computeBfsDistances(i),this.animTime=this.animTotalDuration,this.animLastUpdate=0,this.triggerFastRender()}}else n&&!e?this.startWaveAnimation(!1):this.startWaveAnimation(!0);this.prevVisited=t?new Set(t):null,this.render(),this.onStateChange?.()}triggerFastRender(){this.fastRenderUntil=performance.now()+this.INSTANT_GROW_DURATION+50}startWaveAnimation(e){this.floodFillAnimId&&cancelAnimationFrame(this.floodFillAnimId);let t=performance.now(),n=this.lastSolveResult?.visited||new Set;if(this.instantGrowCells.clear(),this.instantShrinkCells.clear(),this.shrunkCells.clear(),this.cherryWaveHit.clear(),this.cherryTextStart.clear(),!e){if(this.cellBfsDistance.size>0&&this.cellBfsDistance.size===n.size&&[...this.cellBfsDistance.keys()].every(i=>n.has(i))){this.syncAnimTime(t),this.animDirection=1,this.animLastUpdate=t,this.runWaveAnimationLoop();return}this.computeBfsDistances(n),this.animTime=0}this.syncAnimTime(t),this.animDirection=e?-1:1,this.animLastUpdate=t,this.runWaveAnimationLoop()}syncAnimTime(e){if(this.animLastUpdate>0){let t=e-this.animLastUpdate;this.animTime+=t*this.animDirection,this.animTime=Math.max(0,Math.min(this.animTotalDuration,this.animTime))}}computeBfsDistances(e){this.cellBfsDistance.clear();let t=[[this.state.playerIdx,0]],n=new Set([this.state.playerIdx]),o=0,i=new Map;for(let a=0;a<this.state.portals.length;a++){let l=this.state.portals[a];l!==null&&(i.has(l)||i.set(l,[]),i.get(l).push(a))}for(;t.length>0;){let[a,l]=t.shift();if(!e.has(a))continue;this.cellBfsDistance.set(a,l),o=Math.max(o,l);let r=a%this.state.cols,h=Math.floor(a/this.state.cols),u=[[-1,0],[1,0],[0,-1],[0,1]];for(let[c,p]of u){let g=r+c,m=h+p;if(g>=0&&g<this.state.cols&&m>=0&&m<this.state.rows){let f=m*this.state.cols+g;!n.has(f)&&e.has(f)&&(n.add(f),t.push([f,l+1]))}}let d=this.state.portals[a];if(d!==null){let c=i.get(d)||[];for(let p of c)p!==a&&!n.has(p)&&e.has(p)&&(n.add(p),t.push([p,l+1]))}}this.animTotalDuration=o*this.WAVE_DELAY+this.GROW_DURATION}runWaveAnimationLoop(){let t=()=>{let n=performance.now(),o=n-this.animLastUpdate;this.animLastUpdate=n;let i=this.animDirection<0?1.8:1;this.animTime+=o*this.animDirection*i,this.animTime=Math.max(0,Math.min(this.animTotalDuration,this.animTime)),this.render(),this.animDirection>0&&this.animTime>=this.animTotalDuration||this.animDirection<0&&this.animTime<=0?(this.floodFillAnimId=null,this.animDirection<0&&(this.cellBfsDistance.clear(),this.animTime=0,this.animLastUpdate=0)):this.floodFillAnimId=requestAnimationFrame(t)};this.floodFillAnimId=requestAnimationFrame(t)}getWheatProgress(e,t){if(this.shrunkCells.has(e))return 0;let n=this.instantShrinkCells.get(e);if(n!==void 0){let a=performance.now()-n,l=Math.min(1,a/this.INSTANT_GROW_DURATION);return l>=1?(this.instantShrinkCells.delete(e),this.shrunkCells.add(e),0):1-l}let o=this.instantGrowCells.get(e);if(o!==void 0){let a=performance.now()-o,l=Math.min(1,a/this.INSTANT_GROW_DURATION);return l>=1&&this.instantGrowCells.delete(e),l}let i=this.cellBfsDistance.get(e);if(i!==void 0&&this.animLastUpdate>0){let a=i*this.WAVE_DELAY,l=Math.max(0,Math.min(1,(this.animTime-a)/this.GROW_DURATION));if(l>0&&this.animDirection>0&&this.state.cherries[e]&&!this.cherryWaveHit.has(e)){let r=performance.now();this.cherryWaveHit.set(e,r),this.cherryTextStart.set(e,r)}return l}return t.has(e)&&!this.lastSolveResult?.escaped?1:0}startRenderLoop(){if(this.renderLoopId)return;let e=()=>{let t=H(),n=performance.now();(t!==this.lastRenderFrame||n<this.fastRenderUntil)&&(this.lastRenderFrame=t,this.render()),this.renderLoopId=requestAnimationFrame(e)};this.renderLoopId=requestAnimationFrame(e)}triggerCherryBlocked(e){let t=performance.now(),n=this.cherryBlockedStart.get(e);n&&t-n<400||(this.cherryBlockedStart.set(e,t),this.fastRenderUntil=t+600)}triggerPortalBlocked(e){let t=performance.now(),n=this.portalBlockedStart.get(e);if(n&&t-n<400)return;this.portalBlockedStart.set(e,t),this.fastRenderUntil=t+600,window.innerWidth<768&&this.selectPortalForConnection(e)}selectPortalForConnection(e){if(this.selectedPortalTimeout!==null&&clearTimeout(this.selectedPortalTimeout),this.selectedPortalIdx===e){this.selectedPortalIdx=-1,this.selectedPortalTimeout=null;return}this.selectedPortalIdx=e,this.fastRenderUntil=performance.now()+4e3,this.selectedPortalTimeout=window.setTimeout(()=>{this.selectedPortalIdx=-1,this.selectedPortalTimeout=null,this.render()},3e3)}clearSelectedPortal(){this.selectedPortalIdx!==-1&&(this.selectedPortalIdx=-1,this.selectedPortalTimeout!==null&&(clearTimeout(this.selectedPortalTimeout),this.selectedPortalTimeout=null))}removePortalAndPartner(e){let t=this.state.portals[e];if(t!==null){for(let n=0;n<this.state.portals.length;n++)this.state.portals[n]===t&&(this.state.portals[n]=null);t===this.pendingPortalChannel&&(this.pendingPortalChannel=null)}}handlePortalClick(e){if(e!==this.state.playerIdx&&this.state.terrain[e]!==1&&!this.state.walls[e]&&!this.state.cherries[e]){if(this.undoStack.push({cols:this.state.cols,rows:this.state.rows,terrain:[...this.state.terrain],walls:[...this.state.walls],cherries:[...this.state.cherries],portals:[...this.state.portals],playerIdx:this.state.playerIdx}),this.redoStack=[],this.state.portals[e]!==null)this.removePortalAndPartner(e);else if(this.pendingPortalChannel!==null)this.state.portals[e]=this.pendingPortalChannel,this.pendingPortalChannel=null;else{let t=this.getNextAvailableChannel();if(t!==null)this.state.portals[e]=t,this.pendingPortalChannel=t;else{this.undoStack.pop(),this.onMaxPortalsReached?.();return}}this.update(),this.onStateChange?.()}}getNextPortalChannel(){return this.pendingPortalChannel??this.getNextAvailableChannel()}getNextAvailableChannel(){let e=new Set;for(let t of this.state.portals)t!==null&&e.add(t);for(let t=0;t<36;t++)if(!e.has(t))return t;return null}render(){if(!this.ready)return;let e=this.lastSolveResult||this.getSolveResult(),t={state:this.state,mode:this.mode,currentTool:this.currentTool,brushSize:this.brushSize,gridOffsetX:this.gridOffsetX,gridOffsetY:this.gridOffsetY,tileSize:this.tileSize,solveResult:e,hoverIdx:this.hoverIdx,selectedPortalIdx:this.selectedPortalIdx,isMouseDown:this.isMouseDown,hoveringPlayer:this.hoveringPlayer,hoverAnimProgress:this.hoverAnimProgress,bubbleAnimProgress:this.bubbleAnimProgress,thoughtText:this.thoughtText,horseClicked:this.horseClicked,showEscapePath:this.showEscapePath,cellBfsDistance:this.cellBfsDistance,animTime:this.animTime,animDirection:this.animDirection,animLastUpdate:this.animLastUpdate,animTotalDuration:this.animTotalDuration,instantGrowCells:this.instantGrowCells,instantShrinkCells:this.instantShrinkCells,shrunkCells:this.shrunkCells,wallPlacedTime:this.wallPlacedTime,WAVE_DELAY:this.WAVE_DELAY,GROW_DURATION:this.GROW_DURATION,INSTANT_GROW_DURATION:this.INSTANT_GROW_DURATION,MARCH_SPEED:this.MARCH_SPEED,WALL_FRAME_DURATION:this.WALL_FRAME_DURATION,getBrushCells:n=>this.getBrushCells(n),getWheatProgress:(n,o)=>this.getWheatProgress(n,o),gridOpacity:this.gridOpacity,darkGridlines:this.darkGridlines,portalLabels:this.portalLabels,hideHorseThoughts:this.hideHorseThoughts,optimalOverlay:this.optimalOverlay,cherryTextStart:this.cherryTextStart,cherryBlockedStart:this.cherryBlockedStart,portalBlockedStart:this.portalBlockedStart,nextPortalChannel:this.pendingPortalChannel??this.getNextAvailableChannel()};Tt(this.ctx,this.canvas,t),(t._hasCherryTextAnimations||t._hasCherryBlockedAnimations)&&(this.fastRenderUntil=performance.now()+100)}renderPreview(){if(!this.ready)return;let e=this.lastSolveResult||this.getSolveResult(),t={state:this.state,mode:this.mode,currentTool:this.currentTool,brushSize:this.brushSize,gridOffsetX:this.gridOffsetX,gridOffsetY:this.gridOffsetY,tileSize:this.tileSize,solveResult:e,hoverIdx:-1,selectedPortalIdx:-1,isMouseDown:!1,hoveringPlayer:!1,hoverAnimProgress:0,bubbleAnimProgress:0,thoughtText:["",""],horseClicked:!1,showEscapePath:!1,cellBfsDistance:new Map,animTime:0,animDirection:0,animLastUpdate:0,animTotalDuration:0,instantGrowCells:new Map,instantShrinkCells:new Map,shrunkCells:new Set,wallPlacedTime:new Map,WAVE_DELAY:this.WAVE_DELAY,GROW_DURATION:this.GROW_DURATION,INSTANT_GROW_DURATION:this.INSTANT_GROW_DURATION,MARCH_SPEED:this.MARCH_SPEED,WALL_FRAME_DURATION:this.WALL_FRAME_DURATION,getBrushCells:n=>this.getBrushCells(n),getWheatProgress:()=>0,hideGridLines:!0,hideWheat:!0};Tt(this.ctx,this.canvas,t)}};var ot=class{container;titleEl=null;dayNumberEl=null;helpBtn=null;menuBtn=null;lastFrame=-1;constructor(e,t){this.container=e,this.render(t),this.startWiggle()}render(e){let t=e.dayNumber?`<div class="navbar-subtitle" id="dayNumber"${e.showCountdown?' data-tooltip=""':""}>Day ${e.dayNumber}</div>`:"";this.container.innerHTML=`
            <style>
                #dayNumber {
                    position: relative;
                    cursor: default;
                }
                #dayNumber[data-tooltip]::after {
                    content: attr(data-tooltip);
                    position: absolute;
                    top: 100%;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #333;
                    color: #fff;
                    padding: 0 12px;
                    border-radius: 0;
                    font-size: 13px;
                    white-space: nowrap;
                    opacity: 0;
                    pointer-events: none;
                    transition: opacity 0.15s;
                    z-index: 100;
                    height: 32px;
                    display: flex;
                    align-items: center;
                }
                #dayNumber[data-tooltip]:hover::after {
                    opacity: 1;
                }
            </style>
            <nav class="navbar">
                <div class="navbar-row">
                    <div style="display: flex; gap: 4px; min-width: 76px;">
                        <button class="navbar-btn" id="btnHelp">?</button>
                    </div>
                    <a href="/" class="navbar-title" id="siteTitle"><span>e</span><span>n</span><span>c</span><span>l</span><span>o</span><span>s</span><span>e</span><span>.</span><span>h</span><span>o</span><span>r</span><span>s</span><span>e</span></a>
                    <div style="display: flex; gap: 4px; min-width: 76px; justify-content: flex-end;">
                        <button class="navbar-btn hamburger" id="btnMenu"><span>--</span><span>--</span><span>--</span></button>
                    </div>
                </div>
                ${t?`<div class="navbar-row navbar-row-subtitle">${t}</div>`:""}
            </nav>
        `,this.titleEl=this.container.querySelector("#siteTitle"),this.dayNumberEl=this.container.querySelector("#dayNumber"),this.helpBtn=this.container.querySelector("#btnHelp"),this.menuBtn=this.container.querySelector("#btnMenu"),this.helpBtn?.addEventListener("click",e.onHelpClick),this.menuBtn?.addEventListener("click",e.onMenuClick),this.dayNumberEl&&e.showCountdown&&(this.updateCountdown(),setInterval(()=>this.updateCountdown(),1e3))}updateCountdown(){if(!this.dayNumberEl)return;let e=new Date,t=new Date(e);t.setHours(24,0,0,0);let n=t.getTime()-e.getTime(),o=Math.floor(n/(1e3*60*60)),i=Math.floor(n%(1e3*60*60)/(1e3*60)),a=Math.floor(n%(1e3*60)/1e3),l=r=>String(r).padStart(2,"0");this.dayNumberEl.dataset.tooltip=`Next puzzle in ${l(o)}:${l(i)}:${l(a)}`}startWiggle(){let e=()=>{let t=H();t!==this.lastFrame&&(this.lastFrame=t,this.wiggleTitle(),this.wiggleDayNumber(),this.wiggleHelp(),this.wiggleMenu()),requestAnimationFrame(e)};e()}wiggleTitle(){if(!this.titleEl)return;this.titleEl.querySelectorAll("span").forEach((t,n)=>{let o=W(n*3)*1.5,i=W(n*3+1)*1.5,a=W(n*3+2)*3;t.style.transform=`translate(${o}px, ${i}px) rotate(${a}deg)`})}wiggleDayNumber(){if(!this.dayNumberEl)return;let e=W(150)*1.5,t=W(151)*1,n=W(152)*2;this.dayNumberEl.style.transform=`translate(${e}px, ${t}px) rotate(${n}deg)`}wiggleHelp(){if(!this.helpBtn)return;let e=W(100)*2,t=W(101)*2,n=W(102)*4;this.helpBtn.style.transform=`translate(${e}px, ${t}px) rotate(${n}deg)`}wiggleMenu(){if(!this.menuBtn)return;this.menuBtn.querySelectorAll("span").forEach((t,n)=>{let o=W(200+n*3)*1.5,i=W(201+n*3)*1,a=W(202+n*3)*3;t.style.transform=`translate(${o}px, ${i}px) rotate(${a}deg)`})}setHelpActive(e){this.helpBtn&&this.helpBtn.classList.toggle("active",e)}setMenuActive(e){this.menuBtn&&this.menuBtn.classList.toggle("active",e)}};var ii={howToPlay:"How to Play",howToEdit:"How to Edit",levelInfo:"This Level",howToBrowse:"Browsing"},at=class{overlay;options;canvas=null;ctx=null;closeCanvas=null;closeCtx=null;unregisterAnim=null;isVisible=!1;resizeObserver=null;activeTab="";tabCanvases=new Map;constructor(e,t){this.options=t,this.overlay=document.createElement("div"),this.overlay.className="modal-overlay",this.overlay.id="helpOverlay",e.appendChild(this.overlay),this.render(),this.setupEvents(),this.populateLevelInfo(),this.overlay.style.opacity="0",this.overlay.style.pointerEvents="none",this.overlay.classList.add("visible"),requestAnimationFrame(()=>{let n=this.overlay.querySelectorAll(".wiggly-modal-tab-content"),o=this.overlay.querySelector(".wiggly-modal-content"),i=0;n.forEach(a=>a.style.display="none"),n.forEach(a=>{a.style.display="block",i=Math.max(i,o.offsetHeight),a.style.display="none"}),n[0]&&(n[0].style.display="block"),this.maxContentHeight=i,o.style.minHeight=`${i}px`,this.setupCanvas(),this.renderCanvas(),this.options.showImmediately?(this.overlay.style.opacity="",this.overlay.style.pointerEvents="",this.isVisible=!0,this.options.onShow?.()):(this.overlay.classList.remove("visible"),this.overlay.style.opacity="",this.overlay.style.pointerEvents=""),this.startAnimation()})}maxContentHeight=0;render(){let{tabs:e}=this.options,t=e.length>1,n="";t&&(n=`
                <div class="wiggly-modal-tabs" style="display: flex; margin-bottom: 16px;">
                    ${e.map((l,r)=>`
                        <div class="wiggly-tab-wrapper" style="flex: 1; position: relative;">
                            <canvas class="wiggly-tab-bg" data-tab="${l}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                            <button class="wiggly-modal-tab" data-tab="${l}" style="position: relative; z-index: 1; width: 100%; padding: 10px 16px; background: none; border: none; color: #000; font-size: 16px; font-family: 'Schoolbell', cursive; cursor: pointer;">${ii[l]}</button>
                        </div>
                    `).join("")}
                </div>
            `);let o=e.map((l,r)=>`
            <div class="wiggly-modal-tab-content" id="tab-${l}" style="display: ${r===0?"block":"none"};">
                ${this.getTabContent(l)}
            </div>
        `).join("");this.overlay.innerHTML=`
            <div style="display: flex; flex-direction: column; align-items: center;">
                <canvas id="helpClose" style="align-self: flex-end; cursor: pointer; margin-bottom: -6px;" width="40" height="40"></canvas>
                <div class="wiggly-modal" style="position: relative; width: 400px; max-width: calc(100vw - 32px); max-height: calc(100dvh - 100px); display: flex; flex-direction: column;">
                    <canvas class="wiggly-modal-bg" style="display: block; position: absolute; top: 0; left: 0; z-index: 0;"></canvas>
                    <div class="wiggly-modal-scroll" style="overflow-y: auto; margin: 12px; margin-right: 14px; flex: 1; min-height: 0; position: relative; z-index: 2;">
                        <div class="wiggly-modal-content" style="position: relative; z-index: 1; padding: 20px; color: #000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        ${n}
                        ${o}
                    </div>
                    </div>
                </div>
            </div>
        `,this.canvas=this.overlay.querySelector(".wiggly-modal-bg"),this.ctx=this.canvas.getContext("2d"),this.closeCanvas=this.overlay.querySelector("#helpClose"),this.closeCtx=this.closeCanvas?.getContext("2d")||null,this.tabCanvases.clear(),this.overlay.querySelectorAll(".wiggly-tab-bg").forEach(l=>{let r=l.getAttribute("data-tab");r&&this.tabCanvases.set(r,l)});let a=this.overlay.querySelector(".wiggly-modal");a&&(this.resizeObserver=new ResizeObserver(()=>{this.isVisible&&(this.setupCanvas(),this.renderCanvas())}),this.resizeObserver.observe(a)),this.options.tabs.length>0&&(this.activeTab=this.options.tabs[0])}getTabContent(e){switch(e){case"howToPlay":return`
                    <p style="color: #333; line-height: 1.7; margin-bottom: 16px; font-family: 'Schoolbell', cursive; font-size: 18px;">Enclose the horse in the biggest possible pen!</p>

                    <h3 style="color: #000; font-size: 18px; margin: 16px 0 10px 0; font-family: 'Schoolbell', cursive;">The Rules</h3>
                    <ul style="color: #444; line-height: 2; padding-left: 20px; margin-bottom: 12px; font-family: 'Schoolbell', cursive; font-size: 16px;">
                        <li>Click grass tiles to place walls.</li>
                        <li>You have limited walls.</li>
                        <li>Horses can't move diagonally or over water.</li>
                        ${this.options.hasCherries?.()?'<li>Enclosed <span style="color: #c0392b;">cherries</span> give +3 points!</li>':""}
                        ${this.options.hasPortals?.()?'<li><span style="color: #9b59b6;">Portals</span> connect distant cells - the horse can teleport through them!</li>':""}
                        <li>Bigger enclosure = bigger score, but <span style="background: #f1c40f; padding: 0 4px;">you only have one chance to submit!</span></li>
                    </ul>

                    <div style="background: rgba(0,0,0,0.06); padding: 12px 16px; margin: 16px 0; color: #444; font-family: 'Schoolbell', cursive; font-size: 15px;">
                        <strong style="color: #000;">Tip:</strong> Hover or tap the horse to see how he'll escape!
                    </div>
                `;case"howToEdit":return`
                    <p style="color: #333; line-height: 1.7; margin-bottom: 16px; font-family: 'Schoolbell', cursive; font-size: 18px;">Create puzzles for others to solve!</p>

                    <h3 style="color: #000; font-size: 18px; margin: 16px 0 10px 0; font-family: 'Schoolbell', cursive;">Tools</h3>
                    <ul style="color: #444; line-height: 2; padding-left: 20px; margin-bottom: 12px; font-family: 'Schoolbell', cursive; font-size: 16px;">
                        <li><strong style="color: #000;">Grass</strong> - Walkable terrain</li>
                        <li><strong style="color: #000;">Water</strong> - Impassable obstacle</li>
                        <li><strong style="color: #000;">Wall</strong> - For testing (cleared when published)</li>
                        <li><strong style="color: #000;">Horse</strong> - Adjust starting position</li>
                        <li><strong style="color: #000;">Cherry</strong> - Bonus tiles worth +3 when enclosed</li>
                        <li><strong style="color: #000;">Portal</strong> - Connect distant cells (click twice to pair)</li>
                    </ul>

                    <h3 style="color: #000; font-size: 18px; margin: 16px 0 10px 0; font-family: 'Schoolbell', cursive;">Controls</h3>
                    <ul style="color: #444; line-height: 2; padding-left: 20px; margin-bottom: 12px; font-family: 'Schoolbell', cursive; font-size: 16px;">
                        <li><strong style="color: #000;">Brush Size</strong> - Paint 1x1 to 4x4 areas</li>
                        <li><strong style="color: #000;">Size</strong> - Grid dimensions</li>
                        <li><strong style="color: #000;">Walls</strong> - Budget for players</li>
                    </ul>
                    <p style="color: #333; line-height: 1.7; margin-bottom: 16px; font-family: 'Schoolbell', cursive; font-size: 18px;">To publish, you must first enclose the horse to prove it's solvable!</p>

                    <div style="background: rgba(0,0,0,0.06); padding: 12px 16px; margin: 16px 0; color: #444; font-family: 'Schoolbell', cursive; font-size: 15px;">
                        <strong style="color: #000;">Tip:</strong> Use Play to test your puzzle before publishing!
                    </div>
                `;case"levelInfo":return`
                    <div style="display: flex; flex-direction: column; gap: 4px; font-family: 'Schoolbell', cursive; font-size: 16px;">
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ccc;">
                            <span style="color: #666;">Name</span>
                            <span style="color: #000;" id="infoLevelName">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ccc;">
                            <span style="color: #666;">Made by</span>
                            <span style="color: #000;" id="infoCreatorName">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ccc;">
                            <span style="color: #666;">Size</span>
                            <span style="color: #000;" id="infoLevelSize">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ccc;">
                            <span style="color: #666;">Wall Budget</span>
                            <span style="color: #000;" id="infoWallBudget">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ccc;">
                            <span style="color: #666;">Times Played</span>
                            <span style="color: #000;" id="infoPlayCount">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                            <span style="color: #666;">Level ID</span>
                            <span style="color: #000;" id="infoLevelId">-</span>
                        </div>
                    </div>
                    <div id="reportSection" style="margin-top: 0; padding-top: 20px; border-top: 1px solid #ddd;">
                        <div id="reportToggleBtnContainer" style="display: flex; justify-content: center; margin-top: 8px;"></div>
                        <div id="reportForm" style="display: none; margin-top: 12px;">
                            <p style="margin: 0 0 10px 0; font-family: 'Schoolbell', cursive; font-size: 15px; color: #333;">Why are you reporting this level?</p>
                            <div style="display: flex; flex-direction: column; gap: 8px; font-family: 'Schoolbell', cursive; font-size: 15px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="reportReason" value="inappropriate" style="width: 16px; height: 16px; cursor: pointer; accent-color: #f1c40f;">
                                    <span>Inappropriate</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="reportReason" value="impossible" style="width: 16px; height: 16px; cursor: pointer; accent-color: #f1c40f;">
                                    <span>Impossible</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="reportReason" value="other" style="width: 16px; height: 16px; cursor: pointer; accent-color: #f1c40f;">
                                    <span>Other:</span>
                                    <input type="text" id="reportOtherText" maxlength="200" placeholder="Please specify..." style="flex: 1; padding: 2px 8px; font-family: 'Schoolbell', cursive; font-size: 15px; border: none; border-radius: 0; background: #e8e8e8; outline: none; box-sizing: border-box; height: 22px;">
                                </label>
                            </div>
                            <div id="reportError" style="display: none; color: #c0392b; font-family: 'Schoolbell', cursive; font-size: 14px; margin-top: 8px;">
                                Please select a reason
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 20px; justify-content: center;">
                                <div id="reportSubmitBtnContainer"></div>
                                <div id="reportCancelBtnContainer"></div>
                            </div>
                        </div>
                        <div id="reportSubmitted" style="display: none; color: #27ae60; font-family: 'Schoolbell', cursive; font-size: 14px; text-align: center; margin-top: 16px;">
                            \u2713 Report submitted. Thank you!
                        </div>
                    </div>
                `;case"howToBrowse":return`
                    <p style="color: #333; line-height: 1.7; margin-bottom: 16px; font-family: 'Schoolbell', cursive; font-size: 18px;">Discover puzzles made by the community!</p>

                    <h3 style="color: #000; font-size: 18px; margin: 16px 0 10px 0; font-family: 'Schoolbell', cursive;">Browsing</h3>
                    <ul style="color: #444; line-height: 2; padding-left: 20px; margin-bottom: 12px; font-family: 'Schoolbell', cursive; font-size: 16px;">
                        <li>Click any level card to play it.</li>
                        <li>Sort by Most Played, Newest, or Highest Rated.</li>
                        <li>Each card shows the level size and play count.</li>
                    </ul>

                    <div style="background: rgba(0,0,0,0.06); padding: 12px 16px; margin: 16px 0; color: #444; font-family: 'Schoolbell', cursive; font-size: 15px;">
                        <strong style="color: #000;">Tip:</strong> Create your own levels in the editor and share them with friends!
                    </div>
                `}}setupEvents(){this.overlay.querySelector("#helpClose")?.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",o=>{o.target===this.overlay&&this.hide()});let t=this.overlay.querySelectorAll(".wiggly-modal-tab"),n=this.overlay.querySelectorAll(".wiggly-modal-tab-content");t.forEach(o=>{o.addEventListener("click",()=>{let i=o.getAttribute("data-tab");if(!i)return;this.activeTab=i,n.forEach(l=>{l.style.display="none"});let a=this.overlay.querySelector(`#tab-${i}`);a&&(a.style.display="block"),this.renderTabCanvases()})}),this.setupReportEvents()}reportToggleBtn=null;reportSubmitBtn=null;reportCancelBtn=null;setupReportEvents(){let e=this.overlay.querySelector("#reportToggleBtnContainer"),t=this.overlay.querySelector("#reportForm"),n=this.overlay.querySelectorAll('input[name="reportReason"]'),o=this.overlay.querySelector("#reportOtherText"),i=this.overlay.querySelector("#reportError"),a=this.overlay.querySelector("#reportSubmitBtnContainer"),l=this.overlay.querySelector("#reportCancelBtnContainer"),r=this.overlay.querySelector("#reportSubmitted");!e||!t||!a||!l||!r||(this.reportToggleBtn=new _(e,{text:"Report Level",onClick:()=>{e.style.display="none",t.style.display="block"},width:140,height:40,fontSize:16,fillColor:"#c0392b",hoverFillColor:"#e74c3c",textColor:"#ffffff",seedOffset:8e3}),this.reportSubmitBtn=new _(a,{text:"Submit",onClick:async()=>{let h="";if(n.forEach(d=>{if(d.checked)if(d.value==="other"){let c=o?.value.trim();h=c?`Other: ${c}`:""}else h=d.value}),this.overlay.querySelector('input[name="reportReason"][value="other"]')?.checked&&!o?.value.trim()){i&&(i.textContent="Please specify the reason",i.style.display="block");return}if(!h){i&&(i.textContent="Please select a reason",i.style.display="block");return}if(this.options.onReport){this.reportSubmitBtn?.setDisabled(!0),this.reportSubmitBtn?.setText("...");try{await this.options.onReport(h),t.style.display="none",r.style.display="block"}catch(d){alert("Error submitting report: "+d.message),this.reportSubmitBtn?.setDisabled(!1),this.reportSubmitBtn?.setText("Submit")}}},width:90,height:36,fontSize:16,inverted:!0,seedOffset:8100}),this.reportCancelBtn=new _(l,{text:"Cancel",onClick:()=>{t.style.display="none",e.style.display="flex",n.forEach(h=>h.checked=!1),o&&(o.value=""),i&&(i.style.display="none")},width:90,height:36,fontSize:16,inverted:!0,seedOffset:8200}),n.forEach(h=>{h.addEventListener("change",()=>{i&&(i.style.display="none")})}),o&&o.addEventListener("focus",()=>{let h=this.overlay.querySelector('input[name="reportReason"][value="other"]');h&&(h.checked=!0),i&&(i.style.display="none")}))}setupCanvas(){if(!this.canvas||!this.ctx)return;let e=this.overlay.querySelector(".wiggly-modal");if(!e)return;let t=window.devicePixelRatio||1,n=e.offsetWidth,o=e.offsetHeight;this.canvas.width=n*t,this.canvas.height=o*t,this.canvas.style.width=`${n}px`,this.canvas.style.height=`${o}px`}renderCanvas(){if(!this.ctx||!this.canvas)return;let e=this.canvas.width,t=this.canvas.height,n=window.devicePixelRatio||1;this.ctx.clearRect(0,0,e,t),Q(this.ctx,e,t,{fillColor:"#ffffff",padding:6,jitter:2.5,seedOffset:5e3,dpr:n}),this.renderTabCanvases(),this.renderCloseButton()}renderCloseButton(){if(!this.closeCtx||!this.closeCanvas)return;let e=window.devicePixelRatio||1,t=40;this.closeCanvas.width=t*e,this.closeCanvas.height=t*e,this.closeCanvas.style.width=`${t}px`,this.closeCanvas.style.height=`${t}px`;let n=this.closeCtx;n.clearRect(0,0,this.closeCanvas.width,this.closeCanvas.height);let o=H(),i=oe(42,o,.8,8e3);n.font=`${36*e}px Schoolbell, cursive`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#ffffff",n.fillText("\xD7",t*e/2+i.x*e,t*e/2+i.y*e)}renderTabCanvases(){let e=window.devicePixelRatio||1;this.tabCanvases.forEach((t,n)=>{let o=t.getContext("2d");if(!o)return;let i=t.parentElement;if(i){let a=i.offsetWidth,l=i.offsetHeight;t.width=a*e,t.height=l*e,t.style.width=`${a}px`,t.style.height=`${l}px`}o.clearRect(0,0,t.width,t.height),n===this.activeTab?Q(o,t.width,t.height,{fillColor:"#f1c40f",padding:3,jitter:1.5,seedOffset:6e3+n.charCodeAt(0)*100,dpr:e}):Q(o,t.width,t.height,{fillColor:"#f0f0f0",padding:3,jitter:0,seedOffset:6e3+n.charCodeAt(0)*100,dpr:e})})}startAnimation(){this.unregisterAnim||(this.unregisterAnim=he.register(()=>{this.isVisible&&(this.setupCanvas(),this.renderCanvas())}))}stopAnimation(){this.unregisterAnim?.(),this.unregisterAnim=null}populateLevelInfo(){if(this.options.tabs.includes("levelInfo")&&this.options.getLevelInfo){let e=this.options.getLevelInfo(),t=this.overlay.querySelector("#infoLevelName"),n=this.overlay.querySelector("#infoCreatorName"),o=this.overlay.querySelector("#infoLevelSize"),i=this.overlay.querySelector("#infoWallBudget"),a=this.overlay.querySelector("#infoPlayCount"),l=this.overlay.querySelector("#infoLevelId");t&&(t.textContent=e.name||"Unnamed"),n&&(n.textContent=e.creatorName||"Anonymous"),o&&(o.textContent=`${e.cols} x ${e.rows}`),i&&(i.textContent=String(e.budget)),a&&(a.textContent=String(e.playCount)),l&&(l.textContent=e.id),this.updateReportSection()}}updateReportSection(){let e=this.overlay.querySelector("#reportToggleBtnContainer"),t=this.overlay.querySelector("#reportForm"),n=this.overlay.querySelector("#reportSubmitted"),o=this.overlay.querySelector("#reportSection");if(!e||!t||!n)return;if(!this.options.onReport){o&&(o.style.display="none");return}this.options.getReportStatus?.()?(e.style.display="none",t.style.display="none",n.style.display="block",n.textContent="\u2713 You reported this level"):(e.style.display="flex",t.style.display="none",n.style.display="none")}show(){this.populateLevelInfo(),this.isVisible=!0,this.overlay.classList.add("visible"),this.options.onShow?.()}hide(){this.isVisible=!1,this.overlay.classList.remove("visible"),this.options.onHide?.()}};function lt(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function _s(s,e,t,n,o,i){let a=e==="happy"?")":"(",l=o*.15,r=o*.5;s.fillStyle=i,s.textBaseline="middle",s.font=`${o}px Schoolbell, cursive`;let h=s.measureText(":").width;s.font=`${r}px Schoolbell, cursive`;let u=s.measureText(a).width,d=h+l+u;s.save(),s.translate(t,n),s.rotate(Math.PI/2);let c=-d/2;s.font=`${o}px Schoolbell, cursive`,s.textAlign="left",s.fillText(":",c,-o*.1),s.font=`${r}px Schoolbell, cursive`,s.fillText(a,c+h+l,o*.05),s.restore()}var rt={perfect:"#d4f4ff",gold:"#fff0b3",silver:"#e0e0e0",bronze:"#e8d4c4"};function oi(s,e){let t=s/e*100;return t>=100?{emoji:"\u{1F48E}",label:"PERFECT!",shareLine:"\u{1F48E} PERFECT! \u{1F48E}",bgColor:rt.perfect}:t>=90?{emoji:"\u{1F947}",label:"Excellent!",shareLine:"\u{1F947} Excellent! \u{1F947}",bgColor:rt.gold}:t>=80?{emoji:"\u{1F948}",label:"Great",shareLine:"\u{1F948} Great \u{1F948}",bgColor:rt.silver}:{emoji:"\u{1F949}",label:"okay",shareLine:"\u{1F949} okay \u{1F949}",bgColor:rt.bronze}}function Ht(s){return String(s).split("").map((t,n)=>`<span class="dancing-digit" data-seed="${n}" style="display: inline-block; margin: 0 1px;">${t}</span>`).join("")}function ai(s){let t=Math.floor(Date.now()/1e3)-s;return t<60?"now":t<3600?`${Math.floor(t/60)}m`:t<86400?`${Math.floor(t/3600)}h`:t<604800?`${Math.floor(t/86400)}d`:t<2592e3?`${Math.floor(t/604800)}w`:`${Math.floor(t/2592e3)}mo`}function li(s){return new Date(s*1e3).toLocaleString()}function ri(s,e){if(s.length===0)return[];let t=s[0].minScore,o=s[s.length-1].maxScore-t;if(o<=e)return s;let i=Math.ceil(o/e),a=new Map;for(let l of s){let r=Math.floor((l.minScore-t)/i)*i+t,h=r+i-1,u=a.get(r);u?u.count+=l.count:a.set(r,{minScore:r,maxScore:h,count:l.count})}return Array.from(a.values()).sort((l,r)=>l.minScore-r.minScore)}var ht=class{overlay;canvas=null;ctx=null;closeCanvas=null;closeCtx=null;contentEl=null;modalEl=null;unregisterAnim=null;isVisible=!1;options;resizeObserver=null;shareBtn=null;shareText="";modalBgColor="#ffffff";optimalWalls=null;currentLevelId=null;currentVote=null;upvoteBtn=null;downvoteBtn=null;constructor(e,t){this.options=t,this.overlay=document.createElement("div"),this.overlay.className="modal-overlay",this.overlay.id="resultsOverlay",e.appendChild(this.overlay),this.render(),this.setupEvents(),this.startAnimation()}render(){this.overlay.innerHTML=`
            <style>
                .fast-tooltip {
                    position: relative;
                    cursor: default;
                }
                .fast-tooltip::after {
                    content: attr(data-tooltip);
                    position: absolute;
                    bottom: 100%;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #333;
                    color: #fff;
                    padding: 4px 8px;
                                        font-size: 12px;
                    white-space: nowrap;
                    opacity: 0;
                    pointer-events: none;
                    transition: opacity 0.15s;
                    z-index: 100;
                }
                .fast-tooltip:hover::after {
                    opacity: 1;
                }
            </style>
            <div style="position: relative;">
                <canvas id="resultsClose" style="position: absolute; top: -40px; right: 0; cursor: pointer;" width="40" height="40"></canvas>
                <div class="wiggly-modal" id="wigglyModal" style="position: relative; width: 500px; max-width: calc(100vw - 40px); max-height: calc(100dvh - 100px); display: flex; flex-direction: column; background: #fff;">
                    <canvas class="wiggly-modal-bg" style="display: block; position: absolute; top: 0; left: 0; z-index: 0; pointer-events: none;"></canvas>
                    <div class="wiggly-modal-scroll" style="overflow-y: auto; flex: 1; min-height: 0; position: relative; z-index: 2;">
                        <div class="wiggly-modal-content" id="resultsContent" style="position: relative; z-index: 1; padding: 20px 32px; color: #000; font-family: 'Schoolbell', cursive;">
                        </div>
                    </div>
                </div>
            </div>
        `,this.canvas=this.overlay.querySelector(".wiggly-modal-bg"),this.ctx=this.canvas?.getContext("2d")||null,this.closeCanvas=this.overlay.querySelector("#resultsClose"),this.closeCtx=this.closeCanvas?.getContext("2d")||null,this.contentEl=this.overlay.querySelector("#resultsContent"),this.modalEl=this.overlay.querySelector(".wiggly-modal"),this.modalEl&&(this.resizeObserver=new ResizeObserver(()=>{this.isVisible&&(this.setupCanvas(),this.renderCanvas())}),this.resizeObserver.observe(this.modalEl))}setupEvents(){this.closeCanvas?.addEventListener("click",()=>this.hide()),this.overlay.querySelector("div")?.addEventListener("click",t=>t.stopPropagation()),this.overlay.addEventListener("click",()=>this.hide())}setupCanvas(){if(!this.canvas||!this.ctx)return;let e=this.overlay.querySelector(".wiggly-modal");if(!e)return;let t=window.devicePixelRatio||1,n=e.offsetWidth,o=e.offsetHeight;this.canvas.width=n*t,this.canvas.height=o*t,this.canvas.style.width=`${n}px`,this.canvas.style.height=`${o}px`}renderCanvas(){if(!this.ctx||!this.canvas)return;let e=this.canvas.width,t=this.canvas.height,n=window.devicePixelRatio||1;this.ctx.clearRect(0,0,e,t),Q(this.ctx,e,t,{fillColor:this.modalBgColor,padding:6,jitter:2.5,seedOffset:8e3,dpr:n}),this.renderCloseButton()}renderCloseButton(){if(!this.closeCtx||!this.closeCanvas)return;let e=window.devicePixelRatio||1,t=40;this.closeCanvas.width=t*e,this.closeCanvas.height=t*e,this.closeCanvas.style.width=`${t}px`,this.closeCanvas.style.height=`${t}px`;let n=this.closeCtx;n.clearRect(0,0,this.closeCanvas.width,this.closeCanvas.height);let o=H(),i=oe(42,o,.8,8500);n.font=`${36*e}px Schoolbell, cursive`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#ffffff",n.fillText("\xD7",t*e/2+i.x*e,t*e/2+i.y*e)}startAnimation(){this.unregisterAnim||(this.unregisterAnim=he.register(()=>{this.isVisible&&(this.renderCanvas(),this.animateDancingDigits(),this.animateYouLabel(),this.updateModalClipPath())}))}animateDancingDigits(){let e=this.overlay.querySelectorAll(".dancing-digit"),t=H();e.forEach(n=>{let o=n,i=parseInt(o.dataset.seed||"0"),a=parseFloat(o.dataset.jitter||"1.2"),l=oe(i,t,a,5e3+i*100);o.style.transform=`translate(${l.x}px, ${l.y}px)`})}animateYouLabel(){let e=this.overlay.querySelector(".you-text"),t=this.overlay.querySelector(".you-arrow");if(!e||!t)return;let n=H(),o=oe(700,n,1,7e3);e.style.transform=`translate(${o.x}px, ${o.y}px)`;let i=oe(701,n,1.5,7100);t.style.transform=`translate(${i.x}px, ${i.y+1}px)`}updateModalClipPath(){if(!this.modalEl)return;let e=this.modalEl.getBoundingClientRect(),t=fs(e.width,e.height,{padding:6,jitter:2.5,seedOffset:8e3});this.modalEl.style.clipPath=t}renderHistogram(e,t){if(!e.histogram||e.histogram.length===0)return"";if(e.histogram.length<5)return`
                <div style="margin-bottom: 16px; width: 100%; min-width: 250px;">
                    <div style="font-size: 15px; color: #666; text-transform: uppercase; text-align: center; letter-spacing: 1.5px; margin-bottom: 8px;">Score Distribution</div>
                    <div style="height: 120px; display: flex; align-items: center; justify-content: center; color: #999; font-style: italic;">
                        Not enough data yet
                    </div>
                </div>
            `;let n=ri(e.histogram,100),o=Math.max(...n.map(m=>m.count)),i=n[0].minScore,a=n[n.length-1].maxScore,l=80,r=n.length,h=-1,u=0,d=!1,c=n.map((m,f)=>{let v=f,E=1,x=Math.max(1,m.count/o*l),w=l-x,y=t!==void 0&&t>=m.minScore&&t<=m.maxScore;y&&(h=f,u=w,d=!0);let b=m.minScore===m.maxScore?m.minScore:`${m.minScore}-${m.maxScore}`;return`<rect class="hist-bar" x="${v}" y="${w}" width="${E}" height="${x}" fill="${y?"#3498db":"#ccc"}" data-score="${b}" data-count="${m.count}"/>`}).join(""),p=d?(h+.5)/r*100:0,g=d?u/l*100:0;return`
            <div style="margin: 0 auto 16px; width: 85%; min-width: 200px;">
                <div style="font-size: 15px; color: #666; text-transform: uppercase; text-align: center; letter-spacing: 1.5px; margin-bottom: 32px;">Score Distribution</div>
                <div style="position: relative;">
                    <div id="histTooltipCount" style="position: absolute; font-size: 11px; color: #f1c40f; background: #fff; padding: 1px 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); pointer-events: none; display: none; transform: translateX(-50%);"></div>
                    ${d?`<div id="histYouLabel" style="position: absolute; left: ${p}%; top: ${g}%; transform: translate(-50%, -100%); font-size: 14px; font-weight: bold; color: #3498db; pointer-events: none; padding-bottom: 4px; text-align: center; line-height: 1;"><span class="you-text" style="display: inline-block;">You</span><br><span class="you-arrow" style="display: inline-block; font-size: 12px;">\u25BC</span></div>`:""}
                    <svg id="histSvg" viewBox="0 0 ${r} ${l}" preserveAspectRatio="none" style="width: 100%; height: 120px; display: block;">
                        ${c}
                    </svg>
                </div>
                <div style="position: relative; font-size: 11px; color: #999; margin-top: 2px; height: 14px;">
                    <span id="histTooltipScore" style="position: absolute; top: 0; color: #f1c40f; background: #fff; padding: 0 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); display: none; white-space: nowrap; transform: translateX(-50%);"></span>
                </div>
            </div>
        `}show(e,t,n,o=!1,i,a){if(!this.contentEl)return;this.shareText="",this.shareBtn=null,this.optimalWalls=t.optimalWalls,this.currentLevelId=a||t.levelId;let l=localStorage.getItem(`vote_${this.currentLevelId}`);this.currentVote=l?parseInt(l):null;let r=e?.score??n,h=ke(),u="";if(o&&i!==void 0&&r!==void 0&&t.optimalScore!==null){let d=oi(r,t.optimalScore);this.modalBgColor="#ffffff";let c=t.optimalScore,p=Math.ceil(c*.9),g=Math.ceil(c*.8);u+=`<h2 style="font-size: 24px; margin: 12px 0 20px; text-align: center;">Results - Day ${i}</h2>`,u+=`
                <div id="colorBand" style="background: ${d.bgColor}; padding: 14px 32px 12px; margin: 0 -32px 8px -32px; text-align: center;">
                    <div style="font-size: 15px; color: #666; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px;">Your Score</div>
                    <div style="font-size: 80px; font-weight: bold; color: #000; line-height: 1; margin-bottom: 6px;">${Ht(r)}</div>
                    <div style="font-size: 28px; font-weight: bold; color: #000; letter-spacing: 1px;">${d.emoji} ${d.label} ${d.emoji}</div>
                </div>
            `,u+=`
                <div style="text-align: center; font-size: 14px; color: #888; margin-bottom: 24px;">
                    \u{1F948}${g}+ \xB7 \u{1F947}${p}+ \xB7 \u{1F48E}${c}
                </div>
            `,u+=this.renderHistogram(t,r);let m=Math.floor(r/c*100);this.shareText=`https://enclose.horse Day ${i}
${d.shareLine} ${m}%`,u+=`
                <div id="shareBtnContainer" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 20px;"></div>
            `,this.contentEl.innerHTML=u,requestAnimationFrame(()=>{this.setupCanvas(),this.renderCanvas(),this.updateModalClipPath()}),this.isVisible=!0,this.overlay.classList.add("visible"),this.setupShareHandler(),this.setupHistogramHandlers();return}if(this.modalBgColor="#ffffff",u+=`<h2 style="font-size: 28px; margin-bottom: 16px; text-align: center;">${e?"Results":"Leaderboard"}</h2>`,e?u+=`
                <div style="text-align: center; margin-bottom: 12px;">
                    <div id="dancingScore" style="font-size: 56px; font-weight: bold; color: #000; line-height: 1;">${Ht(e.score)}</div>
                    <div style="font-size: 16px; color: #666; text-transform: uppercase; margin-top: 2px;">Score</div>
                    ${e.isNewPersonalBest?'<div style="color: #27ae60; font-size: 18px; margin-top: 8px;">New Personal Best!</div>':""}
                    <div style="color: #3498db; font-size: 18px; margin-top: 4px;">Rank #${e.rank} (Top ${Math.round(100-e.percentile)}%)</div>
                </div>
            `:n!==void 0&&(u+=`
                <div style="text-align: center; margin-bottom: 12px;">
                    <div id="dancingScore" style="font-size: 56px; font-weight: bold; color: #000; line-height: 1;">${Ht(n)}</div>
                    <div style="font-size: 16px; color: #666; text-transform: uppercase; margin-top: 2px;">Your Score</div>
                    ${t.playerRank!==null?`<div style="color: #3498db; font-size: 18px; margin-top: 4px;">Rank #${t.playerRank} (Top ${Math.round(100-(t.playerPercentile??0))}%)</div>`:""}
                </div>
            `),u+=`
            <div id="playingAsSection" style="text-align: center; margin-bottom: 16px; font-size: 18px;">
                <div style="height: 28px; display: flex; align-items: center; justify-content: center;">
                    <span id="playingAsDisplay" style="cursor: pointer; border-bottom: 1px dashed #999;">
                        <span style="color: #666;">Playing as: </span>
                        <span id="playingAsName">${h?lt(h):"Anonymous"}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="#666" style="margin-left: 6px; vertical-align: middle;"><path d="M180-180h44l472-471-44-44-472 471v44Zm-60 60v-128l575-574q8-8 19-12.5t23-4.5q11 0 22 4.5t20 12.5l44 44q9 9 13 20t4 22q0 11-4.5 22.5T823-694L248-120H120Zm659-617-41-41 41 41Zm-105 64-22-22 44 44-22-22Z"/></svg>
                    </span>
                    <span id="playingAsEdit" style="display: none; white-space: nowrap;">
                        <input type="text" id="nameEditInput" placeholder="Name" value="${lt(h)}"
                            style="padding: 2px 8px; font-size: 18px; font-family: 'Schoolbell', cursive; border: none; background: #e8e8e8; width: 110px; text-align: center; outline: none; vertical-align: middle;"
                            maxlength="20">
                        <button id="btnNameSave" style="margin-left: 4px; padding: 2px 10px; border: none; background: #000; color: #fff; font-size: 16px; font-family: 'Schoolbell', cursive; cursor: pointer; vertical-align: middle;">Save</button>
                        <button id="btnNameCancel" style="margin-left: 2px; padding: 2px 8px; border: 1px solid #ccc; background: #fff; color: #666; font-size: 16px; font-family: 'Schoolbell', cursive; cursor: pointer; vertical-align: middle;">\u2715</button>
                    </span>
                </div>
                <div style="font-size: 12px; color: #999; margin-top: 4px;">Name applies to all levels</div>
            </div>
        `,t.leaderboard.length>0){u+='<table style="width: 100%; border-collapse: collapse; font-size: 16px;">',u+='<tr style="border-bottom: 1px solid #ddd;"><th style="text-align: left; padding: 8px 4px;">#</th><th style="text-align: left; padding: 8px 4px;">Player</th><th style="text-align: right; padding: 8px 4px;">Score</th><th style="text-align: right; padding: 8px 4px; color: #999; font-weight: normal;">When</th><th style="padding: 8px 4px 8px 16px;"></th></tr>';for(let d of t.leaderboard){let c=ai(d.createdAt),p=d.isYou?"border-bottom: 1px solid #eee; background: #fff8dc;":"border-bottom: 1px solid #eee;";u+=`<tr style="${p}" ${d.isYou?'data-is-you="true"':""}>
                    <td style="padding: 8px 4px; color: #666;">${d.rank}</td>
                    <td class="player-name-cell" style="padding: 8px 4px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${lt(d.playerName)}${d.isYou?' <span style="font-size: 12px;">(you)</span>':""}</td>
                    <td style="padding: 8px 4px; text-align: right; font-weight: bold;">${d.score}</td>
                    <td style="padding: 8px 4px; text-align: right; color: #999; font-size: 14px;"><span class="fast-tooltip" data-tooltip="${li(d.createdAt)}">${c}</span></td>
                    <td style="padding: 8px 4px 8px 16px;"><a href="#" class="load-solution-btn" data-submission-id="${d.id}" style="color: #666; font-size: 14px;">View</a></td>
                </tr>`}u+="</table>"}u+=`<div style="text-align: center; color: #888; font-size: 14px; margin-top: 16px;">${t.totalSubmissions} submissions</div>`,u+=`
            <div id="votingSection" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #eee;">
                <div style="text-align: center; margin-bottom: 12px;">
                    <span style="font-size: 14px; color: #666;">Rate this level:</span>
                </div>
                <div id="voteButtonsContainer" style="display: flex; justify-content: center; gap: 16px; align-items: center;"></div>
            </div>
        `,this.contentEl.innerHTML=u,requestAnimationFrame(()=>{this.setupCanvas(),this.renderCanvas()}),this.isVisible=!0,this.overlay.classList.add("visible"),this.setupLoadHandlers(),this.setupNameEditHandlers(),this.setupShareHandler(),this.setupHistogramHandlers(),this.setupVotingHandlers()}setupLoadHandlers(){this.contentEl?.querySelectorAll(".load-solution-btn")?.forEach(t=>{t.addEventListener("click",async n=>{n.preventDefault();let o=parseInt(n.target.dataset.submissionId||"0");if(o)try{n.target.textContent="...";let i=await gs(o),a=this.options.getGridSize(),l=Yt(i.wallData,a),r=[];for(let h=0;h<l.length;h++)l[h]&&r.push(h);this.options.onLoadSolution(r),this.hide()}catch(i){console.error("Failed to load solution:",i),n.target.textContent="error"}})})}setupNameEditHandlers(){let e=this.contentEl?.querySelector("#playingAsDisplay"),t=this.contentEl?.querySelector("#playingAsEdit"),n=this.contentEl?.querySelector("#playingAsName"),o=this.contentEl?.querySelector("#nameEditInput"),i=this.contentEl?.querySelector("#btnNameSave"),a=this.contentEl?.querySelector("#btnNameCancel");if(!e||!t||!o||!i||!a||!n)return;e.addEventListener("click",()=>{e.style.display="none",t.style.display="block",o.focus(),o.select()}),a.addEventListener("click",()=>{t.style.display="none",e.style.display="inline",o.value=ke()});let l=async()=>{let r=o.value.trim();if(!r){o.focus();return}if(!/^[a-zA-Z0-9_]{1,20}$/.test(r)){alert("Name must be 1-20 characters: letters, numbers, or underscores only");return}i.textContent="Saving...",i.disabled=!0;try{await tt(r),st(r),n.textContent=r,t.style.display="none",e.style.display="inline",this.updateLeaderboardHighlight(r)}catch{alert("Failed to save name. Please try again.")}finally{i.textContent="Save",i.disabled=!1}};i.addEventListener("click",l),o.addEventListener("keydown",r=>{r.key==="Enter"&&l(),r.key==="Escape"&&a.click()})}setupShareHandler(){let e=this.contentEl?.querySelector("#shareBtnContainer");!e||!this.shareText||(e.innerHTML="",this.shareBtn=new _(e,{text:"Share",onClick:()=>{navigator.clipboard.writeText(this.shareText),this.shareBtn?.setText("Copied!"),setTimeout(()=>{this.shareBtn?.setText("Share")},1500)},width:100,height:44,inverted:!0}),this.optimalWalls&&new _(e,{text:"View Optimal",onClick:()=>{this.optimalWalls&&(this.options.onLoadSolution(this.optimalWalls),this.hide())},width:130,height:44,inverted:!0}))}setupHistogramHandlers(){let e=this.contentEl?.querySelector("#histSvg"),t=this.contentEl?.querySelector("#histTooltipCount"),n=this.contentEl?.querySelector("#histTooltipScore"),o=this.contentEl?.querySelector("#histYouLabel");if(!e||!t||!n)return;let i=Array.from(e.querySelectorAll(".hist-bar")),a=i.length;if(a===0)return;let l=null,r=()=>{l&&(l.style.fill=""),l=null,t.style.display="none",n.style.display="none",o&&(o.style.opacity="1")};e.addEventListener("mousemove",h=>{let u=e.getBoundingClientRect(),d=h.clientX-u.left,c=a,p=d/u.width*c,g=Math.floor(p);if(g<0||g>=a){r();return}let m=i[g];if(m===l)return;r(),l=m,m.style.fill="#f1c40f";let f=m.getAttribute("fill")==="#3498db";o&&f&&(o.style.opacity="0");let v=m.dataset.score,E=m.dataset.count,x=parseFloat(m.getAttribute("x")||"0"),w=(x+.5)/c*u.width,A=parseFloat(m.getAttribute("y")||"0")/80*120;t.textContent=String(E),t.style.left=`${w}px`,t.style.top=`${A-24}px`,t.style.display="block",n.textContent=String(v);let C=(x+.5)/c*100;n.style.left=`${C}%`,n.style.display="block"}),e.addEventListener("mouseleave",r)}setupVotingHandlers(){let e=this.contentEl?.querySelector("#voteButtonsContainer");if(!e)return;this.upvoteBtn?.destroy(),this.downvoteBtn?.destroy(),this.upvoteBtn=null,this.downvoteBtn=null,e.innerHTML="";let t=async m=>{if(!this.currentLevelId)return;let f=this.currentVote===m?0:m,v=this.currentVote;this.currentVote=f===0?null:f,this.setupVotingHandlers();try{let E=await vs(this.currentLevelId,f);this.currentVote=E.yourVote,this.currentVote?localStorage.setItem(`vote_${this.currentLevelId}`,String(this.currentVote)):localStorage.removeItem(`vote_${this.currentLevelId}`)}catch(E){console.error("Failed to vote:",E),this.currentVote=v,this.setupVotingHandlers()}},n=document.createElement("div");n.style.cssText="display: flex; flex-direction: column; align-items: center; position: relative;",e.appendChild(n),this.upvoteBtn=new _(n,{text:"",onClick:()=>t(1),width:48,height:44,fillColor:this.currentVote===1?"#27ae60":"#888888",hoverFillColor:"#27ae60",seedOffset:9100,shape:"triangle-up",disablePressEffect:!0,drawContent:(m,f,v,E,x,w,y,b)=>{_s(m,"happy",f/2+w+b,v/2+4*E+y+b,28*E,x)}});let o=document.createElement("div");o.style.cssText="position: absolute; top: 10px; left: 0; width: 48px; height: 36px; z-index: -1;";let i=`<svg width="48" height="36" viewBox="0 0 48 36">
            <path d="M20 14 Q10 18 2 24" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round"/>
            <path d="M28 14 Q38 18 46 24" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>`,a=`<svg width="48" height="36" viewBox="0 0 48 36" style="transform: translateY(-4px);">
            <path d="M20 18 Q10 12 2 6" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round"/>
            <path d="M28 18 Q38 12 46 6" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>`,l=this.currentVote===1;o.innerHTML=l?a:i,n.appendChild(o);let r=document.createElement("div");r.style.cssText="margin-top: -16px; z-index: -1; position: relative;",r.innerHTML=`<svg width="24" height="22" viewBox="0 0 24 22">
            <path d="M8 0 Q6 11 8 22" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round"/>
            <path d="M16 0 Q18 11 16 22" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>`,n.appendChild(r);let h=document.createElement("div");h.style.cssText="display: flex; flex-direction: column; align-items: center; position: relative;",e.appendChild(h),this.downvoteBtn=new _(h,{text:"",onClick:()=>t(-1),width:48,height:44,fillColor:this.currentVote===-1?"#e74c3c":"#888888",hoverFillColor:"#e74c3c",seedOffset:9200,shape:"triangle-down",disablePressEffect:!0,drawContent:(m,f,v,E,x,w,y,b)=>{_s(m,"sad",f/2+w+b,v/2-4*E+y+b,28*E,x)}});let u=document.createElement("div");u.style.cssText="position: absolute; top: 18px; left: 0; width: 48px; height: 36px; z-index: -1;";let d=`<svg width="48" height="36" viewBox="0 0 48 36">
            <path d="M17 8 Q13 14 11 22" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round"/>
            <path d="M31 8 Q35 14 37 22" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>`,c=`<svg width="48" height="36" viewBox="0 0 48 36" style="transform: translateY(-4px);">
            <path d="M17 10 L9 14 L5 6" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M31 10 L39 14 L43 6" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`,p=this.currentVote===-1;u.innerHTML=p?c:d,h.appendChild(u);let g=document.createElement("div");g.style.cssText="margin-top: -16px; z-index: -1; position: relative;",g.innerHTML=`<svg width="24" height="22" viewBox="0 0 24 22">
            <path d="M8 0 Q6 11 8 22" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round"/>
            <path d="M16 0 Q18 11 16 22" stroke="#888" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>`,h.appendChild(g)}updateLeaderboardHighlight(e){let t=this.contentEl?.querySelector('tr[data-is-you="true"]');if(!t)return;let n=t.querySelector(".player-name-cell");if(n){let o=e||"Anonymous";n.innerHTML=`${lt(o)} <span style="font-size: 12px;">(you)</span>`}}showLoading(){this.contentEl&&(this.contentEl.innerHTML=`
            <h2 style="font-size: 28px; margin-bottom: 16px; text-align: center;">Results</h2>
            <div style="text-align: center; padding: 40px 0; color: #666; font-size: 18px;">Loading...</div>
        `,requestAnimationFrame(()=>{this.setupCanvas(),this.renderCanvas()}),this.isVisible=!0,this.overlay.classList.add("visible"))}hide(){this.isVisible=!1,this.overlay.classList.remove("visible")}};function hi(){let s=new Date,e=s.getFullYear(),t=String(s.getMonth()+1).padStart(2,"0"),n=String(s.getDate()).padStart(2,"0");return`${e}-${t}-${n}`}function ci(){try{let s=localStorage.getItem("enclose_submissions");return s?JSON.parse(s):{}}catch{return{}}}function di(s,e){if(e===null)return"";let t=s/e*100;return t>=100?"\u{1F48E}":t>=90?"\u{1F947}":t>=80?"\u{1F948}":"\u{1F949}"}var Ne=class{overlay;canvas=null;ctx=null;closeCanvas=null;closeCtx=null;contentEl=null;unregisterAnim=null;isVisible=!1;options;resizeObserver=null;constructor(e,t={}){this.options=t,this.overlay=document.createElement("div"),this.overlay.className="modal-overlay",this.overlay.id="pastPuzzlesOverlay",e.appendChild(this.overlay),this.render(),this.setupEvents(),this.startAnimation()}render(){this.overlay.innerHTML=`
            <style>
                .past-puzzle-row:hover {
                    background: #f1c40f !important;
                    color: #000 !important;
                }
                .past-puzzle-row:hover .optimal-score {
                    color: #000 !important;
                }
            </style>
            <div style="display: flex; flex-direction: column; align-items: center;">
                <canvas id="pastPuzzlesClose" style="align-self: flex-end; cursor: pointer; margin-bottom: -6px;" width="40" height="40"></canvas>
                <div class="wiggly-modal" style="position: relative; width: 340px; max-width: calc(100vw - 40px); max-height: calc(100dvh - 100px); display: flex; flex-direction: column;">
                    <canvas class="wiggly-modal-bg" style="display: block; position: absolute; top: 0; left: 0; z-index: 0;"></canvas>
                    <div class="wiggly-modal-scroll" style="overflow-y: auto; margin: 12px; margin-right: 14px; flex: 1; min-height: 0; position: relative; z-index: 2;">
                        <div class="wiggly-modal-content" id="pastPuzzlesContent" style="position: relative; z-index: 1; padding: 20px; color: #000; font-family: 'Schoolbell', cursive;">
                            <h2 style="font-size: 24px; margin-bottom: 16px;">Past Puzzles</h2>
                            <div id="pastPuzzlesList" style="font-size: 16px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        `,this.canvas=this.overlay.querySelector(".wiggly-modal-bg"),this.ctx=this.canvas?.getContext("2d")||null,this.closeCanvas=this.overlay.querySelector("#pastPuzzlesClose"),this.closeCtx=this.closeCanvas?.getContext("2d")||null,this.contentEl=this.overlay.querySelector("#pastPuzzlesList");let e=this.overlay.querySelector(".wiggly-modal");e&&(this.resizeObserver=new ResizeObserver(()=>{this.isVisible&&(this.setupCanvas(),this.renderCanvas())}),this.resizeObserver.observe(e))}setupEvents(){this.closeCanvas?.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",e=>{e.target===this.overlay&&this.hide()})}setupCanvas(){if(!this.canvas||!this.ctx)return;let e=this.overlay.querySelector(".wiggly-modal");if(!e)return;let t=window.devicePixelRatio||1,n=e.offsetWidth,o=e.offsetHeight;this.canvas.width=n*t,this.canvas.height=o*t,this.canvas.style.width=`${n}px`,this.canvas.style.height=`${o}px`}renderCanvas(){if(!this.ctx||!this.canvas)return;let e=this.canvas.width,t=this.canvas.height,n=window.devicePixelRatio||1;this.ctx.clearRect(0,0,e,t),Q(this.ctx,e,t,{fillColor:"#ffffff",padding:6,jitter:2.5,seedOffset:11e3,dpr:n}),this.renderCloseButton()}renderCloseButton(){if(!this.closeCtx||!this.closeCanvas)return;let e=window.devicePixelRatio||1,t=40;this.closeCanvas.width=t*e,this.closeCanvas.height=t*e,this.closeCanvas.style.width=`${t}px`,this.closeCanvas.style.height=`${t}px`;let n=this.closeCtx;n.clearRect(0,0,this.closeCanvas.width,this.closeCanvas.height);let o=H(),i=oe(42,o,.8,11500);n.font=`${36*e}px Schoolbell, cursive`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#ffffff",n.fillText("\xD7",t*e/2+i.x*e,t*e/2+i.y*e)}startAnimation(){this.unregisterAnim||(this.unregisterAnim=he.register(()=>{this.isVisible&&this.renderCanvas()}))}show(){this.isVisible=!0,this.overlay.classList.add("visible"),this.options.onShow?.();let e=window.__DAILY_LEVELS__||[];this.renderLevels(e),requestAnimationFrame(()=>{this.setupCanvas(),this.renderCanvas()})}renderLevels(e){if(!this.contentEl)return;let t=hi(),n=e.filter(a=>a.date<=t);if(n.length===0){this.contentEl.innerHTML='<p style="color: #666;">No past puzzles yet.</p>';return}let o=ci(),i='<div style="display: flex; flex-direction: column; gap: 8px;">';for(let a of n){let l=o[a.id],r=!!l,h=l?.score,u=r&&h!==void 0?di(h,a.optimalScore):"",d=u==="\u{1F48E}",c=a.date===t?"/":`/play/${a.date}`;i+=`
                <a href="${c}" class="past-puzzle-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #000; text-decoration: none; color: #fff;">
                    <span style="font-weight: bold;">Day ${a.dayNumber}</span>
                    <span style="font-size: 14px;">${a.date}</span>
                    <span class="${d?"optimal-score":""}" style="min-width: 60px; text-align: right;${d?" color: #f1c40f; font-weight: bold;":""}">
                        ${r?`${h} ${u}`:'<span style="opacity: 0.5;">\u2014</span>'}
                    </span>
                </a>
            `}i+="</div>",this.contentEl.innerHTML=i}hide(){this.isVisible=!1,this.overlay.classList.remove("visible"),this.options.onHide?.()}};var Hs="unusedWallsTipDismissed",ct=class{overlay;canvas=null;ctx=null;modalEl=null;unregisterAnim=null;isVisible=!1;resizeObserver=null;checkbox=null;messageEl=null;resolvePromise=null;constructor(e){this.overlay=document.createElement("div"),this.overlay.className="modal-overlay",this.overlay.id="unusedWallsTipOverlay",e.appendChild(this.overlay),this.render(),this.setupEvents(),this.overlay.style.opacity="0",this.overlay.style.pointerEvents="none",this.overlay.classList.add("visible"),requestAnimationFrame(()=>{this.setupCanvas(),this.renderCanvas(),this.overlay.classList.remove("visible"),this.overlay.style.opacity="",this.overlay.style.pointerEvents="",this.startAnimation()})}render(){this.overlay.innerHTML=`
            <div style="position: relative;">
                <div class="wiggly-modal" id="unusedWallsTipModal" style="position: relative; width: 380px; max-width: calc(100vw - 32px); max-height: calc(100vh - 100px); display: flex; flex-direction: column;">
                    <canvas class="wiggly-modal-bg" style="display: block; position: absolute; top: 0; left: 0; z-index: 0; pointer-events: none;"></canvas>
                    <div class="wiggly-modal-scroll" style="overflow-y: auto; flex: 1; min-height: 0; position: relative; z-index: 2;">
                        <div class="wiggly-modal-content" style="position: relative; z-index: 1; padding: 20px 32px; color: #000; font-family: 'Schoolbell', cursive;">

                            <h2 style="font-size: 26px; margin: 0 0 16px 0; text-align: center;">Horse Tip!</h2>

                            <p id="unusedWallsMessage" style="color: #333; line-height: 1.7; margin-bottom: 20px; font-size: 17px; text-align: center;">
                                You have unused walls remaining.
                            </p>

                            <p style="color: #333; line-height: 1.7; margin-bottom: 20px; font-size: 17px; text-align: center;">
                                Are you sure you want to submit?
                            </p>

                            <label style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 24px; cursor: pointer; font-size: 15px; color: #555;">
                                <input type="checkbox" id="neverShowUnusedTip" style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Never show me this horse tip again</span>
                            </label>

                            <div style="display: flex; justify-content: center; gap: 12px;">
                                <div id="cancelBtnContainer"></div>
                                <div id="submitBtnContainer"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,this.canvas=this.overlay.querySelector(".wiggly-modal-bg"),this.ctx=this.canvas?.getContext("2d")||null,this.modalEl=this.overlay.querySelector("#unusedWallsTipModal"),this.modalEl&&(this.resizeObserver=new ResizeObserver(()=>{this.isVisible&&(this.setupCanvas(),this.renderCanvas())}),this.resizeObserver.observe(this.modalEl)),this.checkbox=this.overlay.querySelector("#neverShowUnusedTip"),this.messageEl=this.overlay.querySelector("#unusedWallsMessage");let e=this.overlay.querySelector("#cancelBtnContainer");new _(e,{text:"Go back",onClick:()=>this.handleCancel(),width:120,height:48,seedOffset:9e3});let t=this.overlay.querySelector("#submitBtnContainer");new _(t,{text:"Submit",onClick:()=>this.handleProceed(),width:120,height:48,inverted:!0,seedOffset:9100})}setupEvents(){this.overlay.querySelector("div")?.addEventListener("click",t=>t.stopPropagation()),this.overlay.addEventListener("click",()=>this.handleCancel())}setupCanvas(){if(!this.canvas||!this.ctx||!this.modalEl)return;let e=window.devicePixelRatio||1,t=this.modalEl.offsetWidth,n=this.modalEl.offsetHeight;this.canvas.width=t*e,this.canvas.height=n*e,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${n}px`}renderCanvas(){if(!this.ctx||!this.canvas)return;let e=this.canvas.width,t=this.canvas.height,n=window.devicePixelRatio||1;this.ctx.clearRect(0,0,e,t),Q(this.ctx,e,t,{fillColor:"#ffffff",padding:6,jitter:2.5,seedOffset:9500,dpr:n})}startAnimation(){this.unregisterAnim||(this.unregisterAnim=he.register(()=>{this.isVisible&&(this.setupCanvas(),this.renderCanvas())}))}handleProceed(){this.checkbox?.checked&&localStorage.setItem(Hs,"true"),this.hide(),this.resolvePromise?.(!0),this.resolvePromise=null}handleCancel(){this.hide(),this.resolvePromise?.(!1),this.resolvePromise=null}async showIfNeeded(e){return e<=0||localStorage.getItem(Hs)==="true"?!0:new Promise(t=>{this.resolvePromise=t,this.show(e)})}show(e){if(this.checkbox&&(this.checkbox.checked=!1),this.messageEl){let t=e===1?"wall":"walls";this.messageEl.textContent=`You have ${e} unused ${t} remaining.`}this.isVisible=!0,this.overlay.classList.add("visible")}hide(){this.isVisible=!1,this.overlay.classList.remove("visible")}};(async function(){try{let e=localStorage.getItem("enclose_submissions");if(!e)return;let t=JSON.parse(e),n=Object.keys(t);if(n.length===0)return;let o=n.map(l=>({levelId:l,walls:t[l].walls})),i=localStorage.getItem("enclose_name")||void 0,a=await ws(o,i);a.recovered.length>0&&console.log("[Recovery] Recovered submissions for:",a.recovered)}catch{}})();function Wt(s,e){let t=window.__DAILY_LEVELS__;document.body.innerHTML=`
        <canvas id="grassBg"></canvas>
        <div id="navbarContainer"></div>
        <div id="errorContent" style="
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 5;
            padding: 20px;
            text-align: center;
        ">
            <div id="sadFace" style="font-size: 72px; margin-bottom: 16px; font-family: 'Schoolbell', cursive;">
                <span style="display: inline-block;">:</span><span style="display: inline-block; margin-left: 8px;">(</span>
            </div>
            <h1 id="errorTitle" style="font-size: 32px; margin: 0 0 12px; font-family: 'Schoolbell', cursive; color: #f1c40f; display: flex; gap: 2px;"></h1>
            <p style="font-size: 20px; margin: 0 0 32px; opacity: 0.9; font-family: 'Schoolbell', cursive;">${e}</p>
            <div id="homeBtn"></div>
        </div>
        <div id="modalsContainer"></div>
        <div class="modal-overlay" id="helpModal">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <canvas id="helpCloseBtn" style="align-self: flex-end; cursor: pointer; margin-bottom: -6px;" width="40" height="40"></canvas>
                <div class="wiggly-modal" id="helpModalBox" style="position: relative; width: 280px;">
                    <canvas id="helpModalBg" style="display: block; position: absolute; top: 0; left: 0; z-index: 0;"></canvas>
                    <div style="position: relative; z-index: 1; padding: 24px 28px; text-align: center;">
                        <p style="margin: 0; font-size: 18px; color: #000; font-family: 'Schoolbell', cursive;">What, there's nothing here either!</p>
                    </div>
                </div>
            </div>
        </div>
    `,window.__DAILY_LEVELS__=t;let n=document.getElementById("errorTitle");s.split("").forEach(L=>{let k=document.createElement("span");k.style.display="inline-block",k.textContent=L===" "?"\xA0":L,n.appendChild(k)});let o=document.getElementById("navbarContainer");o.innerHTML=`
        <nav class="navbar">
            <div class="navbar-row">
                <div style="display: flex; gap: 4px; min-width: 76px;">
                    <button class="navbar-btn" id="btnHelp">?</button>
                </div>
                <a href="/" class="navbar-title" id="siteTitle"><span>e</span><span>n</span><span>c</span><span>l</span><span>o</span><span>s</span><span>e</span><span>.</span><span>h</span><span>o</span><span>r</span><span>s</span><span>e</span></a>
                <div style="display: flex; gap: 4px; min-width: 76px; justify-content: flex-end;">
                    <button class="navbar-btn hamburger" id="btnMenu"><span>--</span><span>--</span><span>--</span></button>
                </div>
            </div>
        </nav>
    `;let i=document.getElementById("homeBtn");new _(i,{text:"Go Home",onClick:()=>{window.location.href="/"},width:140,height:48,seedOffset:999});let a=document.getElementById("btnHelp"),l=document.getElementById("btnMenu"),r=document.getElementById("modalsContainer"),h=new Ne(r),u=new Ge(r,{onMenuShow:()=>l.classList.add("active"),onMenuHide:()=>l.classList.remove("active"),onShowPastPuzzles:()=>h.show()}),d=document.getElementById("helpModal"),c=document.getElementById("helpModalBox"),p=document.getElementById("helpModalBg"),g=document.getElementById("helpCloseBtn"),m=p.getContext("2d"),f=g.getContext("2d"),v=!1;function E(){if(!v)return;let L=window.devicePixelRatio||1,k=c.offsetWidth,M=c.offsetHeight;p.width=k*L,p.height=M*L,p.style.width=`${k}px`,p.style.height=`${M}px`,Q(m,p.width,p.height,{fillColor:"#ffffff",padding:6,jitter:2.5,seedOffset:7e3,dpr:L});let I=40;g.width=I*L,g.height=I*L,g.style.width=`${I}px`,g.style.height=`${I}px`,f.clearRect(0,0,g.width,g.height);let P=H(),O=oe(42,P,.8,8e3);f.font=`${36*L}px Schoolbell, cursive`,f.textAlign="center",f.textBaseline="middle",f.fillStyle="#ffffff",f.fillText("\xD7",I*L/2+O.x*L,I*L/2+O.y*L)}he.register(E),a.addEventListener("click",()=>{v=!0,d.classList.add("visible"),E()}),d.addEventListener("click",L=>{L.target===d&&(v=!1,d.classList.remove("visible"))}),g.addEventListener("click",()=>{v=!1,d.classList.remove("visible")}),l.addEventListener("click",()=>{u.showMenu()});let x=document.getElementById("grassBg"),w=x.getContext("2d"),y=32;function b(){let L=window.devicePixelRatio||1;x.width=window.innerWidth*L,x.height=window.innerHeight*L;let k=Math.min(window.innerWidth,window.innerHeight);y=Math.max(24,Math.floor(k/15))*L}function T(){let L=Oe();if(!L?.loaded)return;w.imageSmoothingEnabled=!1;let k=y,M=Math.floor(H()/2)%2,I=Math.ceil(x.width/k)+1,P=Math.ceil(x.height/k)+1;for(let O=0;O<P;O++)for(let D=0;D<I;D++){let S=D*k,$=O*k,ee=D*7919+O*6971,G=Math.abs(ee)%100<11,ne=ee%2===0?M:1-M;G?se(w,L.sheet,B.GRASS_ANIM,ne,S,$,k+.5,k+.5):se(w,L.sheet,B.GRASS_BLANK,ne,S,$,k+.5,k+.5)}}function A(){let L=document.getElementById("siteTitle");L&&L.querySelectorAll("span").forEach((D,S)=>{let $=W(S*3)*1.5,ee=W(S*3+1)*1.5,G=W(S*3+2)*3;D.style.transform=`translate(${$}px, ${ee}px) rotate(${G}deg)`});let k=document.getElementById("sadFace");k&&k.querySelectorAll("span").forEach((D,S)=>{let $=W(200+S*3)*2,ee=W(201+S*3)*2,G=W(202+S*3)*4;D.style.transform=`translate(${$}px, ${ee}px) rotate(${G}deg)`}),n.querySelectorAll("span").forEach((O,D)=>{let S=W(300+D*3)*1.5,$=W(301+D*3)*1.5,ee=W(302+D*3)*3;O.style.transform=`translate(${S}px, ${$}px) rotate(${ee}deg)`});let I=document.getElementById("btnHelp");if(I){let O=W(100)*2,D=W(101)*2,S=W(102)*4;I.style.transform=`translate(${O}px, ${D}px) rotate(${S}deg)`}let P=document.getElementById("btnMenu");P&&P.querySelectorAll("span").forEach((D,S)=>{let $=W(400+S*3)*1.5,ee=W(401+S*3)*1,G=W(402+S*3)*3;D.style.transform=`translate(${$}px, ${ee}px) rotate(${G}deg)`})}let C=-1;function R(){let L=H();L!==C&&(C=L,T(),A()),requestAnimationFrame(R)}throw We().then(()=>{b(),R()}),window.addEventListener("resize",b),new Error(s)}function dt(){let s=new Date,e=s.getFullYear(),t=String(s.getMonth()+1).padStart(2,"0"),n=String(s.getDate()).padStart(2,"0");return`${e}-${t}-${n}`}async function ui(s){let e=await fetch(`/api/daily/${s}`);if(!e.ok){let t=await e.json();throw new Error(t.error||"Failed to load daily puzzle")}return e.json()}var U;if(window.__DAILY_MODE__){let s=dt();try{U=await ui(s),window.__LEVEL__=U}catch(e){throw alert(e.message||"No puzzle available for today"),e}}else if(window.__DAILY_DETECT__){let s=dt();throw window.location.replace(`${window.location.pathname}?date=${s}`),new Error("Redirecting to daily level")}else window.__DAILY_ERROR__?Wt("Oops!",window.__DAILY_ERROR__):window.__LEVEL__?U=window.__LEVEL__:Wt("Level Not Found","This level doesn't exist or may have been deleted.");if(U.dailyDate){let s=dt();U.dailyDate>s&&Wt("Not Yet!","This puzzle isn't available yet. Check back later!")}var ge=U.id;function Gt(){try{let s=localStorage.getItem("enclose_submissions");return s?JSON.parse(s):{}}catch{return{}}}function pi(s,e,t){let n=Gt();n[s]={walls:e,score:t},localStorage.setItem("enclose_submissions",JSON.stringify(n))}function js(s){return Gt()[s]||null}function fi(s){let e=Gt();delete e[s],localStorage.setItem("enclose_submissions",JSON.stringify(e))}var ue=js(ge);if(ue){let s=U.map.replace(/\n/g,"");ue.walls.some(t=>s[t]==="C")&&(fi(ge),ue=null)}var Pe=null;xs(()=>{Pe=null});ue&&Mt(ge).then(s=>{Pe=s,U.isDaily&&s.optimalWalls&&(pe=s.optimalWalls,typeof _e=="function"&&_e())}).catch(()=>{});var zt=null;bs(ge).then(s=>{zt=s.yourReport}).catch(()=>{});var z=new it("game","viewport");z.setMode("PLAYER");z.loadFromMap(U.map,U.budget);ue&&z.setWallIndices(ue.walls);var Re=document.getElementById("grassBg"),Ds=Re?.getContext("2d"),Ws=-1;function Us(){if(!Re)return;let s=window.devicePixelRatio||1;Re.width=window.innerWidth*s,Re.height=window.innerHeight*s,pt()}function pt(){if(!Re||!Ds)return;let s=Oe();if(!s?.loaded)return;let e=Ds;e.imageSmoothingEnabled=!1;let t=z.getTileSize(),n=z.getGridOffset(),o=Math.floor(H()/2)%2,i=n.x%t,a=n.y%t,l=-Math.floor(n.x/t),r=-Math.floor(n.y/t),h=Math.ceil((Re.width-i)/t)+1,u=Math.ceil((Re.height-a)/t)+1;for(let d=0;d<u;d++)for(let c=0;c<h;c++){let p=i+(c-1)*t,g=a+(d-1)*t,m=l+c-1,f=r+d-1,v=m*7919+f*6971,E=Math.abs(v)%100<11,x=v%2===0?o:1-o;E?se(e,s.sheet,B.GRASS_ANIM,x,p,g,t+.5,t+.5):se(e,s.sheet,B.GRASS_BLANK,x,p,g,t+.5,t+.5)}}function Xs(){let s=H();s!==Ws&&(Ws=s,pt()),requestAnimationFrame(Xs)}We().then(()=>{Us(),Xs()});et(()=>{pt()});var Dt=null;function mi(){Dt||(Dt=window.setTimeout(()=>{Dt=null,Us()},16))}window.addEventListener("resize",mi);z.onResize=()=>{pt(),Qs()};var gi=document.getElementById("navbarContainer"),Xe=document.getElementById("modalsContainer"),Vs="enclose_seen_help",Js=!localStorage.getItem(Vs);Js&&localStorage.setItem(Vs,"1");var vi=new at(Xe,{tabs:["howToPlay","levelInfo"],getLevelInfo:()=>({id:U.id,name:U.name,creatorName:U.creatorName,cols:z.state.cols,rows:z.state.rows,budget:U.budget,playCount:U.playCount}),hasCherries:()=>z.state.cherries.some(s=>s),hasPortals:()=>z.state.portals.some(s=>s!==null),onReport:async s=>{await ys(U.id,s),zt=s},getReportStatus:()=>zt,onShow:()=>ut.setHelpActive(!0),onHide:()=>ut.setHelpActive(!1),showImmediately:Js}),bi=new Ne(Xe),yi=new Ge(Xe,{onMenuShow:()=>ut.setMenuActive(!0),onMenuHide:()=>ut.setMenuActive(!1),onShowPastPuzzles:()=>bi.show()}),qe=new ht(Xe,{onLoadSolution:s=>{z.setWallIndices(s,!0)},getGridSize:()=>z.state.cols*z.state.rows}),wi=new ct(Xe),ut=new ot(gi,{onHelpClick:()=>vi.show(),onMenuClick:()=>yi.showMenu(),dayNumber:U.dayNumber,showCountdown:U.dailyDate===dt()}),xi=document.getElementById("wallsUsed"),Ei=document.getElementById("wallsBudget"),$t=document.getElementById("wallsStat"),zs=document.getElementById("areaStatPlay"),$s=document.getElementById("areaValuePlay"),re=document.getElementById("bestArea"),No=document.getElementById("bestAreaValue"),Ks=document.getElementById("playButtons"),Fs=document.getElementById("gridStats"),we=document.getElementById("gridStatsBest"),Gs=document.getElementById("game"),je=0,Ft=[],Le=null,pe=null,Ue=!1;Ps(s=>{!s&&Ue&&(Ue=!1,z.setOptimalOverlay(null)),_e()});function Zs(s,e){if(s.length!==e.length)return!1;let t=[...s].sort((o,i)=>o-i),n=[...e].sort((o,i)=>o-i);return t.every((o,i)=>o===n[i])}function Ns(){return Le?Zs(z.getWallIndices(),Le):!1}function Ci(){return pe?Zs(z.getWallIndices(),pe):!1}ue&&(Le=ue.walls);re?.addEventListener("click",s=>{re.dataset.mode!=="toggle"&&Ft.length>0&&z.setWallIndices(Ft,!0)});var Ye='<svg class="restore-icon" xmlns="http://www.w3.org/2000/svg" height="14" viewBox="0 -960 960 960" width="14" fill="currentColor"><path d="M360-240 120-480l240-240 56 56-144 144h488v-160h80v240H272l144 144-56 56Z"/></svg>';function qs(s){if(Ue=s,s&&pe){let e=z.getSolveResultForWalls(pe);z.setOptimalOverlay({walls:pe,visited:e.visited})}else z.setOptimalOverlay(null);_e()}function _e(){if(!we||!re)return;let s=z.getSolveResult(),t=!s.escaped?s.totalScore:0,n=ft&&U.isDaily&&pe&&Le,o=_t();if(n)if(re.dataset.mode="toggle",re.classList.add("toggle-mode"),o)Ns()?Ue?re.innerHTML=`<span class="toggle-link" data-action="hide-overlay">${Ye}Hide Optimal</span>`:re.innerHTML=`<span class="toggle-link" data-action="show-overlay">${Ye}Show Optimal</span>`:Ue?re.innerHTML='<span class="toggle-link" data-action="submitted">Your Solution</span><span class="toggle-separator"> \xB7 </span><span class="toggle-link" data-action="hide-overlay">Hide Optimal</span>':re.innerHTML='<span class="toggle-link" data-action="submitted">Your Solution</span><span class="toggle-separator"> \xB7 </span><span class="toggle-link" data-action="show-overlay">Show Optimal</span>',we.classList.add("visible");else{let i=Ns(),a=Ci();i?(re.innerHTML=`<span class="toggle-link" data-action="optimal">${Ye}See Optimal</span>`,we.classList.add("visible")):a?(re.innerHTML=`<span class="toggle-link" data-action="submitted">${Ye}Your Solution</span>`,we.classList.add("visible")):(re.innerHTML='<span class="toggle-link" data-action="submitted">Your Solution</span><span class="toggle-separator"> \xB7 </span><span class="toggle-link" data-action="optimal">See Optimal</span>',we.classList.add("visible"))}else{re.dataset.mode="best",re.classList.remove("toggle-mode"),re.innerHTML=`${Ye}<span>Best: </span><span id="bestAreaValue">${je}</span>`;let i=je>0&&t<je;we.classList.toggle("visible",i)}}re?.addEventListener("click",s=>{let t=s.target.closest(".toggle-link");if(!t)return;let n=t.dataset.action;n==="show-overlay"?qs(!0):n==="hide-overlay"?qs(!1):n==="optimal"&&pe?z.setWallIndices(pe,!0):n==="submitted"&&Le&&z.setWallIndices(Le,!0)});function Qs(){if(Gs&&Fs){let s=Gs.offsetWidth;s>0&&(Fs.style.width=`${s}px`,we&&(we.style.width=`${s}px`))}}function Ti(s){s.style.transition="none",s.style.textShadow="0 0 20px #fff, 0 0 40px #fff",s.offsetWidth,s.style.transition="text-shadow 1s ease-out",s.style.textShadow="none"}new _(Ks,{text:"Reset",onClick:()=>z.clearWalls(),width:120,height:44});var xe=new _(Ks,{text:ue?"Results":"Submit",onClick:async()=>{if(!ge)return;let s=js(ge);if(s){let o=U.isDaily===!0;if(Pe)qe.show(null,Pe,s.score,o,U.dayNumber);else{qe.showLoading();try{let i=await Mt(ge);Pe=i,qe.show(null,i,s.score,o,U.dayNumber)}catch(i){qe.hide(),alert("Error loading results: "+i.message)}}return}let e=z.getWallIndices().length,t=U.budget-e;if(await wi.showIfNeeded(t))try{xe.setDisabled(!0),xe.setText("Submitting...");let o=z.getWallIndices(),i=localStorage.getItem("enclose_name")||void 0,a=await ms(ge,o,i);pi(ge,o,a.score),Le=o,U.isDaily&&a.stats.optimalWalls&&(pe=a.stats.optimalWalls),ft=!0,xe.setText("Results"),xe.setDisabled(!1),_e(),Pe=a.stats,qe.show(a,a.stats,void 0,U.isDaily===!0,U.dayNumber)}catch(o){alert("Error: "+o.message),xe.setDisabled(!1),xe.setText("Submit")}},width:120,height:44}),ft=!!ue;xe.setDisabled(!ft);z.onStateChange=()=>{let s=z.getSolveResult(),e=s.wallCount,t=!s.escaped,n=z.state.budget-e;xi.textContent=String(n),Ei.textContent=String(z.state.budget),$s.textContent=t?String(s.totalScore):"N/A",$s.classList.toggle("escaped",!t),t&&s.totalScore>je&&(je=s.totalScore,Ft=z.getWallIndices()),_e(),ft||xe.setDisabled(!t)};z.onBudgetExceeded=()=>{Ti($t)};window.addEventListener("keydown",s=>{if(s.target.tagName==="INPUT")return;let e=s.key.toUpperCase();if(e==="Z"&&(s.ctrlKey||s.metaKey)){s.preventDefault(),s.shiftKey?z.redo():z.undo();return}if(e==="Y"&&s.ctrlKey){s.preventDefault(),z.redo();return}e==="C"&&z.clearWalls()});var Ys=-1;function Si(){if(!$t||!zs)return;let s=W(300)*1.5,e=W(301)*1,t=W(302)*2;$t.style.transform=`translate(${s}px, ${e}px) rotate(${t}deg)`;let n=W(310)*1.5,o=W(311)*1,i=W(312)*2;zs.style.transform=`translate(${n}px, ${o}px) rotate(${i}deg)`}function en(){let s=H();s!==Ys&&(Ys=s,Si()),requestAnimationFrame(en)}en();z.update();Qs();document.body.classList.add("js-ready");
